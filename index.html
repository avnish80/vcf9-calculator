<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VCF 9 Fleet Planning Sizer (ESA) | vmtechie.blog</title>
<style>
:root{
  --fs:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,'Helvetica Neue',Arial,sans-serif;
  --fm:'Cascadia Code','Fira Code','Consolas','SF Mono','Menlo','Courier New',monospace;
  --bg:#0a0f1a;--bg2:#0d1526;--bg3:#111827;
  --bd:#2a3f62;--bd2:rgba(42,63,98,.6);--bd3:#1e2d45;
  --t:#f1f5f9;--t2:#e2e8f0;--t3:#94a3b8;--t4:#64748b;
  --blue:#2563eb;--blue2:#3b82f6;
  --sky:#38bdf8;--sky2:#7dd3fc;
  --em:#10b981;--em2:#6ee7b7;
  --am:#f59e0b;--am2:#fde68a;
  --red:#ef4444;--red2:#fca5a5;
  --or:#f97316;--or2:#fdba74;
  --r:14px;--r2:10px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--fs);background:var(--bg);color:var(--t);padding:1rem;line-height:1.5}
.mono{font-family:var(--fm)}
/* Layout */
.wrap{max-width:1900px;margin:0 auto;display:flex;flex-direction:column;gap:1rem}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
.g2{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
.g6{display:grid;grid-template-columns:repeat(6,1fr);gap:.75rem}
.g7{display:grid;grid-template-columns:repeat(7,1fr);gap:.75rem}
.cs2{grid-column:span 2}.cs3{grid-column:span 3}.cs4{grid-column:span 4}
@media(max-width:1100px){.g4{grid-template-columns:repeat(2,1fr)}.g6,.g7{grid-template-columns:repeat(3,1fr)}}
@media(max-width:680px){.g4,.g2,.g3,.g6,.g7{grid-template-columns:1fr}.cs2,.cs3,.cs4{grid-column:span 1}body{padding:.5rem}}
/* Card */
.card{background:var(--bg3);border:2px solid var(--bd);border-radius:var(--r);box-shadow:0 6px 24px rgba(0,0,0,.4)}
.card-hero{background:linear-gradient(135deg,#0f2060,#060d1f);border-color:rgba(30,58,138,.6)}
.cp{padding:1rem}
/* Flex */
.rb{display:flex;align-items:center;justify-content:space-between;gap:.5rem;flex-wrap:wrap}
.row{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
.col{display:flex;flex-direction:column}
/* Typography */
.lbl{font-size:10px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--t4);margin-bottom:5px;display:block}
.lbl.sky{color:var(--sky2)}.lbl.blue{color:#60a5fa}.lbl.em{color:#34d399}.lbl.or{color:var(--or2)}
.tiny{font-size:11px;color:var(--t4);line-height:1.4}
.mh{font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--t2)}
.bn{font-size:36px;font-weight:700;letter-spacing:-.04em;line-height:1;font-family:var(--fm)}
.bn2{font-size:26px;font-weight:700;letter-spacing:-.04em;line-height:1;font-family:var(--fm)}
.st{font-size:11px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;font-style:italic}
/* Inputs */
.inp,.sel{background:var(--bg2);color:var(--t2);border:1px solid #2a3a56;border-radius:var(--r2);padding:5px 8px;font-weight:700;font-size:12px;width:100%;height:32px;outline:none;font-family:var(--fm);transition:border-color .15s,box-shadow .15s;-webkit-appearance:none}
.inp:focus,.sel:focus{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(59,130,246,.2)}
/* Buttons */
.btn{background:var(--blue);border:1px solid rgba(255,255,255,.1);color:#fff;font-weight:700;letter-spacing:.1em;text-transform:uppercase;font-size:11px;padding:7px 12px;border-radius:999px;cursor:pointer;font-family:var(--fs);white-space:nowrap;transition:.15s}
.btn:hover{background:var(--blue2);transform:translateY(-1px)}
.btn2{background:rgba(148,163,184,.06);border:1px solid rgba(148,163,184,.2);color:#cbd5e1;font-weight:700;letter-spacing:.1em;text-transform:uppercase;font-size:11px;padding:7px 12px;border-radius:999px;cursor:pointer;font-family:var(--fs);white-space:nowrap;transition:.15s}
.btn2:hover{background:rgba(148,163,184,.12)}
.btn2.danger{border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.08);color:var(--red2)}
/* Badges */
.chip{font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;padding:4px 9px;border-radius:999px;border:1px solid rgba(148,163,184,.2);background:rgba(2,6,23,.5);color:var(--t3)}
.badge{display:inline-flex;align-items:center;justify-content:center;padding:4px 9px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;border:1px solid rgba(148,163,184,.2);background:rgba(2,6,23,.3);color:var(--t2);white-space:nowrap}
.b-ok{border-color:rgba(52,211,153,.4);background:rgba(16,185,129,.1);color:var(--em2)}
.b-warn{border-color:rgba(251,191,36,.4);background:rgba(251,191,36,.1);color:var(--am2)}
.b-hot{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.1);color:var(--red2)}
.b-over{border-color:rgba(147,197,253,.35);background:rgba(59,130,246,.1);color:#93c5fd}
.t-on{background:rgba(56,189,248,.12);border-color:rgba(56,189,248,.4);color:var(--sky2)}
.t-off{background:rgba(51,65,85,.15);border-color:rgba(51,65,85,.4);color:#475569}
/* Tooltip */
.tip{display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:999px;border:1px solid #2a3a56;background:rgba(2,6,23,.4);color:var(--t4);font-size:10px;font-weight:700;cursor:help;margin-left:4px;vertical-align:middle}
/* Sub-panels */
.sp{background:rgba(2,6,23,.3);border:1px solid var(--bd);border-radius:var(--r2);padding:10px}
.sp-blue{background:rgba(14,30,60,.4);border:1px solid rgba(56,189,248,.35);border-radius:var(--r2);padding:10px}
.sp-em{background:rgba(4,47,46,.3);border:1px solid rgba(52,211,153,.35);border-radius:var(--r2);padding:10px}
/* Warnings */
.wb{display:none;border-radius:var(--r2);padding:7px 10px;font-size:11px;font-weight:700;margin-top:6px}
.wb.show{display:block}
.wb.red{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.4);color:var(--red2)}
.wb.amber{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);color:var(--am2)}
/* Bar */
.bw{height:7px;border-radius:999px;border:1px solid var(--bd);background:rgba(2,6,23,.5);overflow:hidden;margin-top:6px}
.bf{height:100%;width:0%;background:linear-gradient(90deg,#2563eb,#10b981);border-radius:999px;transition:width .3s}
.bf.tight{background:linear-gradient(90deg,#f59e0b,#d97706)}
.bf.hot{background:linear-gradient(90deg,#ef4444,#f97316)}
/* Host tile */
.hn{width:36px;height:40px;border-radius:9px;border:1px solid var(--bd);background:rgba(2,6,23,.5);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px}
.hviz{display:flex;gap:3px;flex-wrap:wrap;max-width:380px}
/* Tables */
table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
th{position:sticky;top:0;z-index:10;background:rgba(17,24,39,.97);backdrop-filter:blur(6px);border-bottom:3px solid var(--bd);border-right:1px solid var(--bd);font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#4b6080;padding:9px 8px}
td{border-bottom:1px solid var(--bd);border-right:1px solid rgba(30,45,69,.5);padding:7px 8px;font-size:11px;color:var(--t3);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
th:last-child,td:last-child{border-right:none}
/* VM Stack richer table */
.vmstk{table-layout:auto}
.vmstk th{padding:11px 10px;font-size:11px;letter-spacing:.1em;background:rgba(10,20,50,.95);color:#5b7aa8;border-bottom:3px solid var(--bd)}
.vmstk td{padding:10px 10px;font-size:12px;white-space:normal;vertical-align:middle;border-bottom:1px solid var(--bd)}
.vmstk tbody tr:nth-child(even) td{background:rgba(30,45,69,.12)}
.vmstk tbody tr:hover td{background:rgba(59,130,246,.08);transition:background .15s}
.vmstk .comp-name{font-size:12px;font-weight:700;color:#e2e8f0;letter-spacing:-.01em;display:block;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.vmstk .num-val{font-family:var(--fm);font-weight:700;font-size:13px;text-align:center}
.vmstk tfoot td{background:rgba(37,99,235,.1);border-top:2px solid rgba(59,130,246,.4);color:var(--t2);font-weight:700;font-size:12px;padding:10px 14px}
.row-off{opacity:.3;filter:grayscale(1);font-style:italic}
.atbl{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed;border-radius:var(--r2);border:2px solid var(--bd);background:rgba(2,6,23,.2);overflow:hidden}
.atbl th{position:static;background:rgba(10,15,26,.7);border-right:1px solid var(--bd);border-bottom:2px solid var(--bd);padding:8px 10px;font-size:10px}
.atbl td{border-right:1px solid var(--bd2);border-bottom:1px solid var(--bd2);padding:8px 10px;vertical-align:top;white-space:normal}
.atbl td:last-child,.atbl th:last-child{border-right:none}
/* Limiter colours */
.lc{color:#60a5fa;font-weight:700}.lm{color:#fbbf24;font-weight:700}.ls{color:#fb7185;font-weight:700}
/* Stat rows */
.sr{display:flex;justify-content:space-between;margin-top:6px;font-size:11px}
.sr:first-child{margin-top:0}
.sk{color:var(--t3)}.sv{color:var(--t2);font-weight:700;font-family:var(--fm)}
.sv.sky{color:var(--sky2)}.sv.em{color:var(--em2)}.sv.am{color:var(--am2)}.sv.w{color:#fff}.sv.or{color:var(--or2)}
/* BOM rows */
.br{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--bd2);font-size:11px}
.br:last-child{border-bottom:none}
.bk{color:var(--t4);font-weight:700}.bv{color:var(--t2);font-weight:700;font-family:var(--fm)}
.bv.hi{color:var(--sky2)}.bv.sv{color:var(--em2)}.bv.wv{color:var(--am2)}
/* Tier panel */
.tier-panel{background:linear-gradient(135deg,rgba(14,30,60,.7),rgba(6,15,35,.9));border:2px solid rgba(56,189,248,.4);border-radius:var(--r2);padding:12px;position:relative;overflow:hidden;margin-top:8px}
.tier-panel::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(56,189,248,.6),rgba(99,102,241,.5),transparent)}
.tier-panel.off{display:none}
/* WLD accent */
.wld-card{border-top:4px solid rgba(59,130,246,.85)}
/* Divider */
hr{border:none;border-top:1px solid var(--bd2);margin:.75rem 0}
/* Overflow */
.ox{overflow-x:auto}
/* Ana box */
.ab{background:rgba(2,6,23,.25);border:1px solid var(--bd);border-radius:var(--r2);padding:10px}
/* Policy info */
.pi{padding:8px 12px;border-radius:var(--r2);border:1px solid rgba(59,130,246,.4);background:rgba(59,130,246,.07);font-size:11px;color:rgba(147,197,253,.8);line-height:1.6;margin-top:.75rem}
/* Scrollbar */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:#2a3a56;border-radius:3px}
input[type=checkbox]{accent-color:var(--blue2);transform:scale(1.1);cursor:pointer}
/* vSAN table */
.vtbl{width:100%;border-collapse:collapse;font-size:11px}
.vtbl th{background:rgba(10,15,26,.8);color:#4b6080;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:6px 8px;border:1px solid var(--bd);text-align:left}
.vtbl td{padding:5px 8px;border:1px solid var(--bd2);color:var(--t3)}
.vtbl tr:hover td{background:rgba(30,45,69,.2)}
.vtbl .hl{color:var(--t2);font-weight:700}
/* Section header with inline collapse */
.sec-hdr{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none;padding:.75rem 1rem;border-radius:var(--r)}
.sec-hdr:hover{background:rgba(30,45,69,.2)}
/* Compact host spec grid */
.hspec{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem}
@media(max-width:900px){.hspec{grid-template-columns:repeat(2,1fr)}}


/* â”€â”€ WLD identity â”€â”€ */
.wld-card{border-left:5px solid #3b82f6;border-top:none!important;transition:border-color .3s,background .3s}
.env-btn{background:rgba(148,163,184,.06);border:1px solid rgba(148,163,184,.2);color:#94a3b8;font-size:11px;font-weight:700;padding:4px 9px;border-radius:999px;cursor:pointer;transition:all .15s;font-family:var(--fs);white-space:nowrap}
.env-btn:hover{background:rgba(148,163,184,.14)}
.env-selector{display:flex;gap:5px;flex-wrap:wrap;margin-top:6px}
/* accent util bar */
.bf{background:linear-gradient(90deg,var(--wld-accent,#2563eb),#10b981)}
/* mgmt subtle */
.mgmt-card-subtle{border:1px solid rgba(249,115,22,.12)!important;background:transparent!important}
.mgmt-card-subtle .sec-hdr{border-bottom-color:rgba(249,115,22,.12)!important}
.mgmt-card-subtle .lbl.or{color:rgba(253,186,116,.6)!important}


/* â•â• HEADER HIERARCHY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Card title â€” top level (Management Domain, WLD name area) */
.card-title {
  font-size:15px;font-weight:800;letter-spacing:-.01em;
  text-transform:uppercase;line-height:1.1;
  display:flex;align-items:center;gap:8px;
}
.card-title::before {
  content:'';display:inline-block;width:4px;height:18px;
  border-radius:2px;flex-shrink:0;
}
.card-title.or::before  { background:rgba(253,186,116,.5); }
.card-title.sky::before { background:var(--sky2); }
.card-title.em::before  { background:var(--em2); }
.card-title.wld::before { background:var(--wld-hdr-col, #3b82f6); }

/* Sub-panel title â€” second level (Host Specification, Cluster Analysis, etc.) */
.panel-title {
  font-size:12px;font-weight:800;letter-spacing:.06em;
  text-transform:uppercase;line-height:1;
  display:flex;align-items:center;gap:6px;
  padding-bottom:7px;margin-bottom:8px;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.panel-title .pt-dot {
  width:6px;height:6px;border-radius:50%;flex-shrink:0;
}
.panel-title.or  { color:rgba(253,186,116,.85); }
.panel-title.or .pt-dot  { background:rgba(253,186,116,.6); }
.panel-title.blue{ color:#93c5fd; }
.panel-title.blue .pt-dot{ background:#60a5fa; }
.panel-title.em  { color:#6ee7b7; }
.panel-title.em .pt-dot  { background:var(--em2); }
.panel-title.sky { color:var(--sky2); }
.panel-title.sky .pt-dot { background:var(--sky2); }
.panel-title.wld { color:var(--wld-hdr-col, #3b82f6); }
.panel-title.wld .pt-dot { background:var(--wld-hdr-col, #3b82f6); }
.panel-title.wh  { color:#e2e8f0; }
.panel-title.wh .pt-dot  { background:#64748b; }

/* Section group label â€” third level ("Compute", "Memory", "ESA Storage") */
.lbl { color:#94a3b8; } /* brighten base from --t4 to --t3 */

/* Vmstk column headers â€” colour-coded numeric columns */
.vmstk th.th-vcpu { background:rgba(56,189,248,.08);color:#7dd3fc; }
.vmstk th.th-ram  { background:rgba(56,189,248,.08);color:#7dd3fc; }
.vmstk th.th-disk { background:rgba(16,185,129,.08);color:#6ee7b7; }

/* Collapsed summary badge */
.collapsed-summary {
  display:inline-flex;align-items:center;gap:6px;
  font-size:10px;font-weight:700;font-family:var(--fm);
  color:var(--t3);letter-spacing:.04em;
  background:rgba(2,6,23,.4);border:1px solid var(--bd);
  border-radius:999px;padding:3px 10px;
}
.collapsed-summary span { color:#e2e8f0; }


/* â”€â”€ Fleet health banner â”€â”€ */
.fleet-health{border-radius:var(--r2);padding:10px 16px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;transition:background .4s,border-color .4s;margin-bottom:.75rem}
.fleet-health.ok   {background:rgba(16,185,129,.08);border:1px solid rgba(52,211,153,.3);color:var(--em2)}
.fleet-health.warn {background:rgba(245,158,11,.08); border:1px solid rgba(245,158,11,.3); color:var(--am2)}
.fleet-health.crit {background:rgba(239,68,68,.08);  border:1px solid rgba(239,68,68,.35); color:var(--red2)}
.fleet-health .fh-left{display:flex;align-items:center;gap:8px}
.fleet-health .fh-icon{font-size:16px}
.fleet-health .fh-stats{display:flex;gap:12px;font-size:10px;font-weight:700;letter-spacing:.04em;color:var(--t3)}
.fleet-health .fh-stats span{color:#e2e8f0}

/* â”€â”€ Host delta indicator â”€â”€ */
@keyframes deltaFade{0%{opacity:1;transform:translateY(0)}70%{opacity:1;transform:translateY(-6px)}100%{opacity:0;transform:translateY(-12px)}}
.delta-badge{position:absolute;right:-8px;top:-10px;font-size:10px;font-weight:900;font-family:var(--fm);border-radius:999px;padding:2px 6px;pointer-events:none;animation:deltaFade 1.8s ease-out forwards;white-space:nowrap;z-index:20}
.delta-badge.up  {background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4);color:var(--red2)}
.delta-badge.down{background:rgba(52,211,153,.12);border:1px solid rgba(52,211,153,.3);color:var(--em2)}
.host-count-wrap{position:relative;display:inline-block}

/* â”€â”€ Empty state â”€â”€ */
.wld-empty{border:2px dashed rgba(59,130,246,.25);border-radius:var(--r);padding:36px;text-align:center;color:var(--t4);transition:border-color .2s,background .2s}
.wld-empty:hover{border-color:rgba(59,130,246,.5);background:rgba(59,130,246,.04)}
.wld-empty .em-icon{font-size:36px;margin-bottom:12px;opacity:.6}
.wld-empty .em-title{font-size:14px;font-weight:700;color:var(--t3);margin-bottom:6px;letter-spacing:.02em}
.wld-empty .em-sub{font-size:11px;line-height:1.6;margin-bottom:16px}
.wld-empty .em-kbd{font-family:var(--fm);font-size:10px;background:rgba(255,255,255,.06);border:1px solid var(--bd);border-radius:4px;padding:2px 6px;color:var(--t3)}

/* â”€â”€ Copy to clipboard â”€â”€ */
.copyable{cursor:pointer;position:relative;transition:color .15s}
.copyable:hover{color:#fff!important}
.copyable::after{content:'Click to copy';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.95);color:#e2e8f0;font-size:9px;font-weight:700;letter-spacing:.06em;padding:3px 7px;border-radius:4px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s;margin-bottom:4px;border:1px solid var(--bd)}
.copyable:hover::after{opacity:1}
.copy-flash{animation:copyFlash .6s ease-out}
@keyframes copyFlash{0%{color:#fff}50%{color:var(--em2)}100%{}}


/* â”€â”€ ESA waterfall explanation rows â”€â”€ */
.wf-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:10px}
.wf-table td{padding:4px 6px;vertical-align:top;line-height:1.4}
.wf-table tr{border-bottom:1px solid rgba(30,45,69,.5)}
.wf-table tr:last-child{border-bottom:none}
.wf-table .wf-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0;margin-top:2px}
.wf-table .wf-td-dot{width:16px;padding-right:4px}
.wf-table .wf-td-label{font-weight:700;color:var(--t2);width:35%;white-space:nowrap}
.wf-table .wf-td-val{font-family:var(--fm);font-weight:700;text-align:right;width:28%;white-space:nowrap;padding-right:8px}
.wf-table .wf-td-desc{color:var(--t4);font-size:9px;line-height:1.4}
.wf-table tr.wf-subtotal td{background:rgba(255,255,255,.02);border-top:1px solid rgba(255,255,255,.06)}
.wf-table tr.wf-result td{background:rgba(255,255,255,.03);border-top:2px solid rgba(255,255,255,.1)}
.wf-table tr.wf-result .wf-td-label{color:#e2e8f0;font-size:11px}
.wf-table tr.wf-result .wf-td-val{color:#fff;font-size:11px}


/* â”€â”€ External storage mode â”€â”€ */
.stg-mode-bar{display:flex;align-items:center;gap:6px;margin-bottom:.75rem;padding:6px 10px;border-radius:var(--r2);background:rgba(255,255,255,.03);border:1px solid var(--bd)}
.stg-mode-label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--t4);margin-right:4px;flex-shrink:0}
.stg-mode-btn{background:rgba(148,163,184,.06);border:1px solid rgba(148,163,184,.2);color:var(--t3);font-size:10px;font-weight:700;padding:4px 10px;border-radius:999px;cursor:pointer;transition:all .15s;font-family:var(--fs);white-space:nowrap;letter-spacing:.06em;text-transform:uppercase}
.stg-mode-btn.active-vsan{background:rgba(56,189,248,.12);border-color:var(--sky2);color:var(--sky2)}
.stg-mode-btn.active-ext{background:rgba(168,85,247,.12);border-color:#c084fc;color:#c084fc}
.ext-info-box{background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.25);border-radius:var(--r2);padding:10px 14px;margin-bottom:.75rem}
.ext-info-box .ei-title{font-size:11px;font-weight:800;color:#c084fc;letter-spacing:.06em;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.ext-info-box .ei-note{font-size:10px;color:rgba(216,180,254,.7);line-height:1.6;margin-bottom:10px}
.ext-info-box .ei-fields{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.ent-forfeit{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.3);border-radius:6px;padding:8px 12px;margin-top:8px;font-size:10px;line-height:1.6;color:rgba(253,230,138,.85)}
.ent-forfeit strong{color:#fcd34d;font-weight:800}
.ent-forfeit .ef-num{font-family:var(--fm);font-size:12px;font-weight:900;color:#fcd34d}
.lic-ext-warn{display:none;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:10px 14px;margin-top:.75rem;font-size:11px;line-height:1.6;color:rgba(253,230,138,.8)}
.lic-ext-warn strong{color:#fcd34d}
.lic-ext-warn .lew-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(245,158,11,.1)}
.lic-ext-warn .lew-row:last-child{border-bottom:none;margin-top:4px;padding-top:6px;font-weight:700;color:#fcd34d}
.lic-ext-warn .lew-val{font-family:var(--fm);font-weight:700;color:#fcd34d}
.ext-storage-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.3);color:#c084fc}


/* vSAN wrapper hide â€” works with display:contents */
.vsan-hidden > * { display:none !important; }

/* â”€â”€ HIDDEN (collapse fix) â”€â”€ */
.hidden{display:none!important}

/* â”€â”€ Animated number counter â”€â”€ */
.anim-num{transition:color .3s}
.anim-num.flash{color:#fff!important}

/* â”€â”€ Host tile animation â”€â”€ */
@keyframes hostSlideIn{from{opacity:0;transform:scale(.5) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes hostFadeOut{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.4)}}
.hn{width:36px;height:40px;border-radius:9px;border:1px solid var(--bd);background:rgba(2,6,23,.5);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;transition:border-color .2s,background .2s}
.hn.new-host{animation:hostSlideIn .35s cubic-bezier(.34,1.56,.64,1) both}
.hn:hover{border-color:var(--sky);background:rgba(56,189,248,.08);cursor:default}
.hn.mgmt-host:hover{border-color:var(--or2);background:rgba(249,115,22,.08)}

/* â”€â”€ Storage waterfall bar â”€â”€ */
.wf-bar-wrap{margin-top:8px;border-radius:8px;overflow:hidden;height:22px;display:flex;border:1px solid var(--bd)}
.wf-seg{height:100%;transition:width .5s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;letter-spacing:.08em;overflow:hidden;white-space:nowrap;min-width:0}
.wf-seg span{padding:0 4px;pointer-events:none}
.wf-vm{background:rgba(56,189,248,.35);color:var(--sky2)}
.wf-swap{background:rgba(99,102,241,.35);color:#a5b4fc}
.wf-pf{background:rgba(251,191,36,.3);color:var(--am2)}
.wf-free{background:rgba(52,211,153,.25);color:var(--em2)}
.wf-growth{background:rgba(249,115,22,.3);color:var(--or2)}

/* â”€â”€ Utilisation arc gauge â”€â”€ */
.gauge-wrap{display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 0}
.gauge-svg{overflow:visible}
.gauge-track{fill:none;stroke:rgba(30,45,69,.8);stroke-width:8;stroke-linecap:round}
.gauge-arc{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset .6s cubic-bezier(.4,0,.2,1),stroke .4s}
.gauge-pct{font-family:var(--fm);font-weight:900;font-size:18px;dominant-baseline:middle;text-anchor:middle;transition:fill .4s}
.gauge-lbl{font-size:8px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;text-anchor:middle;fill:var(--t4)}

/* â”€â”€ Fleet topology diagram â”€â”€ */
.topo-wrap{display:flex;align-items:center;gap:0;padding:12px 0;overflow-x:auto;min-height:90px}
.topo-domain{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:80px}
.topo-box{border-radius:10px;padding:6px 10px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;text-align:center;cursor:pointer;transition:transform .15s,box-shadow .15s;border:2px solid}
.topo-box:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.4)}
.topo-box.mgmt{background:rgba(249,115,22,.12);border-color:rgba(249,115,22,.5);color:var(--or2)}
.topo-box.wld{background:rgba(59,130,246,.1);border-color:rgba(59,130,246,.4);color:#93c5fd}
.topo-line{flex:1;height:2px;background:linear-gradient(90deg,rgba(249,115,22,.4),rgba(59,130,246,.4));min-width:20px;max-width:40px;align-self:center;margin-bottom:20px}
.topo-stat{font-size:9px;color:var(--t4);text-align:center;line-height:1.4}
.topo-stat strong{color:var(--t2);font-family:var(--fm)}

/* â”€â”€ Confetti â”€â”€ */
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(60px) rotate(720deg);opacity:0}}
.confetti-piece{position:absolute;width:7px;height:7px;border-radius:2px;animation:confettiFall .8s ease-out forwards;pointer-events:none}

/* â”€â”€ Tiering callout banner â”€â”€ */
.tier-callout{background:rgba(56,189,248,.07);border:1px solid rgba(56,189,248,.3);border-radius:var(--r2);padding:7px 10px;font-size:10px;color:rgba(125,211,252,.9);margin-bottom:8px;line-height:1.5}

/* â”€â”€ Input validation highlight â”€â”€ */
.inp.invalid{border-color:rgba(239,68,68,.7)!important;box-shadow:0 0 0 2px rgba(239,68,68,.15)!important}

@media print{.no-print{display:none!important}body{background:#fff!important;color:#000!important}
.card{box-shadow:none!important;border:1px solid #cbd5e1!important;background:#fff!important}
th{position:static!important;background:#f8fafc!important;color:#111!important}
td{color:#111!important}.atbl{border:1px solid #cbd5e1!important;background:#fff!important}}
</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<div class="g4">
  <div class="card card-hero cp" style="text-align:center">
    <a href="https://vmtechie.blog" target="_blank" style="font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:rgba(147,197,253,.55);font-weight:700;font-family:var(--fm);text-decoration:none;border-bottom:1px solid rgba(147,197,253,.2)">vmtechie.blog</a>
    <h1 style="margin-top:6px;font-size:1.6rem;font-style:italic;letter-spacing:-.02em;text-transform:uppercase;line-height:1;font-weight:700">VCF 9 <span style="color:#60a5fa">Fleet Sizer</span></h1>
    <div style="margin-top:6px;font-size:10px;color:rgba(147,197,253,.35);letter-spacing:.08em">ESA-only Â· Independent planning aid</div>
    <div style="margin-top:10px;font-size:10px;color:rgba(251,191,36,.8);font-weight:700;border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:6px 8px;background:rgba(251,191,36,.05)">âš  Validate with official Broadcom/VMware docs</div>
  </div>
  <div class="card cp" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
    <div class="lbl">Total Fleet Hosts</div>
    <div class="host-count-wrap"><div id="sum-hosts" class="bn copyable" style="color:#fff" onclick="copyVal(this)" title="Click to copy">--</div></div>
  </div>
  <div class="card cp" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
    <div class="lbl">Core Licenses</div>
    <div class="host-count-wrap"><div id="sum-cores" class="bn copyable" style="color:var(--sky2)" onclick="copyVal(this)" title="Click to copy">--</div></div>
  </div>
  <div class="card cp" style="display:flex;flex-direction:column;align-items:center;justify-content:center">
    <div class="lbl" id="sum-storage-lbl">Fleet Storage (TiB)</div>
    <div class="host-count-wrap"><div id="sum-storage" class="bn copyable" style="color:var(--em2)" onclick="copyVal(this)" title="Click to copy">--</div></div>
  </div>
</div>

<!-- LICENSE SUMMARY -->
<div class="card cp">
  <div class="rb">
    <div>
      <div class="st" style="color:#e2e8f0">Fleet License Summary</div>
      <div class="tiny" style="margin-top:3px">1 TiB per licensed core (planner model) Â· <a href="https://vmtechie.blog" target="_blank" style="color:inherit;opacity:.7;text-decoration:none">vmtechie.blog</a></div>
    </div>
    <div class="no-print" style="display:flex;gap:.5rem">
      <button class="btn2" onclick="resetDefaults()" title="Reset all inputs to default values">â†º Reset</button>
      <button class="btn" onclick="exportReport()" style="background:linear-gradient(135deg,#1d4ed8,#0ea5e9)">â¬‡ Export Report</button>
    </div>
  </div>
  <div class="g4" style="margin-top:.75rem">
    <div class="ab"><div class="lbl">Mgmt Cores</div><div id="lic-mgmt" class="bn2" style="color:var(--sky2)">--</div></div>
    <div class="ab"><div class="lbl">WLD Cores</div><div id="lic-wld" class="bn2" style="color:var(--sky2)">--</div></div>
    <div class="ab"><div class="lbl">Entitlement (TiB)</div><div id="lic-ent" class="bn2" style="color:var(--em2)">--</div></div>
    <div class="ab" style="border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.05)">
      <div class="lbl" style="color:var(--red2)">Add-on Required (TiB)</div>
      <div id="lic-addon" class="bn2" style="color:var(--red)">--</div>
    </div>
  </div>
  <div class="g2" style="margin-top:.75rem">
    <div class="sp mono" style="font-size:11px;line-height:1.8">
      <div class="sr"><span class="sk">Required Raw (TiB)</span><span id="lic-raw" class="sv em">--</span></div>
      <div class="sr"><span class="sk">Planning aid only â€” validate all designs with official Broadcom docs</span></div>
    </div>
    <div class="sp" style="font-size:11px;color:var(--t4);line-height:1.6">1 TB decimal = 1000 GB. All TiB figures use Ã—0.9095 conversion. DRR &gt; 2.0 is optimistic unless validated against actual workloads.</div>
  </div>
  <!-- External storage entitlement warning â€” shown only when any domain uses ext storage -->
  <div id="lic-ext-warn" class="lic-ext-warn">
    <div style="font-size:11px;font-weight:800;color:#fcd34d;margin-bottom:8px;letter-spacing:.04em">âš  External Storage â€” Entitlement Impact</div>
    <div style="font-size:10px;color:rgba(253,230,138,.7);margin-bottom:10px;line-height:1.6">VCF licenses include <strong style="color:#fcd34d">1 TiB vSAN raw storage per licensed core</strong>. Domains using external storage do not consume this entitlement â€” those cores still cost the same but the bundled storage value is forfeited. Budget for external array acquisition, licensing and support costs separately.</div>
    <div id="lic-ext-breakdown" style="font-size:11px"></div>
    <div class="lew-row" style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(245,158,11,.2);font-weight:800;color:#fcd34d;display:flex;justify-content:space-between">
      <span>Total forfeited entitlement</span>
      <span id="lic-ext-total" style="font-family:var(--fm);font-size:13px">-- TiB</span>
    </div>
  </div>
</div>



<!-- STORAGE MODEL REFERENCE CARD -->
<div class="card cp" id="stg-ref-card">
  <!-- Header with collapse -->
  <div class="rb" style="cursor:pointer" onclick="toggleSection('stg-ref-body')">
    <div>
      <div class="st" style="color:#e2e8f0;display:flex;align-items:center;gap:10px">
        ðŸ—„ Storage Model Reference
        <span style="display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:999px;font-size:10px;font-weight:800;letter-spacing:.08em;background:linear-gradient(135deg,rgba(16,185,129,.15),rgba(56,189,248,.1));border:1px solid rgba(16,185,129,.4);color:#34d399">
          âœ¦ VCF 9 Â· KB 416270
        </span>
      </div>
      <div class="tiny" style="margin-top:4px">Supporting all Principal Storage Options in VMware Cloud Foundation 9 Â· click to expand</div>
    </div>
    <svg id="stg-ref-body-chev" width="14" height="14" viewBox="0 0 24 24" style="color:var(--t3);flex-shrink:0"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
  </div>

  <div id="stg-ref-body" style="display:none;margin-top:1rem">

    <!-- Key insight callout -->
    <div style="background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(56,189,248,.06));border:1px solid rgba(16,185,129,.25);border-radius:10px;padding:14px 18px;margin-bottom:1.25rem">
      <div style="font-size:11px;font-weight:800;color:#34d399;letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px">âœ¦ VCF 9 â€” All Principal Storage Options Supported</div>
      <div style="font-size:11px;color:rgba(167,243,208,.85);line-height:1.8">
        VCF 9 supports a variety of storage types as <strong style="color:#6ee7b7">principal storage</strong> across management and workload domains.
        Standard greenfield VCF workflows cover <strong style="color:#6ee7b7">vSAN ESA, vSAN OSA, Fibre Channel and NFS v3</strong>.
        Additional types â€” <strong style="color:#6ee7b7">iSCSI, NFS v4.1, FCoE and NVMe over Fabrics (FC, TCP, RDMA)</strong> â€” can also be used
        as principal storage via the <strong style="color:#6ee7b7">Converge workflow</strong>, where an existing vSphere environment with
        pre-configured storage is imported into VCF 9. This sizer models the external storage path
        (host count driven by compute &amp; memory) and surfaces the <strong style="color:#fcd34d">vSAN entitlement forfeited</strong> per domain.
      </div>
    </div>

    <!-- Greenfield vs Converge -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1.25rem">

      <div style="background:rgba(16,185,129,.05);border:1px solid rgba(16,185,129,.2);border-radius:8px;padding:12px 14px">
        <div style="font-size:10px;font-weight:800;color:#34d399;letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px">ðŸŸ¢ Greenfield VCF Workflows</div>
        <div style="font-size:10px;color:var(--t4);margin-bottom:8px;line-height:1.5">Configured during domain/cluster creation. Fully automated by VCF Operations â€” deploy, scale, LCM, patch, upgrade.</div>
        <ul style="font-size:10px;color:rgba(167,243,208,.8);line-height:1.9;list-style:none;padding:0;margin:0">
          <li><span style="color:#10b981;font-weight:800">âœ“</span> vSAN ESA â€” NVMe only, single-tier</li>
          <li><span style="color:#10b981;font-weight:800">âœ“</span> vSAN OSA â€” SATA, SAS, NVMe</li>
          <li><span style="color:#10b981;font-weight:800">âœ“</span> Fibre Channel (FC)</li>
          <li><span style="color:#10b981;font-weight:800">âœ“</span> NFS v3</li>
        </ul>
      </div>

      <div style="background:rgba(56,189,248,.05);border:1px solid rgba(56,189,248,.2);border-radius:8px;padding:12px 14px">
        <div style="font-size:10px;font-weight:800;color:var(--sky2);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px">ðŸ”„ Via Converge Workflow (KB 416270)</div>
        <div style="font-size:10px;color:var(--t4);margin-bottom:8px;line-height:1.5">Pre-configure storage on ESXi 9 hosts, deploy vCenter, then import into VCF 9 using Converge or Import vCenter workflow.</div>
        <ul style="font-size:10px;color:rgba(186,230,253,.8);line-height:1.9;list-style:none;padding:0;margin:0">
          <li><span style="color:var(--sky2);font-weight:800">âœ“</span> iSCSI</li>
          <li><span style="color:var(--sky2);font-weight:800">âœ“</span> NFS v4.1</li>
          <li><span style="color:var(--sky2);font-weight:800">âœ“</span> FCoE</li>
          <li><span style="color:var(--sky2);font-weight:800">âœ“</span> NVMe over Fabrics (FC, TCP, RDMA)</li>
        </ul>
      </div>

    </div>

    <!-- Converge deployment steps -->
    <div style="margin-bottom:1.25rem">
      <div style="font-size:10px;font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--t4);margin-bottom:10px">Converge Deployment Method â€” Step by Step</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">

        <div style="background:rgba(249,115,22,.04);border:1px solid rgba(249,115,22,.15);border-radius:8px;padding:12px 14px">
          <div style="font-size:10px;font-weight:800;color:rgba(253,186,116,.9);margin-bottom:10px;letter-spacing:.04em">âš™ Management Domain</div>
          <ol style="font-size:10px;color:rgba(253,186,116,.7);line-height:1.9;padding-left:16px;margin:0">
            <li>Deploy ESXi 9 on selected hosts</li>
            <li>Configure target datastore (iSCSI / NFS v4.1 / FCoE / NVMe-oF) on one host</li>
            <li>Deploy vCenter 9 appliance on that host</li>
            <li>Create a vSphere cluster with all hosts using the pre-configured datastore</li>
            <li>Deploy VCF Installer â†’ run <strong style="color:#fb923c">Converge workflow</strong> to convert to VCF 9</li>
          </ol>
          <div style="margin-top:8px;font-size:9px;color:rgba(253,186,116,.4);line-height:1.5">Pre-configured datastore becomes principal storage for the management domain.</div>
        </div>

        <div style="background:rgba(59,130,246,.04);border:1px solid rgba(59,130,246,.15);border-radius:8px;padding:12px 14px">
          <div style="font-size:10px;font-weight:800;color:rgba(147,197,253,.9);margin-bottom:10px;letter-spacing:.04em">ðŸ’¾ Workload Domain</div>
          <ol style="font-size:10px;color:rgba(147,197,253,.7);line-height:1.9;padding-left:16px;margin:0">
            <li>Repeat management steps 1â€“4 on new hosts</li>
            <li>In VCF Operations â†’ <strong style="color:#93c5fd">Add Workload Domain â†’ Import a vCenter</strong></li>
            <li>Select the newly created vCenter</li>
            <li>Repeat as needed for additional workload domains</li>
          </ol>
          <div style="margin-top:8px;font-size:9px;color:rgba(147,197,253,.4);line-height:1.5">Pre-configured datastore becomes principal storage for the workload domain.</div>
        </div>

      </div>
    </div>

    <!-- Day 2 operations warning -->
    <div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.25);border-radius:8px;padding:12px 14px;margin-bottom:1.25rem">
      <div style="font-size:10px;font-weight:800;color:#fbbf24;letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px">âš  Day 2 Operations â€” Important Constraint</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div>
          <div style="font-size:10px;color:rgba(253,230,138,.8);line-height:1.7;margin-bottom:6px">
            Hosts and clusters provisioned via Converge are <strong style="color:#fcd34d">fully lifecycle managed</strong> by VCF Operations (LCM, patching, upgrades).
          </div>
          <div style="font-size:10px;color:rgba(253,230,138,.65);line-height:1.7">
            For other Day 2 operations (host commissioning, adding/removing hosts or clusters) â€” perform the operation in <strong style="color:#fcd34d">vCenter first</strong>, then run <strong style="color:#fcd34d">Sync Inventory</strong> in VCF Operations.
          </div>
        </div>
        <div style="background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:6px;padding:10px 12px">
          <div style="font-size:10px;font-weight:800;color:#fca5a5;margin-bottom:6px">ðŸš« If Sync Inventory is skipped:</div>
          <div style="font-size:10px;color:rgba(252,165,165,.7);line-height:1.6">Lifecycle management in VCF Operations will be <strong style="color:#f87171">blocked</strong> for those hosts and clusters until inventory is synchronised.</div>
          <div style="margin-top:8px;font-size:9px;color:rgba(252,165,165,.4)">See: Managing Configuration Drift â€” Broadcom docs</div>
        </div>
      </div>
    </div>

    <!-- Principal / Supplemental support table -->
    <div style="margin-bottom:1.25rem">
      <div style="font-size:10px;font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--t4);margin-bottom:10px">Principal &amp; Supplemental Storage â€” Domain Support Matrix</div>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:11px">
          <thead>
            <tr style="background:rgba(255,255,255,.04)">
              <th style="text-align:left;padding:8px 12px;color:var(--t3);font-weight:700;border-bottom:1px solid var(--bd);white-space:nowrap">Storage Model</th>
              <th style="text-align:center;padding:8px 12px;color:rgba(253,186,116,.8);font-weight:700;border-bottom:1px solid var(--bd);white-space:nowrap">Mgmt â€” Default Cluster</th>
              <th style="text-align:center;padding:8px 12px;color:rgba(253,186,116,.8);font-weight:700;border-bottom:1px solid var(--bd);white-space:nowrap">Mgmt â€” Additional Clusters</th>
              <th style="text-align:center;padding:8px 12px;color:var(--sky2);font-weight:700;border-bottom:1px solid var(--bd);white-space:nowrap">VI Workload Domain</th>
              <th style="text-align:center;padding:8px 12px;color:var(--t4);font-weight:700;border-bottom:1px solid var(--bd);white-space:nowrap">Method</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04)">
              <td style="padding:7px 12px;color:#e2e8f0;font-weight:700">vSAN ESA</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#34d399;font-size:9px;font-weight:700">ðŸŸ¢ Greenfield</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.015)">
              <td style="padding:7px 12px;color:#e2e8f0;font-weight:700">vSAN OSA</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#34d399;font-size:9px;font-weight:700">ðŸŸ¢ Greenfield</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04)">
              <td style="padding:7px 12px;color:#e2e8f0;font-weight:700">Storage Cluster (disaggregated vSAN)</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#374151">â€”</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#34d399;font-size:9px;font-weight:700">ðŸŸ¢ Greenfield</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.015)">
              <td style="padding:7px 12px;color:#e2e8f0;font-weight:700">Compute-Only Cluster</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#374151">â€”</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#34d399;font-size:9px;font-weight:700">ðŸŸ¢ Greenfield</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04)">
              <td style="padding:7px 12px;color:#e2e8f0;font-weight:700">Fibre Channel (FC)</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span> <span style="color:var(--t4);font-size:9px">+ Supp</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span> <span style="color:var(--t4);font-size:9px">+ Supp</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#34d399;font-size:9px;font-weight:700">ðŸŸ¢ Greenfield</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.015)">
              <td style="padding:7px 12px;color:#e2e8f0;font-weight:700">NFS v3</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span> <span style="color:var(--t4);font-size:9px">+ Supp</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#10b981;font-weight:800">Principal</span> <span style="color:var(--t4);font-size:9px">+ Supp</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:#34d399;font-size:9px;font-weight:700">ðŸŸ¢ Greenfield</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04)">
              <td style="padding:7px 12px;color:#93c5fd;font-weight:700">iSCSI</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-size:9px;font-weight:700">ðŸ”„ Converge</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.015)">
              <td style="padding:7px 12px;color:#93c5fd;font-weight:700">NFS v4.1</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-size:9px;font-weight:700">ðŸ”„ Converge</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04)">
              <td style="padding:7px 12px;color:#93c5fd;font-weight:700">FCoE</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-size:9px;font-weight:700">ðŸ”„ Converge</span></td>
            </tr>
            <tr style="border-bottom:1px solid rgba(255,255,255,.04);background:rgba(255,255,255,.015)">
              <td style="padding:7px 12px;color:#93c5fd;font-weight:700">NVMe/FC Â· NVMe/TCP Â· NVMe/RDMA</td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-weight:800">Principal</span><span style="color:var(--t4);font-size:9px">*</span></td>
              <td style="text-align:center;padding:7px 12px"><span style="color:var(--sky2);font-size:9px;font-weight:700">ðŸ”„ Converge</span></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top:8px;font-size:10px;color:var(--t4);line-height:1.6">
        <span style="color:var(--sky2)">*</span> Via Converge workflow â€” pre-configure datastore on ESXi 9, deploy vCenter, then import into VCF 9.
        Day 2 non-LCM operations must be performed in vCenter first, followed by <strong style="color:#cbd5e1">Sync Inventory</strong> in VCF Operations.
      </div>
    </div>

    <div style="margin-top:.75rem;font-size:10px;color:var(--t4);line-height:1.6;border-top:1px solid var(--bd2);padding-top:.75rem">
      Source: Broadcom KB Article 416270 â€” <em>Supporting all Principal Storage Options in VMware Cloud Foundation 9</em> Â·
      <a href="https://knowledge.broadcom.com/external/article/416270" target="_blank" style="color:var(--sky2);text-decoration:none">knowledge.broadcom.com/external/article/416270</a> Â·
      Validate all storage model decisions against the current Broadcom VCF design guide before procurement.
    </div>

  </div>
</div>

<!-- FLEET TOPOLOGY DIAGRAM -->
<div class="card cp" id="topo-card">
  <div class="rb" style="margin-bottom:8px">
    <div>
      <div class="st" style="color:#e2e8f0">Fleet Topology</div>
      <div class="tiny" style="margin-top:3px">Live architecture overview â€” click a domain to scroll to it</div>
    </div>
  </div>
  <div id="topo-wrap" class="topo-wrap"></div>
</div>

<!-- FLEET HEALTH BANNER -->
<div id="fleet-health-banner" class="fleet-health ok">
  <div class="fh-left">
    <span class="fh-icon">âœ“</span>
    <span id="fh-message">Calculating fleet healthâ€¦</span>
  </div>
  <div class="fh-stats" id="fh-stats"></div>
</div>

<!-- MANAGEMENT CLUSTER (unified card) -->
<div class="card mgmt-card-subtle" style="padding:0;overflow:hidden">

  <!-- Card header with collapse -->
  <div class="sec-hdr" onclick="toggleSection('mgmt-unified')" style="padding:.75rem 1rem;border-bottom:1px solid rgba(249,115,22,.12)">
    <div>
      <div class="card-title or" style="color:rgba(253,186,116,.9)">âš™ Management Domain</div>
      <div class="tiny" style="margin-top:4px;margin-left:12px">Host Profile Â· VM Stack Â· Cluster Analysis Â· WLD clusters can override spec individually</div>
    </div>
    <div class="row" style="gap:.75rem">
      <div id="m-summary-badge" class="collapsed-summary" style="display:none">
        <span id="m-badge-hosts">--</span> hosts Â·
        <span id="m-badge-cores">--</span> cores Â·
        <span id="m-badge-tib">--</span> TiB
      </div>
      <div id="m-visualizer" class="hviz"></div>
      <svg id="mgmt-unified-chev" width="14" height="14" viewBox="0 0 24 24" style="color:var(--or2)"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
    </div>
  </div>

  <div id="mgmt-unified" data-open="true">

    <!-- â”€â”€ ROW 1: Host Spec (left) + Policy+Planning (right) â”€â”€ -->
    <div class="g2" style="gap:0;border-bottom:1px solid rgba(249,115,22,.1)">

      <!-- LEFT: Host Specification -->
      <div class="cp" style="border-right:1px solid rgba(249,115,22,.1)">
        <div class="panel-title or"><span class="pt-dot"></span>Host Specification</div>
        <div id="m-policy-warn" class="wb red" style="margin-bottom:.5rem"></div>
        <!-- Storage Mode Toggle -->
        <div class="stg-mode-bar" style="border-color:rgba(249,115,22,.2);background:rgba(249,115,22,.04)">
          <span class="stg-mode-label">Storage</span>
          <button id="m-stg-vsan" class="stg-mode-btn active-vsan" onclick="setMgmtStorageMode('vsan')">ðŸ—„ vSAN ESA</button>
          <button id="m-stg-ext"  class="stg-mode-btn" onclick="setMgmtStorageMode('ext')">ðŸ”Œ External Array</button>
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem">
          <div><label class="lbl">CPUs/Host</label><input type="number" id="m-cpuQty" value="2" min="1" class="inp" oninput="debouncedRecalc()"></div>
          <div><label class="lbl">Cores/CPU</label><input type="number" id="m-coresPerCpu" value="16" min="1" class="inp" oninput="debouncedRecalc()"></div>
          <div><label class="lbl">RAM (GB)</label><input type="number" id="m-ram" value="1024" min="64" class="inp" oninput="debouncedRecalc()"></div>
          <div id="m-nvme-qty-wrap"><label class="lbl">NVMe Qty</label><input type="number" id="m-nvme-qty" value="6" min="0" class="inp" oninput="debouncedRecalc()"></div>
          <div id="m-nvme-size-wrap"><label class="lbl">NVMe Size (TB)</label><input type="number" id="m-nvme-size" value="7.68" step="0.01" min="0" class="inp" oninput="debouncedRecalc()"></div>
          <div><label class="lbl">Min Hosts</label>
            <select id="m-min-hosts" class="sel" onchange="recalculate()">
              <option value="1">1</option><option value="3">3</option><option value="4" selected>4 (Rec)</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
            </select>
          </div>
        </div>
        <!-- External storage info box -->
        <div id="m-ext-box" class="ext-info-box" style="display:none;margin-top:.75rem">
          <div class="ei-title">ðŸ”Œ External Storage Array</div>
          <div class="ei-note">Management host count driven by compute &amp; memory only â€” VM Stack demand. Storage sized by your external array vendor.</div>
          <div class="ent-forfeit">
            âš  <strong>Entitlement forfeited:</strong> VCF includes <strong>1 TiB vSAN raw per licensed core</strong> â€” this is unused when storage is external. Your <span id="m-ext-cores-display" class="ef-num">--</span> management cores represent <span id="m-ext-ent-display" class="ef-num">--</span> TiB of storage entitlement that will not offset external array costs. Budget for array licensing, support &amp; capacity separately.
          </div>
          <div class="ei-fields">
            <div><label class="lbl">Array / Vendor</label><input type="text" id="m-ext-vendor" value="" placeholder="e.g. NetApp ONTAP" class="inp" style="font-size:11px" oninput="debouncedRecalc()"></div>
            <div><label class="lbl">Estimated Capacity (TiB)</label><input type="number" id="m-ext-tib" value="" placeholder="0" min="0" class="inp" oninput="debouncedRecalc()"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Policy + Planning -->
      <div class="cp">
        <div class="panel-title blue"><span class="pt-dot"></span>Policy + Planning</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(115px,1fr));gap:.6rem;align-items:end">
          <div><label class="lbl blue">CPU Sub</label>
            <select id="m-cpu-sub" class="sel" onchange="recalculate()">
              <option value="1">1:1</option><option value="2" selected>2:1</option><option value="4">4:1</option><option value="8">8:1</option>
            </select>
          </div>
          <div><label class="lbl blue">Mem Sub</label>
            <select id="m-ram-sub" class="sel" onchange="recalculate()">
              <option value="1" selected>1:1</option><option value="2">2:1</option><option value="4">4:1</option><option value="8">8:1</option>
            </select>
          </div>
          <div><label class="lbl">Compute Reserve %</label>
            <select id="m-reserve" class="sel" onchange="recalculate()">
              <option value="15">15%</option><option value="20">20%</option><option value="25">25%</option><option value="30" selected>30%</option>
            </select>
          </div>
          <div id="m-vsan-policy-fields" style="display:contents">
          <div><label class="lbl em">RAID Type</label>
            <select id="m-raid" class="sel" onchange="syncRaidFttOptions('m');recalculate()">
              <option value="none">RAID-0 (No Redundancy)</option>
              <option value="mirror">Mirror (RAID-1)</option>
              <option value="raid5" selected>RAID-5 (Erasure Coding)</option>
              <option value="raid6">RAID-6 (Erasure Coding)</option>
            </select>
          </div>
          <div><label class="lbl em">FTT<span class="tip" title="Failures To Tolerate. Options are constrained by RAID type.">i</span></label>
            <select id="m-ftt" class="sel" onchange="syncRaidFttOptions('m');recalculate()">
              <option value="0">FTT=0</option>
              <option value="1" selected>FTT=1</option>
              <option value="2">FTT=2</option>
              <option value="3">FTT=3</option>
            </select>
          </div>
          <div id="m-r5stripe-wrap"><label class="lbl em">RAID-5 Stripe<span class="tip" title="2+1: min 3 hosts, 150% of VM size (1.5Ã— PF). 4+1: min 6 hosts, 125% of VM size (1.25Ã— PF).">i</span></label>
            <select id="m-r5stripe" class="sel" onchange="syncRaidFttOptions('m');recalculate()">
              <option value="4p1">4+1 â€” 6 hosts, 1.25Ã—</option>
              <option value="2p1" selected>2+1 â€” 3 hosts, 1.5Ã—</option>
            </select>
          </div>
          <div><label class="lbl">vSAN Free %</label><input type="number" id="m-free" value="30" min="0" max="50" class="inp" oninput="debouncedRecalc()"></div>
          <div><label class="lbl">Dedup Ratio</label><input type="number" id="m-dedupe" value="1" step="0.1" min="1" class="inp" oninput="debouncedRecalc()"></div>
          <div><label class="lbl">Compression</label><input type="number" id="m-comp" value="1" step="0.1" min="1" class="inp" oninput="debouncedRecalc()"></div>
          <div><label class="lbl">VM Swap Used %</label><input type="number" id="m-swapPct" value="100" step="5" min="0" max="200" class="inp" oninput="debouncedRecalc()"></div>
          <div><label class="lbl">Storage Growth %</label><input type="number" id="m-growth" value="10" min="0" max="200" step="5" class="inp" oninput="debouncedRecalc()"></div>
          </div><!-- /m-vsan-policy-fields -->
          <div><label class="lbl">Host Failures</label>
            <select id="m-fail" class="sel" onchange="recalculate()">
              <option value="0">0 (No redundancy)</option><option value="1" selected>N+1</option><option value="2">N+2</option>
            </select>
          </div>
        </div>
        <div id="m-policy-info" class="pi" style="margin-top:.6rem"></div>
      </div>
    </div>

    <!-- â”€â”€ ROW 2: VM Stack (left 55%) + Cluster Analysis (right 45%) â”€â”€ -->
    <div style="display:grid;grid-template-columns:55fr 45fr;gap:0">

      <!-- LEFT: VM Stack -->
      <div style="border-right:1px solid var(--bd2)">
        <div class="cp" style="padding-bottom:.5rem">
          <div class="panel-title wh"><span class="pt-dot"></span>VMware Management VM Stack</div>
          <div class="tiny" style="margin-top:2px">Full VCF 9 stack Â· Custom slots included</div>
        </div>
        <div class="ox" style="max-height:460px;overflow-y:auto;overflow-x:auto">
          <table class="vmstk">
            <thead>
              <tr>
                <th style="width:3rem;text-align:center">Inc</th>
                <th style="text-align:left">Component</th>
                <th style="text-align:center">Inst.</th>
                <th style="text-align:center">Size</th>
                <th class="th-vcpu" style="text-align:center">vCPU</th>
                <th class="th-ram"  style="text-align:center">RAM (GB)</th>
                <th class="th-disk" style="text-align:center">Disk (GB)</th>
              </tr>
            </thead>
            <tbody id="inventory-body"></tbody>
            <tfoot id="inventory-totals"></tfoot>
          </table>
        </div>
      </div>

      <!-- RIGHT: Cluster Analysis -->
      <div class="cp">
        <div class="rb" style="margin-bottom:.75rem">
          <div class="panel-title or"><span class="pt-dot"></span>Cluster Analysis</div>
          <div style="font-size:11px;color:var(--t4)">Limiter: <span id="m-limiter" class="lm">--</span></div>
        </div>

        <!-- Compute + Memory side by side -->
        <div class="g2" style="gap:.5rem;margin-bottom:.5rem">
          <div class="ab">
            <div class="lbl">Compute</div>
            <div class="sr"><span class="sk">Demand</span><span class="sv w"><span id="m-dem-v">--</span> vCPU</span></div>
            <div class="sr"><span class="sk">Host Cap</span><span class="sv"><span id="m-cap-v">--</span></span></div>
            <div class="sr"><span class="sk">Hosts needed</span><span class="sv"><span id="m-hosts-cpu">--</span></span></div>
          </div>
          <div class="ab">
            <div class="lbl">Memory</div>
            <div class="sr"><span class="sk">Demand</span><span class="sv w"><span id="m-dem-r">--</span> GB</span></div>
            <div class="sr"><span class="sk">Host Cap</span><span class="sv"><span id="m-cap-r">--</span></span></div>
            <div class="sr"><span class="sk">Hosts needed</span><span class="sv"><span id="m-hosts-ram">--</span></span></div>
          </div>
        </div>

        <!-- Result summary -->
        <div class="ab" style="margin-bottom:.5rem">
          <div class="rb">
            <div style="font-size:13px;font-weight:700;color:#e2e8f0">Mgmt Hosts: <span id="m-hosts" style="color:var(--or2)">--</span></div>
            <div id="m-stg-detail-vsan" style="font-size:11px;color:var(--t4)">Storage: <span id="m-hosts-stg" style="color:#e2e8f0;font-weight:700">--</span> &nbsp;|&nbsp; PF: <span id="m-esa-pf" style="color:#e2e8f0;font-weight:700">--</span></div>
          <div id="m-stg-detail-ext" style="display:none;font-size:11px;color:rgba(216,180,254,.7)">ðŸ”Œ <span id="m-ext-vendor-display" style="font-weight:700;color:#c084fc">External Array</span> &nbsp;Â·&nbsp; <span id="m-ext-tib-display" style="color:#fff;font-weight:700">--</span> TiB (user estimate)</div>
          </div>
          <div class="g2" style="margin-top:6px;font-size:11px">
            <div style="color:var(--t4)">Core Licenses: <span id="m-coresOut" style="color:var(--sky2);font-weight:700">--</span></div>
            <div style="color:var(--t4);text-align:right">Raw TiB: <span id="m-rawOut" style="color:var(--em2);font-weight:700">--</span></div>
          </div>
        </div>

        <!-- ESA Storage breakdown -->
        <div id="m-esa-section" class="sp" style="font-size:11px">
          <div class="lbl" style="margin-bottom:6px">ESA Storage Breakdown</div>
          <div class="wf-bar-wrap" id="m-wf-bar"><div class="wf-seg wf-vm" id="m-wf-vm" style="width:20%"><span>VM</span></div><div class="wf-seg wf-swap" id="m-wf-swap" style="width:10%"><span>Swap</span></div><div class="wf-seg wf-pf" id="m-wf-pf" style="width:30%"><span>PF</span></div><div class="wf-seg wf-free" id="m-wf-free" style="width:20%"><span>Free</span></div><div class="wf-seg wf-growth" id="m-wf-growth" style="width:20%"><span>Growth</span></div></div>
          <table class="wf-table">
            <tr>
              <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(56,189,248,.7)"></span></td>
              <td class="wf-td-label">VM Capacity</td>
              <td class="wf-td-val sky"><span id="m-esa-vmcap">--</span> GB</td>
              <td class="wf-td-desc">Total VM disk demand Ã· DRR (dedup Ã— compression ratio)</td>
            </tr>
            <tr>
              <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(99,102,241,.7)"></span></td>
              <td class="wf-td-label">+ Swap</td>
              <td class="wf-td-val"><span id="m-esa-swap">--</span> GB</td>
              <td class="wf-td-desc">VM RAM Ã— swap % â€” reserved for vMotion safety net</td>
            </tr>
            <tr class="wf-subtotal">
              <td class="wf-td-dot"></td>
              <td class="wf-td-label" style="color:var(--t3)">Interim Total</td>
              <td class="wf-td-val" style="color:var(--t3)"><span id="m-esa-interim">--</span> GB</td>
              <td class="wf-td-desc" style="color:rgba(148,163,184,.5)">VM + Swap before RAID overhead</td>
            </tr>
            <tr>
              <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(251,191,36,.7)"></span></td>
              <td class="wf-td-label">Ã— PF <span id="m-esa-pf" style="font-size:9px;font-weight:700;color:var(--am2)">--</span></td>
              <td class="wf-td-val em"><span id="m-esa-prot">--</span> GB</td>
              <td class="wf-td-desc">vSAN RAID tax â€” the cost of your redundancy policy</td>
            </tr>
            <tr>
              <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(52,211,153,.6)"></span></td>
              <td class="wf-td-label">+ Free Reserve</td>
              <td class="wf-td-val"><span id="m-esa-free">--</span> GB</td>
              <td class="wf-td-desc">Headroom for resync, rebuilds &amp; spike absorption</td>
            </tr>
            <tr>
              <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(249,115,22,.7)"></span></td>
              <td class="wf-td-label">+ Growth</td>
              <td class="wf-td-val"><span id="m-esa-growth">--</span> GB</td>
              <td class="wf-td-desc">Forward capacity buffer for data growth over time</td>
            </tr>
            <tr class="wf-subtotal">
              <td class="wf-td-dot"></td>
              <td class="wf-td-label" style="color:var(--t3)">Eff. Hosts</td>
              <td class="wf-td-val" style="color:var(--t3)"><span id="m-esa-effhosts">--</span></td>
              <td class="wf-td-desc" style="color:rgba(148,163,184,.5)">N âˆ’ failed hosts (usable for storage)</td>
            </tr>
            <tr class="wf-result">
              <td class="wf-td-dot"></td>
              <td class="wf-td-label">Per Host Req.</td>
              <td class="wf-td-val"><span id="m-esa-perhost">--</span> GB</td>
              <td class="wf-td-desc" style="color:var(--t3)">Total Ã· effective hosts â€” drives storage host count</td>
            </tr>
            <tr>
              <td class="wf-td-dot"></td>
              <td class="wf-td-label" style="color:var(--t4)">Raw/Host</td>
              <td class="wf-td-val" style="color:#fff"><span id="m-raw-perhost">--</span> GB</td>
              <td class="wf-td-desc">Actual raw NVMe capacity per host from spec above</td>
            </tr>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- WORKLOAD DOMAINS -->
<div class="card cp">
  <div class="rb">
    <div>
      <div class="st" style="color:#93c5fd">4. Workload Domains</div>
      <div class="tiny" style="margin-top:3px">Per-WLD host spec Â· NVMe tiering Â· vSAN ESA policy Â· <a href="https://vmtechie.blog" target="_blank" style="color:inherit;opacity:.7;text-decoration:none">vmtechie.blog</a></div>
    </div>
    <div class="no-print"><button class="btn" onclick="addWLD()">+ Add WLD</button></div>
  </div>
</div>
<div id="wld-container" style="display:flex;flex-direction:column;gap:1rem"><div id="wld-empty-state" class="wld-empty"><div class="em-icon">ðŸ—„</div><div class="em-title">No Workload Domains configured</div><div class="em-sub">Add a workload domain to begin sizing your VCF 9 fleet.<br>Each domain can have its own host spec, storage policy and NVMe tiering.</div><button class="btn" onclick="addWLD()" style="margin-bottom:10px">+ Add Workload Domain</button><br><span class="em-kbd">Ctrl+Shift+W</span> to add quickly</div></div>

<!-- DISCLAIMER -->
<div class="card cp" style="border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.04)">
  <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--red2);margin-bottom:6px">Disclaimer</div>
  <div style="font-size:11px;color:rgba(254,202,202,.85);line-height:1.8">
    <strong style="color:rgba(254,202,202,.95);font-size:12px">âš  Independent Planning Aid â€” Not an Official Broadcom Tool</strong><br>
    This tool is created and maintained by <a href="https://vmtechie.blog" target="_blank" style="color:rgba(147,197,253,.85);text-decoration:none;border-bottom:1px solid rgba(147,197,253,.3)">vmtechie.blog</a> as a free community resource. It is not affiliated with, endorsed by, or supported by Broadcom Inc. or VMware by Broadcom.<br><br>
    All sizing figures are <strong style="color:rgba(254,202,202,.95)">estimates only</strong>, based on inputs you provide and simplified models of VCF 9 behaviour. Real-world deployments involve variables this tool cannot fully account for â€” including actual workload profiles, vSAN overhead variance, network topology, hardware-specific performance, and customer-specific licensing agreements.<br><br>
    <strong style="color:rgba(254,202,202,.95)">Always validate every design</strong> against official <a href="https://techdocs.broadcom.com" target="_blank" style="color:rgba(147,197,253,.7);text-decoration:none">Broadcom TechDocs</a>, the <a href="https://www.vmware.com/resources/compatibility/search.php" target="_blank" style="color:rgba(147,197,253,.7);text-decoration:none">VMware HCL</a>, and qualified field engineering guidance before any procurement or deployment decision.<br><br>
    <a href="https://vmtechie.blog/2026/03/01/how-the-vcf-9-fleet-sizer-actually-works/" target="_blank" style="color:rgba(147,197,253,.8);text-decoration:none;border-bottom:1px solid rgba(147,197,253,.3)">ðŸ“– How this sizer works â€” full methodology explained â†’</a>
  </div>
</div>

</div><!-- /wrap -->
<script>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATED NUMBER COUNTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _prevVals = {};
function animSet(id, newVal) {
  const el = document.getElementById(id);
  if (!el) return;
  const oldStr = el.innerText;
  const newStr = String(newVal);
  if (oldStr === newStr) return;
  // Parse numeric part for counting animation
  const oldN = parseFloat(oldStr.replace(/[^0-9.-]/g,'')) || 0;
  const newN = parseFloat(newStr.replace(/[^0-9.-]/g,'')) || 0;
  const isInt = !newStr.includes('.');
  const suffix = newStr.replace(/[0-9.-]/g,'');
  if (oldN === newN) { el.innerText = newStr; return; }
  const dur = 400, steps = 20, interval = dur/steps;
  let step = 0;
  const timer = setInterval(() => {
    step++;
    const t = step/steps;
    const ease = t<.5 ? 2*t*t : -1+(4-2*t)*t; // ease in-out quad
    const cur = oldN + (newN-oldN)*ease;
    el.innerText = (isInt ? Math.round(cur) : cur.toFixed(1)) + suffix;
    if (step >= steps) { clearInterval(timer); el.innerText = newStr; }
  }, interval);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETTI BURST (grade A)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function confettiBurst(anchorEl) {
  const colors = ['#60a5fa','#34d399','#fbbf24','#f472b6','#a78bfa','#7dd3fc'];
  const rect = anchorEl.getBoundingClientRect();
  const container = document.body;
  for (let i=0; i<18; i++) {
    const p = document.createElement('div');
    p.className = 'confetti-piece';
    p.style.cssText = `left:${rect.left+rect.width/2+( Math.random()-0.5)*60}px;top:${rect.top+window.scrollY-10}px;background:${colors[i%colors.length]};animation-delay:${Math.random()*0.3}s;animation-duration:${0.6+Math.random()*0.4}s;transform:rotate(${Math.random()*360}deg)`;
    container.appendChild(p);
    setTimeout(() => p.remove(), 1200);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOST TILE ANIMATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderHostViz(containerId, count, tone, wldId) {
  const viz = document.getElementById(containerId);
  if (!viz) return;
  const existing = viz.querySelectorAll('.hn').length;
  if (existing === count) return; // no change needed
  viz.innerHTML = '';
  for (let i=1; i<=Math.min(count,24); i++) {
    const div = document.createElement('div');
    div.className = `hn ${tone==='mgmt'?'mgmt-host':''} new-host`;
    div.title = `${tone==='mgmt'?'M':'H'}${i}`;
    div.style.animationDelay = `${(i-1)*0.04}s`;
    // derive colour: mgmt=orange, wld=palette colour
    const tileColor = tone === 'mgmt' ? 'var(--or2)' : (wldId ? wldColor(wldId).hex : 'var(--sky2)');
    div.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:${tileColor}">
        <rect x="4" y="5" width="16" height="6" rx="2" stroke="currentColor" stroke-width="1.6"/>
        <rect x="4" y="13" width="16" height="6" rx="2" stroke="currentColor" stroke-width="1.6"/>
        <circle cx="8" cy="8" r="1" fill="currentColor"/><circle cx="8" cy="16" r="1" fill="currentColor"/>
      </svg>
      <div style="font-size:8px;font-weight:700;color:#e2e8f0">${tone==='mgmt'?'M':'H'}${i}</div>`;
    viz.appendChild(div);
  }
  if (count > 24) {
    const more = document.createElement('div');
    more.style.cssText = 'font-size:10px;font-weight:700;color:var(--t4);align-self:center;padding:0 4px';
    more.innerText = `+${count-24}`;
    viz.appendChild(more);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORAGE WATERFALL BAR UPDATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateWaterfallBar(prefix, vmCap, swap, prot, withFree, withGrowth) {
  const total = withGrowth || 1;
  const swapSeg  = swap;
  const pfSeg    = prot - (vmCap+swap);       // extra added by PF
  const freeSeg  = withFree - prot;            // extra added by free%
  const growSeg  = withGrowth - withFree;      // extra added by growth%
  const segs = [
    { id:`${prefix}-wf-vm`,     w: vmCap/total  },
    { id:`${prefix}-wf-swap`,   w: swapSeg/total },
    { id:`${prefix}-wf-pf`,     w: pfSeg/total   },
    { id:`${prefix}-wf-free`,   w: freeSeg/total  },
    { id:`${prefix}-wf-growth`, w: growSeg/total  }
  ];
  segs.forEach(s => {
    const el = document.getElementById(s.id);
    if (el) el.style.width = Math.max(0, s.w*100).toFixed(1)+'%';
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILISATION ARC GAUGE UPDATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateGauge(id, utilPct) {
  // Gauge SVG removed from table; function retained for compatibility
  const arc   = document.getElementById(`w-gauge-arc-${id}`);
  const label = document.getElementById(`w-gauge-pct-${id}`);
  if (!arc || !label) return;
  // Only update if it's a real SVG element (not a hidden span stub)
  if (arc.tagName && arc.tagName.toLowerCase() === 'path') {
    const arcLen = 107;
    const offset = arcLen * (1 - Math.min(utilPct,100)/100);
    arc.style.strokeDashoffset = offset.toFixed(1);
    const col = utilPct >= 95 ? '#ef4444' : utilPct >= 88 ? '#f59e0b' : utilPct >= 65 ? '#10b981' : '#3b82f6';
    arc.style.stroke = col;
    label.style.fill = col;
    label.textContent = Math.round(utilPct)+'%';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLEET TOPOLOGY DIAGRAM UPDATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateTopology(mgmt, wldResults) {
  const wrap = document.getElementById('topo-wrap');
  if (!wrap) return;
  wrap.innerHTML = '';

  // Management domain box
  const mgmtDiv = document.createElement('div');
  mgmtDiv.className = 'topo-domain';
  mgmtDiv.innerHTML = `
    <div class="topo-box mgmt" style="${isMgmtExt()?'border-color:rgba(168,85,247,.5);background:rgba(168,85,247,.1);color:#c084fc':''}" onclick="document.querySelector('.card[style*=\"orange\"]')?.scrollIntoView({behavior:'smooth',block:'start'})">
      ${isMgmtExt()?'ðŸ”Œ':'ðŸ›'} Management
    </div>
    <div class="topo-stat">${isMgmtExt()
      ? `<strong>${mgmt.mHosts}</strong> hosts<br><strong>${mgmt.mgmtCores}</strong> cores<br><span style="color:#c084fc;font-weight:700">External</span>`
      : `<strong>${mgmt.mHosts}</strong> hosts<br><strong>${mgmt.mgmtCores}</strong> cores<br><strong>${mgmt.mgmtRawTiB.toFixed(1)}</strong> TiB`
    }</div>`;
  wrap.appendChild(mgmtDiv);

  // WLD boxes
  wldResults.forEach((w, i) => {
    const line = document.createElement('div');
    line.className = 'topo-line';
    wrap.appendChild(line);

    const wldDiv = document.createElement('div');
    wldDiv.className = 'topo-domain';
    const name = document.getElementById(`w-name-${w.id}`)?.value || `WLD ${w.id}`;
    const utilPct = Math.round(w.util*100);
    const utilCol = utilPct >= 95 ? '#ef4444' : utilPct >= 88 ? '#f59e0b' : '#6ee7b7';
    const wCol = wldColor(w.id);
    const meta = wldMeta[w.id];
    const envType = meta?.envKey ? ENV_TYPES.find(e=>e.key===meta.envKey) : null;
    const wExt = isExtStorage(w.id);
    const wTopoCol = wExt ? {hex:'#a855f7',rgb:'168,85,247'} : wCol;
    const wTopoIcon = wExt ? 'ðŸ”Œ' : (envType ? envType.icon : 'ðŸ’¾');
    const wTopoStat = wExt
      ? `<strong>${w.hosts}</strong> hosts<br><strong>${w.wCores}</strong> cores<br><span style="color:#c084fc;font-weight:700">External</span>`
      : `<strong>${w.hosts}</strong> hosts<br><strong>${w.wCores}</strong> cores<br><span style="color:${utilCol};font-weight:700">${utilPct}%</span> util`;
    wldDiv.innerHTML = `
      <div class="topo-box wld" style="border-color:${wTopoCol.hex};background:rgba(${wTopoCol.rgb},.1);color:${wTopoCol.hex}" onclick="document.getElementById('wld-${w.id}').scrollIntoView({behavior:'smooth',block:'start'})">
        ${wTopoIcon} ${name}
      </div>
      <div class="topo-stat">${wTopoStat}</div>`;
    wrap.appendChild(wldDiv);
  });
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WLD COLOUR PALETTE & ENV TYPES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WLD_PALETTE = [
  { name:'Electric Blue', hex:'#3b82f6', rgb:'59,130,246'  },
  { name:'Emerald',       hex:'#10b981', rgb:'16,185,129'  },
  { name:'Violet',        hex:'#8b5cf6', rgb:'139,92,246'  },
  { name:'Rose',          hex:'#f43f5e', rgb:'244,63,94'   },
  { name:'Amber',         hex:'#f59e0b', rgb:'245,158,11'  },
  { name:'Cyan',          hex:'#06b6d4', rgb:'6,182,212'   },
  { name:'Orange',        hex:'#f97316', rgb:'249,115,22'  },
  { name:'Lime',          hex:'#84cc16', rgb:'132,204,22'  },
];

const ENV_TYPES = [
  { key:'prod',  icon:'ðŸ­', label:'Production', palette:0 },
  { key:'dev',   icon:'ðŸ”§', label:'Development', palette:1 },
  { key:'edge',  icon:'ðŸ“¡', label:'Edge',        palette:4 },
  { key:'ai',    icon:'ðŸ¤–', label:'AI / ML',     palette:2 },
  { key:'dmz',   icon:'ðŸ›¡', label:'DMZ',         palette:3 },
];

// Per-WLD state: env type and colour index
const wldMeta = {}; // { [id]: { envKey, palIdx } }

function wldColor(id) {
  const meta = wldMeta[id];
  if (meta) return WLD_PALETTE[meta.palIdx % WLD_PALETTE.length];
  // Default: sequential by id
  return WLD_PALETTE[(id - 1) % WLD_PALETTE.length];
}

function setWldEnv(id, envKey) {
  const env = ENV_TYPES.find(e => e.key === envKey);
  if (!env) return;
  if (!wldMeta[id]) wldMeta[id] = { envKey, palIdx: env.palette };
  else { wldMeta[id].envKey = envKey; wldMeta[id].palIdx = env.palette; }
  applyWldTheme(id);
  recalculate();
}

function applyWldTheme(id) {
  const col   = wldColor(id);
  const card  = document.getElementById(`wld-${id}`);
  if (!card) return;

  // Left border + subtle gradient bg
  card.style.borderLeft    = `5px solid ${col.hex}`;
  card.style.borderTop     = 'none';
  card.style.background    = `linear-gradient(135deg, rgba(${col.rgb},.04) 0%, transparent 55%), var(--bg3)`;
  card.style.setProperty('--wld-accent', col.hex);

  // Name input underline colour
  const nameInp = document.getElementById(`w-name-${id}`);
  if (nameInp) {
    nameInp.style.borderBottomColor = `rgba(${col.rgb},.4)`;
    nameInp.onfocus = () => nameInp.style.borderBottomColor = col.hex;
    nameInp.onblur  = () => nameInp.style.borderBottomColor = `rgba(${col.rgb},.4)`;
  }

  // Header border colour
  const hdr = document.getElementById(`wld-hdr-${id}`);
  if (hdr) hdr.style.borderBottomColor = `rgba(${col.rgb},.2)`;

  // Util bar colour
  const bar = document.getElementById(`w-util-bar-${id}`);
  if (bar) bar.style.setProperty('--wld-accent', col.hex);

  // Env badge
  const badge = document.getElementById(`w-env-badge-${id}`);
  const meta  = wldMeta[id];
  if (badge && meta) {
    const env = ENV_TYPES.find(e => e.key === meta.envKey);
    if (env) {
      badge.innerText = `${env.icon} ${env.label}`;
      badge.style.cssText = `display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.08em;border:1px solid rgba(${col.rgb},.4);background:rgba(${col.rgb},.1);color:${col.hex}`;
    }
  }

  // Active env buttons highlight
  ENV_TYPES.forEach(env => {
    const btn = document.getElementById(`w-env-btn-${env.key}-${id}`);
    if (!btn) return;
    const active = meta && meta.envKey === env.key;
    btn.style.background    = active ? `rgba(${col.rgb},.2)` : 'rgba(148,163,184,.06)';
    btn.style.borderColor   = active ? col.hex : 'rgba(148,163,184,.2)';
    btn.style.color         = active ? col.hex : '#94a3b8';
    btn.style.transform     = active ? 'scale(1.05)' : 'scale(1)';
  });

  // Number colour in topology
  updateTopologyColors(id, col);
}

function updateTopologyColors(id, col) {
  // Topology box gets WLD colour - handled in updateTopology() live
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCAL STORAGE PERSISTENCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LS_KEY = 'vcf9-sizer-v2';

function saveState() {
  try {
    const state = {
      mgmt: {
        cpuQty: document.getElementById('m-cpuQty')?.value,
        coresPerCpu: document.getElementById('m-coresPerCpu')?.value,
        ram: document.getElementById('m-ram')?.value,
        nvmeQty: document.getElementById('m-nvme-qty')?.value,
        nvmeSize: document.getElementById('m-nvme-size')?.value,
        storageMode: mgmtStorageMode,
        extVendor: document.getElementById('m-ext-vendor')?.value,
        extTib: document.getElementById('m-ext-tib')?.value,
        cpuSub: document.getElementById('m-cpu-sub')?.value,
        ramSub: document.getElementById('m-ram-sub')?.value,
        reserve: document.getElementById('m-reserve')?.value,
        free: document.getElementById('m-free')?.value,
        dedupe: document.getElementById('m-dedupe')?.value,
        comp: document.getElementById('m-comp')?.value,
        swapPct: document.getElementById('m-swapPct')?.value,
        growth: document.getElementById('m-growth')?.value,
        fail: document.getElementById('m-fail')?.value,
        minHosts: document.getElementById('m-min-hosts')?.value,
        raid: document.getElementById('m-raid')?.value,
        ftt: document.getElementById('m-ftt')?.value,
        r5stripe: document.getElementById('m-r5stripe')?.value,
      },
      vmStack: components.map(c => ({ id:c.id, active:c.active, n:c.n, size:c.size })),
      wlds: [],
      wldMeta: JSON.parse(JSON.stringify(wldMeta)),
    };
    document.querySelectorAll('.wld-card').forEach(card => {
      const id = card.id.split('-')[1];
      const wld = {
        id, name: document.getElementById(`w-name-${id}`)?.value,
        cpuQty: document.getElementById(`w-cpuQty-${id}`)?.value,
        coresPerCpu: document.getElementById(`w-coresPerCpu-${id}`)?.value,
        ram: document.getElementById(`w-ram-${id}`)?.value,
        nvmeQty: document.getElementById(`w-nvme-qty-${id}`)?.value,
        nvmeSize: document.getElementById(`w-nvme-size-${id}`)?.value,
        vms: document.getElementById(`w-vms-${id}`)?.value,
        vcpuVm: document.getElementById(`w-vcpu-vm-${id}`)?.value,
        ramVm: document.getElementById(`w-ram-vm-${id}`)?.value,
        diskVm: document.getElementById(`w-disk-vm-${id}`)?.value,
        growth: document.getElementById(`w-growth-${id}`)?.value,
        cpuSub: document.getElementById(`w-cpu-sub-${id}`)?.value,
        ramSub: document.getElementById(`w-ram-sub-${id}`)?.value,
        reserve: document.getElementById(`w-reserve-${id}`)?.value,
        raid: document.getElementById(`w-raid-${id}`)?.value,
        ftt: document.getElementById(`w-ftt-${id}`)?.value,
        r5stripe: document.getElementById(`w-r5stripe-${id}`)?.value,
        free: document.getElementById(`w-free-${id}`)?.value,
        dedupe: document.getElementById(`w-dedupe-${id}`)?.value,
        comp: document.getElementById(`w-comp-${id}`)?.value,
        swapPct: document.getElementById(`w-swapPct-${id}`)?.value,
        fail: document.getElementById(`w-fail-${id}`)?.value,
        supInc: document.getElementById(`w-sup-inc-${id}`)?.checked,
        supNodes: document.getElementById(`w-sup-nodes-${id}`)?.value,
        supSize: document.getElementById(`w-sup-size-${id}`)?.value,
        edgeInc: document.getElementById(`w-edge-inc-${id}`)?.checked,
        edgeNodes: document.getElementById(`w-edge-nodes-${id}`)?.value,
        edgeSize: document.getElementById(`w-edge-size-${id}`)?.value,
        c1Inc: document.getElementById(`w-c1-inc-${id}`)?.checked,
        c1Nodes: document.getElementById(`w-c1-nodes-${id}`)?.value,
        c1Size: document.getElementById(`w-c1-size-${id}`)?.value,
        c2Inc: document.getElementById(`w-c2-inc-${id}`)?.checked,
        c2Nodes: document.getElementById(`w-c2-nodes-${id}`)?.value,
        c2Size: document.getElementById(`w-c2-size-${id}`)?.value,
        tierOn: document.getElementById(`w-tier-on-${id}`)?.checked,
        tierElig: document.getElementById(`w-tier-elig-${id}`)?.value,
        tierActive: document.getElementById(`w-tier-active-${id}`)?.value,
        tierRatio: document.getElementById(`w-tier-ratio-${id}`)?.value,
        tierNvmeSize: document.getElementById(`w-tier-nvme-size-${id}`)?.value,
        tierRedund: document.getElementById(`w-tier-redund-${id}`)?.value,
        storageMode: wldStorageMode[id] || 'vsan',
        extVendor: document.getElementById(`w-ext-vendor-${id}`)?.value,
        extTib: document.getElementById(`w-ext-tib-${id}`)?.value,
      };
      state.wlds.push(wld);
    });
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  } catch(e) { /* storage full or private mode */ }
}

function loadState() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    const state = JSON.parse(raw);
    if (!state?.mgmt) return false;

    // Restore mgmt
    const sv = (id, v) => { const el=document.getElementById(id); if(el&&v!=null) el.value=v; };
    const m = state.mgmt;
    sv('m-cpuQty',m.cpuQty); sv('m-coresPerCpu',m.coresPerCpu); sv('m-ram',m.ram);
    sv('m-nvme-qty',m.nvmeQty); sv('m-nvme-size',m.nvmeSize);
    sv('m-cpu-sub',m.cpuSub); sv('m-ram-sub',m.ramSub); sv('m-reserve',m.reserve);
    sv('m-free',m.free); sv('m-dedupe',m.dedupe); sv('m-comp',m.comp);
    sv('m-swapPct',m.swapPct); sv('m-growth',m.growth); sv('m-fail',m.fail);
    sv('m-min-hosts',m.minHosts); sv('m-raid',m.raid); sv('m-ftt',m.ftt);
    sv('m-r5stripe',m.r5stripe);
    if (m.storageMode) { mgmtStorageMode = m.storageMode; }
    if (m.extVendor !== undefined) sv('m-ext-vendor', m.extVendor);
    if (m.extTib    !== undefined) sv('m-ext-tib',    m.extTib);
    applyMgmtStorageModeUI();

    // Restore VM stack
    if (state.vmStack) {
      state.vmStack.forEach(saved => {
        const comp = components.find(c => c.id === saved.id);
        if (!comp) return;
        comp.active = saved.active;
        comp.n = saved.n;
        if (saved.size && comp.type !== 'fixed') comp.size = saved.size;
      });
    }

    // Restore WLDs
    const container = document.getElementById('wld-container');
    if (!container) return false;
    container.innerHTML = '';
    wldCount = 0;
    Object.keys(wldMeta).forEach(k => delete wldMeta[k]);
  Object.keys(wldStorageMode).forEach(k => delete wldStorageMode[k]);
  mgmtStorageMode = 'vsan';
  applyMgmtStorageModeUI();

    if (state.wlds && state.wlds.length > 0) {
      state.wlds.forEach(wld => {
        addWLD(); // increments wldCount, creates card with id=wldCount
        const id = wldCount;
        sv(`w-name-${id}`, wld.name);
        sv(`w-cpuQty-${id}`,wld.cpuQty); sv(`w-coresPerCpu-${id}`,wld.coresPerCpu);
        sv(`w-ram-${id}`,wld.ram); sv(`w-nvme-qty-${id}`,wld.nvmeQty); sv(`w-nvme-size-${id}`,wld.nvmeSize);
        sv(`w-vms-${id}`,wld.vms); sv(`w-vcpu-vm-${id}`,wld.vcpuVm); sv(`w-ram-vm-${id}`,wld.ramVm);
        sv(`w-disk-vm-${id}`,wld.diskVm); sv(`w-growth-${id}`,wld.growth);
        sv(`w-cpu-sub-${id}`,wld.cpuSub); sv(`w-ram-sub-${id}`,wld.ramSub); sv(`w-reserve-${id}`,wld.reserve);
        sv(`w-raid-${id}`,wld.raid); sv(`w-ftt-${id}`,wld.ftt); sv(`w-r5stripe-${id}`,wld.r5stripe);
        sv(`w-free-${id}`,wld.free); sv(`w-dedupe-${id}`,wld.dedupe); sv(`w-comp-${id}`,wld.comp);
        sv(`w-swapPct-${id}`,wld.swapPct); sv(`w-fail-${id}`,wld.fail);
        // Infra VMs
        const cb = (eid, v) => { const el=document.getElementById(eid); if(el) el.checked=v; };
        cb(`w-sup-inc-${id}`,wld.supInc); sv(`w-sup-nodes-${id}`,wld.supNodes); sv(`w-sup-size-${id}`,wld.supSize);
        cb(`w-edge-inc-${id}`,wld.edgeInc); sv(`w-edge-nodes-${id}`,wld.edgeNodes); sv(`w-edge-size-${id}`,wld.edgeSize);
        cb(`w-c1-inc-${id}`,wld.c1Inc); sv(`w-c1-nodes-${id}`,wld.c1Nodes); sv(`w-c1-size-${id}`,wld.c1Size);
        cb(`w-c2-inc-${id}`,wld.c2Inc); sv(`w-c2-nodes-${id}`,wld.c2Nodes); sv(`w-c2-size-${id}`,wld.c2Size);
        // Tiering
        const tierEl = document.getElementById(`w-tier-on-${id}`);
        if (tierEl) { tierEl.checked = wld.tierOn; toggleTierPanel(id); }
        sv(`w-tier-elig-${id}`,wld.tierElig); sv(`w-tier-active-${id}`,wld.tierActive);
        sv(`w-tier-ratio-${id}`,wld.tierRatio); sv(`w-tier-nvme-size-${id}`,wld.tierNvmeSize);
        sv(`w-tier-redund-${id}`,wld.tierRedund);
        // Restore env meta
        const savedMeta = state.wldMeta?.[wld.id];
        if (savedMeta) { wldMeta[id] = { envKey: savedMeta.envKey, palIdx: savedMeta.palIdx }; applyWldTheme(id); }
        syncRaidFttOptions('w', id);
      });
    } else {
      addWLD();
    }
    return true;
  } catch(e) { return false; }
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXTERNAL STORAGE MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const wldStorageMode = {}; // { [id]: 'vsan' | 'ext' }

function isExtStorage(id) { return wldStorageMode[id] === 'ext'; }

function setStorageMode(id, mode) {
  wldStorageMode[id] = mode;
  applyStorageModeUI(id);
  recalculate();
}

function applyStorageModeUI(id) {
  const ext = isExtStorage(id);
  const col = wldColor(id);

  // Toggle buttons
  const vsanBtn = document.getElementById(`w-stg-vsan-${id}`);
  const extBtn  = document.getElementById(`w-stg-ext-${id}`);
  if (vsanBtn) { vsanBtn.className = `stg-mode-btn${ext?'':' active-vsan'}`; }
  if (extBtn)  { extBtn.className  = `stg-mode-btn${ext?' active-ext':''}`; }

  // Show/hide NVMe fields (Qty + Size)
  const nvmeWrap = document.getElementById(`w-nvme-fields-${id}`);
  if (nvmeWrap) {
    // Only hide NVMe Qty and Size inputs, keep CPU/RAM visible
    const nvmeQty  = nvmeWrap.querySelector(`#w-nvme-qty-${id}`)?.closest('div');
    const nvmeSize = nvmeWrap.querySelector(`#w-nvme-size-${id}`)?.closest('div.cs2');
    if (nvmeQty)  nvmeQty.style.display  = ext ? 'none' : '';
    if (nvmeSize) nvmeSize.style.display = ext ? 'none' : '';
  }

  // Show/hide ext info box
  const extBox = document.getElementById(`w-ext-box-${id}`);
  if (extBox) extBox.style.display = ext ? '' : 'none';

  // Show/hide vSAN-only policy fields
  const vsanPol = document.getElementById(`w-vsan-policy-fields-${id}`);
  const vsanStg = document.getElementById(`w-vsan-stg-fields-${id}`);
  if (vsanPol) vsanPol.classList.toggle('vsan-hidden', ext);
  if (vsanStg) vsanStg.classList.toggle('vsan-hidden', ext);

  // Show/hide NVMe Tiering section
  const tierSec = document.getElementById(`w-tier-section-${id}`);
  if (tierSec) tierSec.style.display = ext ? 'none' : '';

  // Policy info banner (vSAN-specific â€” hide when ext)
  const wPolicyInfo = document.getElementById(`w-policy-info-${id}`);
  if (wPolicyInfo) wPolicyInfo.style.display = ext ? 'none' : '';

  // ESA storage column in summary: swap waterfall for ext badge
  const esaCell  = document.getElementById(`w-esa-cell-${id}`);
  const extBadge = document.getElementById(`w-ext-badge-${id}`);
  if (esaCell)  esaCell.style.display  = ext ? 'none' : '';
  if (extBadge) extBadge.style.display = ext ? '' : 'none';

  // Update card border colour to purple if ext
  const card = document.getElementById(`wld-${id}`);
  if (card && ext) {
    card.style.borderLeft = '5px solid #a855f7';
    card.style.background = 'linear-gradient(135deg, rgba(168,85,247,.05) 0%, transparent 55%), var(--bg3)';
  } else if (card) {
    applyWldTheme(id); // restore WLD colour
  }
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MANAGEMENT EXTERNAL STORAGE MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let mgmtStorageMode = 'vsan'; // 'vsan' | 'ext'

function isMgmtExt() { return mgmtStorageMode === 'ext'; }

function setMgmtStorageMode(mode) {
  mgmtStorageMode = mode;
  applyMgmtStorageModeUI();
  recalculate();
}

function applyMgmtStorageModeUI() {
  const ext = isMgmtExt();

  // Toggle buttons
  const vsanBtn = document.getElementById('m-stg-vsan');
  const extBtn  = document.getElementById('m-stg-ext');
  if (vsanBtn) vsanBtn.className = `stg-mode-btn${ext ? '' : ' active-vsan'}`;
  if (extBtn)  extBtn.className  = `stg-mode-btn${ext ? ' active-ext' : ''}`;

  // NVMe Qty + Size fields
  const qtyWrap  = document.getElementById('m-nvme-qty-wrap');
  const sizeWrap = document.getElementById('m-nvme-size-wrap');
  if (qtyWrap)  qtyWrap.style.display  = ext ? 'none' : '';
  if (sizeWrap) sizeWrap.style.display = ext ? 'none' : '';

  // External info box
  const extBox = document.getElementById('m-ext-box');
  if (extBox) extBox.style.display = ext ? '' : 'none';

  // vSAN-only policy fields (RAID/FTT/Free/DRR/Swap/Growth)
  const vsanPol = document.getElementById('m-vsan-policy-fields');
  if (vsanPol) vsanPol.classList.toggle('vsan-hidden', ext);

  // ESA Storage Breakdown section in Cluster Analysis
  const esaSec = document.getElementById('m-esa-section');
  if (esaSec) esaSec.style.display = ext ? 'none' : '';

  // Storage limiter row: show vSAN line or ext line
  const vsanRow = document.getElementById('m-stg-detail-vsan');
  const extRow  = document.getElementById('m-stg-detail-ext');
  if (vsanRow) vsanRow.style.display = ext ? 'none' : '';
  if (extRow)  extRow.style.display  = ext ? ''     : 'none';

  // Policy info banner (vSAN-specific â€” hide when ext)
  const mPolicyInfo = document.getElementById('m-policy-info');
  if (mPolicyInfo) mPolicyInfo.style.display = ext ? 'none' : '';

  // Card: add purple tint when ext
  const card = document.querySelector('.card.mgmt-card-subtle');
  if (card) {
    card.style.borderColor = ext ? 'rgba(168,85,247,.3)' : '';
    card.style.background  = ext ? 'rgba(168,85,247,.03)' : '';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS & GLOBALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let wldCount = 0;
const TB_TO_TIB = 0.9095;
const TB_TO_GB  = 1000;
const TIER_PARTITION_CAP_GB = 4096;

/* â”€â”€ vSAN ESA mode table (official Broadcom documentation) â”€â”€
   raid = 'none' | 'mirror' | 'raid5' | 'raid6'
   ftt  = 0 | 1 | 2 | 3
   hosts = computed host count (used to auto-select RAID-5 stripe)

   RAID-0  FTT=0:  1 host,  PF=1.0  (no redundancy)
   Mirror  FTT=1:  3 hosts, PF=2.0
   Mirror  FTT=2:  5 hosts, PF=3.0
   Mirror  FTT=3:  7 hosts, PF=4.0
   RAID-5  FTT=1:  auto â†’ 4+1 (6 hosts, 1.25Ã—) if hosts â‰¥ 6, else 2+1 (3 hosts, 1.5Ã—)
           NOTE: No RAID-5 FTT=2 in vSAN ESA â€” RAID-6 is used instead
   RAID-6  FTT=2:  6 hosts, PF=1.5

   For the RAID-5 stripe: vSAN ESA uses 2+1 for smaller clusters (< 6 hosts)
   and 4+1 for larger clusters (â‰¥ 6 hosts). There is no 3+1 scheme.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getEsaMode(raid, ftt, stripe) {
  ftt = parseInt(ftt, 10) || 0;
  if (raid === 'none')   return { minHosts:1, pf:1.0,  label:'RAID-0 (No Redundancy)' };
  if (raid === 'mirror') {
    if (ftt === 2) return { minHosts:5, pf:3.0, label:'Mirror RAID-1 FTT=2' };
    if (ftt === 3) return { minHosts:7, pf:4.0, label:'Mirror RAID-1 FTT=3' };
    return               { minHosts:3, pf:2.0,  label:'Mirror RAID-1 FTT=1' };
  }
  if (raid === 'raid5') {
    if (stripe === '2p1') return { minHosts:3, pf:1.5,  label:'RAID-5 2+1 FTT=1 (min 3 hosts)' };
    return                       { minHosts:6, pf:1.25, label:'RAID-5 4+1 FTT=1 (min 6 hosts)' };
  }
  if (raid === 'raid6') return { minHosts:6, pf:1.5, label:'RAID-6 4+2 FTT=2' };
  return { minHosts:3, pf:1.5, label:'RAID-5 2+1 FTT=1' };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEBOUNCE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _dt = null;
function debouncedRecalc() { clearTimeout(_dt); _dt = setTimeout(recalculate, 180); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function clampNum(x, def=0) { const n=Number(x); return Number.isFinite(n)?n:def; }

// hostTile replaced by renderHostViz()

function sizeLabel(s) {
  return ({s:'S',m:'M',l:'L',xl:'XL',xxl:'XXL',ha:'HA',emb:'Emb',tiny:'Tiny',small:'Small',medium:'Med',large:'Lrg'})[s]||s.toUpperCase();
}

function toggleSection(id) {
  const el = document.getElementById(id);
  const chev = document.getElementById(id+'-chev');
  if (!el) return;
  const currentlyHidden = el.style.display === 'none' || el.dataset.open === 'false';
  el.dataset.open = currentlyHidden ? 'true' : 'false';
  el.style.display = currentlyHidden ? '' : 'none';
  if (chev) chev.innerHTML = currentlyHidden
    ? '<path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>'
    : '<path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>';
  // Show/hide mgmt collapsed summary badge
  if (id === 'mgmt-unified') {
    const badge = document.getElementById('m-summary-badge');
    if (badge) badge.style.display = currentlyHidden ? 'none' : 'inline-flex';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RAID-FTT SYNC
   â€¢ Disables FTT options that are invalid for the chosen RAID type
   â€¢ For RAID-5: forces FTT=1 (only valid option in vSAN ESA)
   â€¢ For RAID-6: forces FTT=2
   â€¢ For RAID-0: forces FTT=0
   â€¢ Updates policy info banner (stripe chosen at calc time based on hosts)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function syncRaidFttOptions(prefix, id) {
  const raidEl     = document.getElementById(id ? `w-raid-${id}`          : 'm-raid');
  const fttEl      = document.getElementById(id ? `w-ftt-${id}`           : 'm-ftt');
  const stripeWrap = document.getElementById(id ? `w-r5stripe-wrap-${id}` : 'm-r5stripe-wrap');
  const stripeEl   = document.getElementById(id ? `w-r5stripe-${id}`      : 'm-r5stripe');
  const infoEl     = document.getElementById(id ? `w-policy-info-${id}`   : 'm-policy-info');
  if (!raidEl || !fttEl) return;

  const raid = raidEl.value;

  // Reset FTT options, then restrict per RAID type
  Array.from(fttEl.options).forEach(o => { o.disabled = false; });
  if (raid === 'none') {
    [1,2,3].forEach(v => { const o=fttEl.querySelector(`option[value="${v}"]`); if(o) o.disabled=true; });
    fttEl.value = '0';
  } else if (raid === 'mirror') {
    const o0=fttEl.querySelector('option[value="0"]'); if(o0) o0.disabled=true;
    if (fttEl.value === '0') fttEl.value = '1';
  } else if (raid === 'raid5') {
    [0,2,3].forEach(v => { const o=fttEl.querySelector(`option[value="${v}"]`); if(o) o.disabled=true; });
    fttEl.value = '1';
  } else if (raid === 'raid6') {
    [0,1,3].forEach(v => { const o=fttEl.querySelector(`option[value="${v}"]`); if(o) o.disabled=true; });
    fttEl.value = '2';
  }

  // Show RAID-5 stripe selector only when RAID-5 is selected
  if (stripeWrap) stripeWrap.style.display = (raid === 'raid5') ? '' : 'none';

  // Update policy info banner
  const ftt    = parseInt(fttEl.value, 10);
  const stripe = stripeEl?.value || '4p1';
  const mode   = getEsaMode(raid, ftt, stripe);
  if (infoEl) infoEl.innerHTML =
    `<strong style="color:#93c5fd">${mode.label}</strong>`
    + ` \u2014 Min Hosts: <strong style="color:#e2e8f0">${mode.minHosts}</strong>`
    + ` &nbsp;|&nbsp; PF: <strong style="color:#e2e8f0">${mode.pf}\u00d7</strong>`
    + ` &nbsp;|&nbsp; Each VM consumes: <strong style="color:#e2e8f0">${Math.round(mode.pf*100)}% of its provisioned size</strong>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESA STORAGE FUNCTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esaStorageTotals({ vmCapacityGB, swapGB, pf, freeSpacePct, growthPct }) {
  const interimGB    = vmCapacityGB + swapGB;
  const protectedGB  = interimGB * pf;
  const withFreeGB   = protectedGB * (1 + freeSpacePct);
  const withGrowthGB = withFreeGB  * (1 + growthPct);
  return { interimGB, protectedGB, withFreeGB, withGrowthGB };
}

function esaPerHost({ withGrowthGB, nHosts, failures }) {
  const eff = Math.max(1, nHosts - failures);
  return { eff, perHostGB: withGrowthGB / eff };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VCF 9 NVMe MEMORY TIERING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcTiering(id, hostRAM, demandR, hostsBaseline) {
  const tierOn = document.getElementById(`w-tier-on-${id}`)?.checked ?? false;
  if (!tierOn) return { tierOn:false, effectiveDemandR:demandR };

  const eligPct   = Math.max(0, Math.min(100, clampNum(document.getElementById(`w-tier-elig-${id}`)?.value, 80))) / 100;
  const activePct = Math.max(0, clampNum(document.getElementById(`w-tier-active-${id}`)?.value, 40)) / 100;
  const nvmeRatio = Math.max(1, Math.min(4, clampNum(document.getElementById(`w-tier-ratio-${id}`)?.value, 2)));
  const tierDriveTB = Math.max(0.5, clampNum(document.getElementById(`w-tier-nvme-size-${id}`)?.value, 2));
  const redundancy  = Math.max(1, clampNum(document.getElementById(`w-tier-redund-${id}`)?.value, 1));

  const driveGB       = tierDriveTB * TB_TO_GB;
  const wantedByRatio = hostRAM * nvmeRatio;
  const partitionGB   = Math.min(driveGB, wantedByRatio, TIER_PARTITION_CAP_GB);
  const nvmeRatioUsed = partitionGB / hostRAM;
  const effectiveHostRAM = hostRAM * (1 + nvmeRatioUsed);

  const eligDemand   = demandR * eligPct;
  const ineligDemand = demandR * (1 - eligPct);
  const tieredDemandR = (eligDemand / (1 + nvmeRatioUsed)) + ineligDemand;

  const drivesPerHost = redundancy;
  const tierRawTiB    = hostsBaseline * drivesPerHost * tierDriveTB * TB_TO_TIB;

  return {
    tierOn:true, eligPct, activePct, nvmeRatio, nvmeRatioUsed,
    tierDriveTB, driveGB, partitionGB, effectiveHostRAM,
    eligDemand, ineligDemand, effectiveDemandR:tieredDemandR,
    drivesPerHost, redundancy, tierRawTiB,
    activeWarn: activePct > 0.5, partCapHit: wantedByRatio > TIER_PARTITION_CAP_GB
  };
}

function toggleTierPanel(id) {
  const on    = document.getElementById(`w-tier-on-${id}`)?.checked ?? false;
  const panel = document.getElementById(`w-tier-panel-${id}`);
  const badge = document.getElementById(`w-tier-badge-${id}`);
  if (panel) {
    panel.classList.toggle('off', !on);
    panel.style.display = on ? '' : 'none';
  }
  if (badge) { badge.className = on ? 'badge t-on' : 'badge t-off'; badge.innerText = on ? 'On' : 'Off'; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MGMT VM STACK DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tshirtMap = {
  vc_m:      { s:[4,21,694],   m:[8,30,908],    l:[16,39,1358],  xl:[24,58,2283] },
  nsx_m:     { m:[6,24,300],   l:[12,48,300],   xl:[24,96,400] },
  nsx_e:     { s:[2,4,200],    m:[4,8,200],     l:[8,32,200],    xl:[16,64,200] },
  nsx_gm:    { s:[4,16,300],   m:[6,24,300],    l:[12,48,300],   xl:[24,96,400] },
  avi:       { s:[8,24,128],   m:[16,32,256],   l:[24,48,512] },
  vc_w:      { s:[4,21,694],   m:[8,30,908],    l:[16,39,1358],  xl:[24,58,2283] },
  nsx_w:     { m:[4,24,300],   l:[12,48,300],   xl:[24,96,400] },
  vcfops:    { s:[4,16,274],   m:[8,32,274],    l:[16,48,274],   xl:[24,128,274] },
  vcfcollector:{ s:[2,8,144],  m:[4,32,144] },
  vcflogs:   { s:[12,24,1590], m:[24,48,1590],  l:[48,96,1590] },
  vcfnet:    { l:[12,24,1590], xl:[24,48,1590], xxl:[48,96,1590] },
  vcfnetcoll:{ m:[4,12,200],   l:[8,16,200],    xl:[8,24,200],   xxl:[16,48,300] },
  identity:  { emb:[0,0,0],    ha:[32,64,400] },
  custom:    { s:[2,4,100],    m:[4,8,200],     l:[8,16,400],    xl:[16,32,800] }
};

const components = [
  { id:'sddc',        name:"SDDC Manager",              type:'fixed',v:4, r:16,d:930, n:1,active:true  },
  { id:'vc_m',        name:"Mgmt vCenter",              type:'vc_m', size:'s',n:2,active:true  },
  { id:'nsx_m',       name:"Mgmt NSX Manager",          type:'nsx_m',size:'m',n:3,active:true  },
  { id:'nsx_e',       name:"Mgmt NSX Edges",            type:'nsx_e',size:'s',n:2,active:true  },
  { id:'nsx_gm',      name:"NSX GM",                    type:'nsx_gm',size:'s',n:3,active:false },
  { id:'avi_m',       name:"AVI Controller",            type:'avi',  size:'s',n:3,active:true  },
  { id:'vc_w',        name:"WLD vCenter",               type:'vc_w', size:'m',n:1,active:true  },
  { id:'nsx_w',       name:"WLD NSX Manager",           type:'nsx_w',size:'m',n:3,active:true  },
  { id:'ops_fm',      name:"VCF Ops Fleet Mgr",         type:'fixed',v:4, r:12,d:194,n:1,active:true  },
  { id:'vcf_ops',     name:"VCF Operations",            type:'vcfops',size:'s',n:1,active:true  },
  { id:'vcf_coll',    name:"VCF Ops Collector",         type:'vcfcollector',size:'s',n:3,active:true  },
  { id:'vcf_auto',    name:"VCF Automation",            type:'fixed',v:24,r:96,d:700,n:1,active:true  },
  { id:'vcf_logs',    name:"VCF Ops for Logs",          type:'vcflogs',size:'s',n:3,active:true  },
  { id:'vcf_net',     name:"VCF Ops for Network",       type:'vcfnet',size:'l',n:3,active:false },
  { id:'vcf_net_coll',name:"VCF Net Collector",         type:'vcfnetcoll',size:'m',n:3,active:false},
  { id:'id_broker',   name:"Identity Broker",           type:'identity',size:'ha',n:2,active:false},
  { id:'custom1',     name:"Custom 1",                  type:'custom',size:'s',n:1,active:true  },
  { id:'custom2',     name:"Custom 2",                  type:'custom',size:'s',n:1,active:true  }
];

const wldVmMap = {
  vks:   { tiny:[2,8,32],small:[4,16,32],medium:[8,16,32],large:[16,32,32] },
  edge:  { s:tshirtMap.nsx_e.s,m:tshirtMap.nsx_e.m,l:tshirtMap.nsx_e.l,xl:tshirtMap.nsx_e.xl },
  custom:{ s:[2,4,100],m:[4,8,200],l:[8,16,400] }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MGMT VM STACK RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderInventory() {
  const tbody = document.getElementById('inventory-body');
  tbody.innerHTML = '';
  components.forEach(c => {
    const specs = c.type!=='fixed' ? (tshirtMap[c.type]?.[c.size]||[0,0,0]) : [c.v,c.r,c.d];
    tbody.innerHTML += `
      <tr id="row-${c.id}" class="${!c.active?'row-off':''}">
        <td style="text-align:center"><input type="checkbox" ${c.active?'checked':''} onchange="toggleVm('${c.id}')" aria-label="Include ${c.name}"></td>
        <td><span class="comp-name">${c.name}</span></td>
        <td style="text-align:center"><input type="number" id="node-val-${c.id}" value="${c.n}" class="inp" style="width:3.2rem;margin:0 auto;text-align:center" aria-label="${c.name} nodes" oninput="updateNodes('${c.id}',this.value)"></td>
        <td style="text-align:center">
          ${c.type!=='fixed'
            ? `<select class="sel" style="width:4.2rem;margin:0 auto" aria-label="${c.name} size" onchange="updateSize('${c.id}',this.value)">
                ${Object.keys(tshirtMap[c.type]||{}).map(s=>`<option value="${s}" ${c.size===s?'selected':''}>${sizeLabel(s)}</option>`).join('')}
               </select>`
            : `<span style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--t4)">Fixed</span>`}
        </td>
        <td class="num-val" style="color:#e2e8f0">${specs[0]}</td>
        <td class="num-val" style="color:#e2e8f0">${specs[1]}</td>
        <td class="num-val" style="color:var(--sky2)">${specs[2]}</td>
      </tr>`;
  });

  // Totals row
  const tfoot = document.getElementById('inventory-totals');
  if (tfoot) {
    let tv=0, tr=0, td=0;
    components.forEach(c => {
      if (!c.active) return;
      const specs = c.type!=='fixed' ? (tshirtMap[c.type]?.[c.size]||[0,0,0]) : [c.v,c.r,c.d];
      tv += specs[0]*c.n; tr += specs[1]*c.n; td += specs[2]*c.n;
    });
    tfoot.innerHTML = `<tr>
      <td colspan="4" style="text-align:right;letter-spacing:.1em;text-transform:uppercase;font-size:10px;color:var(--t3)">Active Totals</td>
      <td class="num-val" style="color:var(--sky2)">${tv}</td>
      <td class="num-val" style="color:var(--sky2)">${tr}</td>
      <td class="num-val" style="color:var(--em2)">${td.toLocaleString()}</td>
    </tr>`;
  }
  recalculate();
}
function toggleVm(id) { components.find(x=>x.id===id).active^=true; renderInventory(); }
function updateNodes(id,val) { components.find(x=>x.id===id).n=parseInt(val)||0; recalculate(); }
function updateSize(id,val)  { components.find(x=>x.id===id).size=val; renderInventory(); }

function mgmtTotals() {
  let v=0,r=0,d=0;
  components.forEach(c => {
    if (!c.active) return;
    const specs = c.type!=='fixed' ? (tshirtMap[c.type]?.[c.size]||[0,0,0]) : [c.v,c.r,c.d];
    v+=specs[0]*c.n; r+=specs[1]*c.n; d+=specs[2]*c.n;
  });
  return {vcpu:v,ramGB:r,diskGB:d};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WLD UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function syncWldName(id) {
  // Keep name in sync if it's used elsewhere (summary, etc.)
  const nameEl = document.getElementById(`w-name-${id}`);
  const name = nameEl?.value?.trim() || `WLD #${id}`;
  const titleEl = document.getElementById(`w-title-display-${id}`);
  if (titleEl) titleEl.innerText = name;
}

function toggleWldCollapse(id) {
  const body  = document.getElementById(`wld-body-${id}`);
  const label = document.getElementById(`wld-toggle-label-${id}`);
  const chev  = document.getElementById(`wld-chev-${id}`);
  const badge = document.getElementById(`w-collapsed-badge-${id}`);
  const viz   = document.getElementById(`wld-viz-${id}`);
  if (!body) return;
  const hidden = body.classList.toggle('hidden');
  if (label) label.innerText = hidden ? 'Expand' : 'Collapse';
  if (chev) chev.innerHTML = hidden
    ? '<path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>'
    : '<path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>';
  // Badge visible when collapsed, host viz hidden when collapsed
  if (badge) badge.style.display = hidden ? 'inline-flex' : 'none';
  if (viz)   viz.style.display   = hidden ? 'none' : '';
}

function addWLD() {
  wldCount++;
  const id = wldCount;
  const container = document.getElementById('wld-container');
  const div = document.createElement('div');
  div.className = 'card cp wld-card';
  div.id = `wld-${id}`;
  div.innerHTML = `
    <!-- WLD header -->
    <div id="wld-hdr-${id}" class="rb" style="border-bottom:1px solid rgba(59,130,246,.2);padding-bottom:10px;margin-bottom:10px">
      <div style="flex:1;min-width:0">
        <div class="row" style="flex-wrap:wrap;gap:8px">
          <div class="row" style="gap:6px;align-items:center">
            <div style="font-size:13px;font-weight:700;font-style:italic;text-transform:uppercase;color:var(--t4)">#${id}</div>
            <input type="text" id="w-name-${id}" value="Workload Domain ${id}"
              style="background:transparent;border:none;border-bottom:1px solid rgba(59,130,246,.3);color:#fff;font-size:16px;font-weight:700;font-style:italic;text-transform:uppercase;outline:none;width:220px;padding:2px 4px;font-family:var(--fs);letter-spacing:.02em"
              oninput="syncWldName(${id})">
          </div>
          <span id="w-env-badge-${id}" style="display:none"></span>
          <span id="w-health-${id}" class="badge b-ok">Healthy</span>
          <span id="w-util-pct-${id}" class="mono" style="font-size:12px;font-weight:700;color:#e2e8f0">--%</span>
        </div>
        <!-- Environment type selector -->
        <div class="env-selector">
          ${ENV_TYPES.map(e => `<button id="w-env-btn-${e.key}-${id}" class="env-btn" onclick="setWldEnv(${id},'${e.key}')" title="${e.label}">${e.icon} ${e.label}</button>`).join('')}
        </div>
        <div class="bw" style="max-width:460px;margin-top:6px"><div id="w-util-bar-${id}" class="bf" style="--wld-accent:#3b82f6"></div></div>
        <div id="w-policy-warn-${id}" class="wb red"></div>
        <div id="w-hosts-warn-${id}" class="wb amber"></div>
      </div>
      <div class="row" style="align-self:flex-start;gap:6px">
        <div id="w-collapsed-badge-${id}" class="collapsed-summary" style="display:none">
          <span id="w-badge-hosts-${id}">--</span> hosts Â·
          <span id="w-badge-cores-${id}">--</span> cores Â·
          <span id="w-badge-util-${id}">--</span>%
        </div>
        <div id="wld-viz-${id}" class="hviz"></div>
        <div class="no-print row">
          <button class="btn2" onclick="toggleWldCollapse(${id})">
            <span class="row">
              <svg id="wld-chev-${id}" width="13" height="13" viewBox="0 0 24 24" style="color:var(--t3)"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
              <span id="wld-toggle-label-${id}">Collapse</span>
            </span>
          </button>
          <button class="btn2" onclick="duplicateWLD(${id})" title="Clone this WLD with all settings">â§‰ Duplicate</button>
          <button class="btn2 danger" onclick="removeWLD(${id})">Remove</button>
        </div>
      </div>
    </div>

    <div id="wld-body-${id}">
      <div class="g2">

        <!-- LEFT: Tenant demand + Host spec -->
        <div class="col" style="gap:.75rem">
          <!-- HOST SPEC -->
          <div class="sp">
            <div class="panel-title wld" style="--wld-hdr-col:var(--wld-accent,#3b82f6)"><span class="pt-dot"></span>Host Specification</div>
            <!-- Storage Mode Toggle -->
            <div class="stg-mode-bar">
              <span class="stg-mode-label">Storage</span>
              <button id="w-stg-vsan-${id}" class="stg-mode-btn active-vsan" onclick="setStorageMode(${id},'vsan')">ðŸ—„ vSAN ESA</button>
              <button id="w-stg-ext-${id}"  class="stg-mode-btn" onclick="setStorageMode(${id},'ext')">ðŸ”Œ External Array</button>
            </div>
            <div id="w-nvme-fields-${id}" class="hspec">
              <div><label class="lbl">CPUs/Host</label><input type="number" id="w-cpuQty-${id}" value="2" min="1" class="inp" oninput="debouncedRecalc()"></div>
              <div><label class="lbl">Cores/CPU</label><input type="number" id="w-coresPerCpu-${id}" value="16" min="1" class="inp" oninput="debouncedRecalc()"></div>
              <div><label class="lbl">RAM (GB)</label><input type="number" id="w-ram-${id}" value="1024" min="64" class="inp" oninput="debouncedRecalc()"></div>
              <div>
                <label class="lbl">NVMe Qty</label><input type="number" id="w-nvme-qty-${id}" value="6" min="0" class="inp" oninput="debouncedRecalc()">
              </div>
              <div class="cs2 cs2-hspec">
                <label class="lbl">NVMe Size (TB)</label>
                <input type="number" id="w-nvme-size-${id}" value="7.68" step="0.01" min="0" class="inp" oninput="debouncedRecalc()">
              </div>
            </div><!-- /w-nvme-fields -->

            <!-- External storage info box (hidden by default) -->
            <div id="w-ext-box-${id}" class="ext-info-box" style="display:none">
              <div class="ei-title">ðŸ”Œ External Storage Array</div>
              <div class="ei-note">Host count is driven by compute &amp; memory only. Storage sizing is handled by your external array. vSAN policies and NVMe tiering are not applicable.</div>
              <div class="ent-forfeit">
                âš  <strong>Entitlement forfeited:</strong> VCF includes <strong>1 TiB vSAN raw per licensed core</strong>. This WLD's <span id="w-ext-cores-display-${id}" class="ef-num">--</span> cores = <span id="w-ext-ent-display-${id}" class="ef-num">--</span> TiB entitlement not utilised â€” budget for array costs separately.
              </div>
              <div class="ei-fields">
                <div><label class="lbl">Array / Vendor</label><input type="text" id="w-ext-vendor-${id}" value="" placeholder="e.g. Pure FlashArray" class="inp" style="font-size:11px" oninput="debouncedRecalc()"></div>
                <div><label class="lbl">Estimated Capacity (TiB)</label><input type="number" id="w-ext-tib-${id}" value="" placeholder="0" min="0" class="inp" oninput="debouncedRecalc()"></div>
              </div>
            </div>
          </div>

          <!-- TENANT DEMAND -->
          <div class="sp">
            <div class="panel-title blue"><span class="pt-dot"></span>Tenant Demand</div>
            <div class="g2">
              <div><label class="lbl">VMs</label><input type="number" id="w-vms-${id}" value="100" class="inp" oninput="debouncedRecalc()"></div>
              <div><label class="lbl">vCPU/VM</label><input type="number" id="w-vcpu-vm-${id}" value="4" class="inp" oninput="debouncedRecalc()"></div>
              <div><label class="lbl">RAM/VM (GB)</label><input type="number" id="w-ram-vm-${id}" value="16" class="inp" oninput="debouncedRecalc()"></div>
              <div><label class="lbl">Disk/VM (GB)</label><input type="number" id="w-disk-vm-${id}" value="250" class="inp" oninput="debouncedRecalc()"></div>
              <div class="cs2"><label class="lbl">Storage Growth %</label><input type="number" id="w-growth-${id}" value="10" min="0" max="200" step="1" class="inp" oninput="debouncedRecalc()"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Policy + planning -->
        <div class="sp">
          <div class="rb" style="margin-bottom:8px">
            <div class="panel-title blue" style="border-bottom:none;padding-bottom:0;margin-bottom:0">Policy + Planning</div>
            <div class="tiny mono"><a href="https://vmtechie.blog" target="_blank" style="color:inherit;text-decoration:none">vmtechie.blog</a></div>
          </div>
          <div class="g2">
            <div><label class="lbl blue">CPU Sub</label>
              <select id="w-cpu-sub-${id}" class="sel" onchange="recalculate()">
                <option value="1">1:1</option><option value="2" selected>2:1</option><option value="4">4:1</option><option value="8">8:1</option>
              </select>
            </div>
            <div><label class="lbl blue">Mem Sub</label>
              <select id="w-ram-sub-${id}" class="sel" onchange="recalculate()">
                <option value="1" selected>1:1</option><option value="2">2:1</option><option value="4">4:1</option><option value="8">8:1</option>
              </select>
            </div>
            <div id="w-vsan-policy-fields-${id}" style="display:contents">
            <div><label class="lbl em">RAID Type</label>
              <select id="w-raid-${id}" class="sel" onchange="syncRaidFttOptions('w',${id});recalculate()">
                <option value="none">RAID-0 (No Redundancy)</option>
                <option value="mirror">Mirror (RAID-1)</option>
                <option value="raid5" selected>RAID-5 (Erasure Coding)</option>
                <option value="raid6">RAID-6 (Erasure Coding)</option>
              </select>
            </div>
            <div><label class="lbl em">FTT<span class="tip" title="Failures To Tolerate. Options constrained by RAID type.">i</span></label>
              <select id="w-ftt-${id}" class="sel" onchange="syncRaidFttOptions('w',${id});recalculate()">
                <option value="0">FTT=0</option>
                <option value="1" selected>FTT=1</option>
                <option value="2">FTT=2</option>
                <option value="3">FTT=3</option>
              </select>
            </div>
            <div id="w-r5stripe-wrap-${id}"><label class="lbl em">RAID-5 Stripe<span class="tip" title="2+1: min 3 hosts, 150% of VM size (1.5Ã— PF). 4+1: min 6 hosts, 125% of VM size (1.25Ã— PF).">i</span></label>
              <select id="w-r5stripe-${id}" class="sel" onchange="syncRaidFttOptions('w',${id});recalculate()">
                <option value="4p1" selected>4+1 â€” 6 hosts, 1.25Ã—</option>
                <option value="2p1">2+1 â€” 3 hosts, 1.5Ã—</option>
              </select>
            </div>
            </div><!-- /w-vsan-policy-fields -->
            <div><label class="lbl">Compute Reserve %</label>
              <select id="w-reserve-${id}" class="sel" onchange="recalculate()">
                <option value="15">15%</option><option value="20">20%</option><option value="25">25%</option><option value="30" selected>30%</option>
              </select>
            </div>
            <div id="w-vsan-stg-fields-${id}" style="display:contents">
            <div><label class="lbl">vSAN Free %</label><input type="number" id="w-free-${id}" value="30" min="0" max="50" class="inp" oninput="debouncedRecalc()"></div>
            <div><label class="lbl">Dedup Ratio</label><input type="number" id="w-dedupe-${id}" value="1" step="0.1" min="1" class="inp" oninput="debouncedRecalc()"></div>
            <div><label class="lbl">Compression</label><input type="number" id="w-comp-${id}" value="1" step="0.1" min="1" class="inp" oninput="debouncedRecalc()"></div>
            <div><label class="lbl">VM Swap Used %</label><input type="number" id="w-swapPct-${id}" value="100" step="5" min="0" max="200" class="inp" oninput="debouncedRecalc()"></div>
            </div><!-- /w-vsan-stg-fields -->
            <div><label class="lbl">Host Failures</label>
              <select id="w-fail-${id}" class="sel" onchange="recalculate()">
                <option value="0">0 (No redundancy)</option><option value="1" selected>N+1</option><option value="2">N+2</option>
              </select>
            </div>

          </div>
          <div id="w-policy-info-${id}" class="pi" style="margin-top:.5rem"></div>
        </div>
      </div>

      <!-- â”€â”€ NVMe Memory Tiering â€” full width â”€â”€ -->
      <div id="w-tier-section-${id}" style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bd2)">
        <div class="rb" style="margin-bottom:.5rem">
          <div class="row">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="color:var(--sky2)"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/></svg>
            <span style="font-size:12px;font-weight:800;letter-spacing:.06em;text-transform:uppercase;color:var(--sky2)">NVMe Memory Tiering</span>
            <span class="tip" title="VCF 9 Day-2. Dedicated NVMe tier below DRAM. DRAM:NVMe 1:1 to 1:4. Active mem â‰¤50% DRAM. Separate from vSAN.">i</span>
          </div>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:11px;font-weight:700;color:var(--t2);text-transform:uppercase;letter-spacing:.08em">
            <input type="checkbox" id="w-tier-on-${id}" onchange="toggleTierPanel(${id});recalculate()">
            Enable <span id="w-tier-badge-${id}" class="badge t-off" style="font-size:9px">Off</span>
          </label>
        </div>

        <div id="w-tier-panel-${id}" class="tier-panel off">
          <div class="g4" style="gap:.75rem;margin-bottom:.75rem">
            <!-- Col 1: Workload Profile -->
            <div class="col" style="gap:.5rem">
              <div class="lbl sky" style="margin-bottom:4px">Workload Profile</div>
              <div><label class="lbl">Eligible VMs %<span class="tip" title="Exclude Monster VMs, FT, SAP HANA, in-mem DBs.">i</span></label>
                <input type="number" id="w-tier-elig-${id}" value="80" min="0" max="100" step="5" class="inp" oninput="debouncedRecalc()">
              </div>
              <div><label class="lbl">Active Mem % of DRAM<span class="tip" title="Must be â‰¤50% for effective tiering.">i</span></label>
                <input type="number" id="w-tier-active-${id}" value="40" min="5" max="100" step="5" class="inp" oninput="debouncedRecalc()">
                <div id="w-tier-active-warn-${id}" class="wb red" style="font-size:10px"></div>
              </div>
            </div>
            <!-- Col 2: Tier Hardware -->
            <div class="col" style="gap:.5rem">
              <div class="lbl sky" style="margin-bottom:4px">Tier Hardware</div>
              <div><label class="lbl">DRAM:NVMe Ratio</label>
                <select id="w-tier-ratio-${id}" class="sel" onchange="recalculate()">
                  <option value="1">1:1</option><option value="2" selected>1:2 (default)</option><option value="3">1:3</option><option value="4">1:4 (max)</option>
                </select>
              </div>
              <div><label class="lbl">Tier Drive Size (TB)<span class="tip" title="Separate from vSAN. Partition capped at 4TB.">i</span></label>
                <input type="number" id="w-tier-nvme-size-${id}" value="2" min="0.5" max="16" step="0.5" class="inp" oninput="debouncedRecalc()">
              </div>
              <div><label class="lbl">Redundancy</label>
                <select id="w-tier-redund-${id}" class="sel" onchange="recalculate()">
                  <option value="1" selected>None (1 drive)</option><option value="2">HW RAID-1 (2)</option><option value="3">VROC RAID-5 (3)</option>
                </select>
              </div>
            </div>
            <!-- Col 3: Tier BOM -->
            <div class="sp-blue">
              <div class="lbl sky" style="margin-bottom:8px">Tier BOM</div>
              <div class="br"><span class="bk">Partition/host</span><span id="w-tier-part-${id}" class="bv hi">-- GB</span></div>
              <div class="br"><span class="bk">Eff. RAM/host</span><span id="w-tier-effram-${id}" class="bv hi">-- GB</span></div>
              <div class="br"><span class="bk">Drives/host</span><span id="w-tier-drvcount-${id}" class="bv">--</span></div>
              <div class="br"><span class="bk">Total drives</span><span id="w-tier-totdrv-${id}" class="bv">--</span></div>
              <div class="br"><span class="bk">Total tier cap</span><span id="w-tier-totcap-${id}" class="bv">-- TiB</span></div>
              <div class="br"><span class="bk">Pool</span><span class="bv wv">âš  separate from vSAN</span></div>
            </div>
            <!-- Col 4: Host Impact -->
            <div class="sp-em">
              <div class="lbl em" style="margin-bottom:8px">Host Impact</div>
              <div class="br"><span class="bk">Hosts w/o tiering</span><span id="w-tier-hosts-base-${id}" class="bv">--</span></div>
              <div class="br"><span class="bk">Hosts with tiering</span><span id="w-tier-hosts-tiered-${id}" class="bv hi">--</span></div>
              <div class="br"><span class="bk">Hosts saved</span><span id="w-tier-saved-${id}" class="bv sv">--</span></div>
              <div class="br"><span class="bk">Ineligible demand</span><span id="w-tier-inelig-${id}" class="bv">-- GB</span></div>
              <div id="w-tier-warn-multidrv-${id}" class="wb amber" style="font-size:10px;margin-top:4px"></div>
              <div id="w-tier-warn-raid-${id}" class="wb amber" style="font-size:10px;margin-top:2px"></div>
            </div>
          </div>
          <div class="tiny" style="color:var(--t4)"><strong style="color:var(--t3)">VCF 9.0:</strong> Day-2 only. Effective RAM = DRAM Ã— (1+ratio). Partition max 4TB. Swap on provisioned DRAM.</div>
        </div>
      </div>

      <!-- WLD Infrastructure VMs -->
      <div style="margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--bd2)">
        <div class="sec-hdr" onclick="toggleSection('w-infra-${id}')" style="padding:.4rem .5rem;border-radius:var(--r2)">
          <div class="row" style="gap:6px">
            <span style="font-size:11px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;font-style:italic;color:#93c5fd">WLD Infrastructure VMs</span>
          </div>
          <svg id="w-infra-${id}-chev" width="12" height="12" viewBox="0 0 24 24" style="color:#93c5fd"><path d="M6 15l6-6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
        </div>
        <div id="w-infra-${id}" data-open="true" class="ox">
          <table class="vmstk">
            <thead>
              <tr>
                <th style="width:3rem;text-align:center">Inc</th>
                <th style="text-align:left">Component</th>
                <th style="text-align:center">Nodes</th>
                <th style="text-align:center">Size</th>
                <th class="th-vcpu" style="text-align:center">vCPU</th>
                <th class="th-ram"  style="text-align:center">RAM (GB)</th>
                <th class="th-disk" style="text-align:center">Disk (GB)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="text-align:center"><input type="checkbox" id="w-sup-inc-${id}" checked onchange="recalculate()"></td>
                <td><span class="comp-name">Supervisor/VKS</span></td>
                <td style="text-align:center"><input type="number" id="w-sup-nodes-${id}" value="3" min="0" class="inp" style="width:3.2rem;margin:0 auto;text-align:center" oninput="debouncedRecalc()"></td>
                <td style="text-align:center"><select id="w-sup-size-${id}" class="sel" style="width:4.2rem;margin:0 auto" onchange="recalculate()"><option value="tiny">Tiny</option><option value="small" selected>Small</option><option value="medium">Med</option><option value="large">Lrg</option></select></td>
                <td id="w-sup-v-${id}" class="num-val" style="color:#e2e8f0">--</td>
                <td id="w-sup-r-${id}" class="num-val" style="color:#e2e8f0">--</td>
                <td id="w-sup-d-${id}" class="num-val" style="color:var(--sky2)">--</td>
              </tr>
              <tr>
                <td style="text-align:center"><input type="checkbox" id="w-edge-inc-${id}" checked onchange="recalculate()"></td>
                <td><span class="comp-name">NSX Edge VMs</span></td>
                <td style="text-align:center"><input type="number" id="w-edge-nodes-${id}" value="2" min="0" class="inp" style="width:3.2rem;margin:0 auto;text-align:center" oninput="debouncedRecalc()"></td>
                <td style="text-align:center"><select id="w-edge-size-${id}" class="sel" style="width:4.2rem;margin:0 auto" onchange="recalculate()"><option value="s" selected>S</option><option value="m">M</option><option value="l">L</option><option value="xl">XL</option></select></td>
                <td id="w-edge-v-${id}" class="num-val" style="color:#e2e8f0">--</td>
                <td id="w-edge-r-${id}" class="num-val" style="color:#e2e8f0">--</td>
                <td id="w-edge-d-${id}" class="num-val" style="color:var(--sky2)">--</td>
              </tr>
              <tr>
                <td style="text-align:center"><input type="checkbox" id="w-c1-inc-${id}" checked onchange="recalculate()"></td>
                <td><span class="comp-name">Custom Group 1</span></td>
                <td style="text-align:center"><input type="number" id="w-c1-nodes-${id}" value="1" min="0" class="inp" style="width:3.2rem;margin:0 auto;text-align:center" oninput="debouncedRecalc()"></td>
                <td style="text-align:center"><select id="w-c1-size-${id}" class="sel" style="width:4.2rem;margin:0 auto" onchange="recalculate()"><option value="s" selected>S</option><option value="m">M</option><option value="l">L</option><option value="xl">XL</option></select></td>
                <td id="w-c1-v-${id}" class="num-val" style="color:#e2e8f0">--</td>
                <td id="w-c1-r-${id}" class="num-val" style="color:#e2e8f0">--</td>
                <td id="w-c1-d-${id}" class="num-val" style="color:var(--sky2)">--</td>
              </tr>
              <tr>
                <td style="text-align:center"><input type="checkbox" id="w-c2-inc-${id}" onchange="recalculate()"></td>
                <td><span class="comp-name">Custom Group 2</span></td>
                <td style="text-align:center"><input type="number" id="w-c2-nodes-${id}" value="1" min="0" class="inp" style="width:3.2rem;margin:0 auto;text-align:center" oninput="debouncedRecalc()"></td>
                <td style="text-align:center"><select id="w-c2-size-${id}" class="sel" style="width:4.2rem;margin:0 auto" onchange="recalculate()"><option value="s" selected>S</option><option value="m">M</option><option value="l">L</option><option value="xl">XL</option></select></td>
                <td id="w-c2-v-${id}" class="num-val" style="color:#e2e8f0">--</td>
                <td id="w-c2-r-${id}" class="num-val" style="color:#e2e8f0">--</td>
                <td id="w-c2-d-${id}" class="num-val" style="color:var(--sky2)">--</td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="4" style="text-align:right;letter-spacing:.1em;text-transform:uppercase;font-size:10px;color:var(--t3)">Active Totals</td>
                <td class="num-val" style="color:var(--sky2)" id="w-infra-tot-v-${id}">--</td>
                <td class="num-val" style="color:var(--sky2)" id="w-infra-tot-r-${id}">--</td>
                <td class="num-val" style="color:var(--em2)" id="w-infra-tot-d-${id}">--</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Summary table -->
      <div class="sp" style="margin-top:.75rem">
        <div class="rb" style="margin-bottom:8px">
          <div class="panel-title blue" style="border-bottom:none;padding-bottom:0;margin-bottom:0">WLD Summary</div>
          <div class="tiny mono" style="font-size:10px">PF tooltip: <span id="w-pf-tip-${id}" class="tip" title="--">i</span></div>
        </div>
        <div class="ox">
          <table class="atbl">
            <thead>
              <tr>
                <th style="text-align:left;width:14%">Demand</th>
                <th style="text-align:left;width:16%">Hosts</th>
                <th style="text-align:left;width:13%">Licensing</th>
                <th style="text-align:left;width:39%">ESA Storage</th>
                <th style="text-align:left;width:18%">âš¡ NVMe Tier</th>
              </tr>
            </thead>
            <tbody class="mono" style="font-size:11px">
              <tr>
                <td>
                  <div class="sr"><span class="sk">vCPU</span><span id="w-dem-v-${id}" class="sv w">--</span></div>
                  <div class="sr"><span class="sk">RAM (GB)</span><span id="w-dem-r-${id}" class="sv w">--</span></div>
                  <div class="sr"><span class="sk">Eff. RAM</span><span id="w-dem-r-eff-${id}" class="sv am">--</span></div>
                  <div class="sr"><span class="sk">Disk (GB)</span><span id="w-dem-d-${id}" class="sv sky">--</span></div>
                </td>
                <td>
                  <div class="sr"><span class="sk">Final</span><span id="w-hosts-${id}" class="sv sky">--</span></div>
                  <div class="sr"><span class="sk">Limiter</span><span id="w-limiter-${id}" class="lm">--</span></div>
                  <div class="sr"><span class="sk">CPU/Mem</span><span id="w-hosts-cm-${id}" class="sv">--</span></div>
                  <div class="sr"><span class="sk">Storage</span><span id="w-hosts-stg-${id}" class="sv">--</span></div>
                  <div class="sr"><span class="sk">Policy Min</span><span id="w-policy-min-${id}" class="sv">--</span></div>
                </td>
                <td>
                  <div class="sr"><span class="sk">Cores</span><span id="w-cores-${id}" class="sv sky">--</span></div>
                  <div class="sr"><span class="sk">Raw (TiB)</span><span id="w-raw-${id}" class="sv em">--</span></div>
                  <div class="sr"><span class="sk">DRR (DÃ—C)</span><span id="w-drr-${id}" class="sv">--</span></div>
                </td>
                <td id="w-esa-cell-${id}">
                  <div class="wf-bar-wrap" id="w-wf-bar-${id}" style="margin-bottom:6px"><div class="wf-seg wf-vm" id="w-wf-vm-${id}" style="width:20%"></div><div class="wf-seg wf-swap" id="w-wf-swap-${id}" style="width:10%"></div><div class="wf-seg wf-pf" id="w-wf-pf-${id}" style="width:30%"></div><div class="wf-seg wf-free" id="w-wf-free-${id}" style="width:20%"></div><div class="wf-seg wf-growth" id="w-wf-growth-${id}" style="width:20%"></div></div>
                  <table class="wf-table">
                    <tr>
                      <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(56,189,248,.7)"></span></td>
                      <td class="wf-td-label">VM Cap</td>
                      <td class="wf-td-val sky"><span id="w-esa-vmcap-${id}">--</span> GB</td>
                      <td class="wf-td-desc">Disk demand Ã· DRR</td>
                    </tr>
                    <tr>
                      <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(99,102,241,.7)"></span></td>
                      <td class="wf-td-label">+ Swap</td>
                      <td class="wf-td-val"><span id="w-esa-swap-${id}">--</span> GB</td>
                      <td class="wf-td-desc">VM RAM Ã— swap % â€” reserved for vMotion safety net</td>
                    </tr>
                    <tr class="wf-subtotal">
                      <td class="wf-td-dot"></td>
                      <td class="wf-td-label" style="color:var(--t3)">Interim Total</td>
                      <td class="wf-td-val" style="color:var(--t3)"><span id="w-esa-interim-${id}">--</span> GB</td>
                      <td class="wf-td-desc" style="color:rgba(148,163,184,.5)">VM + Swap before RAID overhead</td>
                    </tr>
                    <tr>
                      <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(251,191,36,.7)"></span></td>
                      <td class="wf-td-label">Ã— PF <span id="w-pf-inline-${id}" style="font-size:9px;color:var(--am2);font-weight:700">--</span></td>
                      <td class="wf-td-val em"><span id="w-esa-prot-${id}">--</span> GB</td>
                      <td class="wf-td-desc">vSAN RAID tax â€” the cost of your redundancy policy</td>
                    </tr>
                    <tr>
                      <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(52,211,153,.6)"></span></td>
                      <td class="wf-td-label">+ Free Reserve</td>
                      <td class="wf-td-val"><span id="w-esa-free-${id}">--</span> GB</td>
                      <td class="wf-td-desc">Headroom for resync, rebuilds &amp; spike absorption</td>
                    </tr>
                    <tr>
                      <td class="wf-td-dot"><span class="wf-dot" style="background:rgba(249,115,22,.7)"></span></td>
                      <td class="wf-td-label">+ Growth</td>
                      <td class="wf-td-val"><span id="w-esa-growth-${id}">--</span> GB</td>
                      <td class="wf-td-desc">Forward capacity buffer for data growth over time</td>
                    </tr>
                    <tr class="wf-subtotal">
                      <td class="wf-td-dot"></td>
                      <td class="wf-td-label" style="color:var(--t3)">Eff. Hosts</td>
                      <td class="wf-td-val" style="color:var(--t3)"><span id="w-eff-${id}">--</span></td>
                      <td class="wf-td-desc" style="color:rgba(148,163,184,.5)">N âˆ’ failed hosts (usable for storage)</td>
                    </tr>
                    <tr class="wf-result">
                      <td class="wf-td-dot"></td>
                      <td class="wf-td-label">Per Host Req.</td>
                      <td class="wf-td-val"><span id="w-esa-perhost-${id}">--</span> GB</td>
                      <td class="wf-td-desc" style="color:var(--t3)">Total Ã· effective hosts â€” drives storage host count</td>
                    </tr>
                    <tr>
                      <td class="wf-td-dot"></td>
                      <td class="wf-td-label" style="color:var(--t4)">Raw/Host</td>
                      <td class="wf-td-val" style="color:#fff"><span id="w-raw-perhost-${id}">--</span> GB</td>
                      <td class="wf-td-desc">Actual raw NVMe capacity per host from spec above</td>
                    </tr>
                  </table>
                </td>
                <td id="w-ext-badge-${id}" style="display:none;vertical-align:middle">
                  <div class="ext-storage-badge">ðŸ”Œ External Array</div>
                  <div style="margin-top:8px;font-size:10px;color:var(--t4);line-height:1.5">
                    <div id="w-ext-vendor-display-${id}" style="font-weight:700;color:#c084fc;margin-bottom:4px"></div>
                    <div><span style="color:var(--t4)">Est. capacity</span></div>
                    <div id="w-ext-tib-display-${id}" style="font-weight:700;color:#fff">-- TiB</div>
                    <div style="margin-top:6px;color:rgba(216,180,254,.5);font-size:9px;line-height:1.4">Host count driven by<br>compute &amp; memory only</div>
                  </div>
                </td>
                <td>
                  <div class="sr"><span class="sk">Status</span><span id="ws-tier-status-${id}" class="sv" style="color:var(--t4)">Disabled</span></div>
                  <div class="sr"><span class="sk">Ratio</span><span id="ws-tier-ratio-${id}" class="sv" style="color:var(--t4)">--</span></div>
                  <div class="sr"><span class="sk">Eff.RAM/host</span><span id="ws-tier-effram-${id}" class="sv sky">--</span></div>
                  <div class="sr"><span class="sk">Partition</span><span id="ws-tier-part-${id}" class="sv">--</span></div>
                  <div class="sr"><span class="sk">Drives/host</span><span id="ws-tier-drv-${id}" class="sv">--</span></div>
                  <div class="sr" style="border-top:1px solid var(--bd2);padding-top:4px;margin-top:3px"><span class="sk">Hosts saved</span><span id="ws-tier-saved-${id}" class="sv em">--</span></div>
                </td>
                <!-- Hidden spans for export report grade data -->
                <span id="w-eff-grade-${id}" style="display:none">--</span>
                <span id="w-eff-score-${id}" style="display:none">-- / 100</span>
                <span id="w-eff-reason-${id}" style="display:none">--</span>
                <span id="w-gauge-arc-${id}" style="display:none"></span>
                <span id="w-gauge-pct-${id}" style="display:none"></span>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="tiny" style="margin-top:5px">Protected=(VM Cap+Swap)Ã—PF. Util=worst-case CPU/Mem/Stg. vSAN policy min always enforced. Tier NVMe = separate pool. Â· <a href="https://vmtechie.blog" target="_blank" style="color:inherit;opacity:.7;text-decoration:none">vmtechie.blog</a></div>
      </div>
    </div>`;

  container.appendChild(div);
  // Apply sequential colour theme on creation
  wldMeta[id] = { envKey: null, palIdx: (id-1) % WLD_PALETTE.length };
  wldStorageMode[id] = 'vsan';
  applyWldTheme(id);
  applyStorageModeUI(id);
  syncRaidFttOptions('w', id);
  syncEmptyState();
  recalculate();
}

function removeWLD(id) {
  const cards = document.querySelectorAll('.wld-card');
  if (cards.length <= 1) {
    const el = document.getElementById(`wld-${id}`);
    if (el) { el.style.outline='2px solid rgba(239,68,68,.6)'; setTimeout(()=>el.style.outline='',800); }
    return;
  }
  const el = document.getElementById(`wld-${id}`);
  if (el) el.remove();
  syncEmptyState();
  recalculate();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEALTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function healthFromUtil(u) {
  if (u >= 0.95) return { label:'Critical', cls:'badge b-hot'  };
  if (u >= 0.85) return { label:'Tight',    cls:'badge b-warn' };
  if (u >= 0.60) return { label:'Healthy',  cls:'badge b-ok'   };
  return               { label:'Oversized', cls:'badge b-over' };
}
function applyLimClass(el, lim) {
  if (!el) return;
  el.classList.remove('lc','lm','ls');
  if (lim==='Compute') el.classList.add('lc');
  else if (lim==='Memory') el.classList.add('lm');
  else el.classList.add('ls');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALC MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcMgmt() {
  const mCpuQty      = Math.max(1, clampNum(document.getElementById('m-cpuQty').value, 2));
  const mCoresPerCpu = Math.max(1, clampNum(document.getElementById('m-coresPerCpu').value, 16));
  const mHostCores   = mCpuQty * mCoresPerCpu;
  const mHostRAM     = Math.max(1, clampNum(document.getElementById('m-ram').value, 1024));
  const mNvQty       = Math.max(0, clampNum(document.getElementById('m-nvme-qty').value, 6));
  const mNvTB        = Math.max(0, clampNum(document.getElementById('m-nvme-size').value, 7.68));
  const rawGBperHost = mNvQty * mNvTB * TB_TO_GB;

  const mCpuSub     = Math.max(1, clampNum(document.getElementById('m-cpu-sub').value, 2));
  const mMemSub     = Math.max(1, clampNum(document.getElementById('m-ram-sub').value, 1));
  const mReservePct = clampNum(document.getElementById('m-reserve').value, 30);
  const mReserveFact = (100 - mReservePct) / 100;

  const mRaid    = document.getElementById('m-raid').value;
  const mFtt     = document.getElementById('m-ftt').value;
  const mDedupe  = Math.max(1, clampNum(document.getElementById('m-dedupe').value, 1.2));
  const mComp    = Math.max(1, clampNum(document.getElementById('m-comp').value, 1.2));
  const mDrr     = mDedupe * mComp;
  const mFreePct  = clampNum(document.getElementById('m-free').value, 30) / 100;
  const mSwapPct  = 1.0; // fixed 100% for mgmt
  const mGrowthPct = Math.max(0, clampNum(document.getElementById('m-growth').value, 10)) / 100;

  const userMinHosts = Math.max(1, clampNum(document.getElementById('m-min-hosts').value, 4));

  const mg = mgmtTotals();
  const usableVcpuPerHost = Math.max(1, mHostCores * mCpuSub * mReserveFact);
  const usableRamPerHost  = Math.max(1, mHostRAM * mMemSub * mReserveFact);

  const cpuHosts = Math.ceil(Math.max(1, mg.vcpu  / usableVcpuPerHost));
  const ramHosts = Math.ceil(Math.max(1, mg.ramGB / usableRamPerHost));

  // Read explicit RAID-5 stripe choice from selector
  const mStripe  = document.getElementById('m-r5stripe')?.value || '4p1';
  const esaMode  = getEsaMode(mRaid, mFtt, mStripe);
  const mPF      = esaMode.pf;
  const policyMin = esaMode.minHosts;
  const minMgmtHosts = Math.max(userMinHosts, policyMin);
  const hostsCM  = Math.max(cpuHosts, ramHosts, minMgmtHosts);

  if (isMgmtExt()) {
    // External storage: hosts driven by compute + memory only
    const mHosts   = Math.max(hostsCM);
    const failures = mHosts >= 4 ? 1 : 0;
    const extTiB   = parseFloat(document.getElementById('m-ext-tib')?.value) || 0;
    const mgmtCores  = mHosts * mHostCores;
    const mgmtRawTiB = extTiB;
    const dummyTotals = { interimGB:0, protectedGB:0, withFreeGB:0, withGrowthGB:0 };
    const dummyPer    = { eff: mHosts - failures, perHostGB:0 };
    let limiter = 'Compute';
    if (ramHosts > cpuHosts) limiter = 'Memory';
    return {
      mHosts, mHostCores, mHostRAM, mNvQty, mNvTB, rawGBperHost,
      mCpuSub, mMemSub, mReserveFact, mgmtCores, mgmtRawTiB,
      limiter, cpuHosts, ramHosts, hostsCM, stgHosts:0, failures,
      usableVcpuPerHost, usableRamPerHost,
      vmCapGB:0, swapGB:0, totals:dummyTotals, per:dummyPer, mPF:1, mg,
      extMode:true, extTiB,
    };
  }

  const vmCapGB = mg.diskGB / mDrr;
  const swapGB  = mg.ramGB  * mSwapPct;
  const totals  = esaStorageTotals({ vmCapacityGB:vmCapGB, swapGB, pf:mPF, freeSpacePct:mFreePct, growthPct:mGrowthPct });

  const failures = hostsCM >= 4 ? 1 : 0;
  const stgHosts = Math.max(minMgmtHosts, Math.ceil((totals.withGrowthGB / rawGBperHost) + failures));
  const mHosts   = Math.max(hostsCM, stgHosts);

  let limiter = 'Compute';
  if (ramHosts > cpuHosts)  limiter = 'Memory';
  if (stgHosts >= hostsCM)  limiter = 'Storage';

  const mgmtCores  = mHosts * mHostCores;
  const mgmtRawTiB = mHosts * mNvQty * mNvTB * TB_TO_TIB;
  const per = esaPerHost({ withGrowthGB:totals.withGrowthGB, nHosts:mHosts, failures });

  return {
    mHosts, mHostCores, mHostRAM, mNvQty, mNvTB, rawGBperHost,
    mCpuSub, mMemSub, mReserveFact, mgmtCores, mgmtRawTiB,
    limiter, cpuHosts, ramHosts, hostsCM, stgHosts, failures,
    usableVcpuPerHost, usableRamPerHost, vmCapGB, swapGB, totals, per, mPF, mg,
    extMode:false,
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALC WLD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcWLD(id, mgmt) {
  // Per-WLD host spec (independent from mgmt)
  const wCpuQty      = Math.max(1, clampNum(document.getElementById(`w-cpuQty-${id}`).value, 2));
  const wCoresPerCpu = Math.max(1, clampNum(document.getElementById(`w-coresPerCpu-${id}`).value, 16));
  const wHostCores   = wCpuQty * wCoresPerCpu;
  const wHostRAM     = Math.max(1, clampNum(document.getElementById(`w-ram-${id}`).value, 1024));
  const wNvQty       = Math.max(0, clampNum(document.getElementById(`w-nvme-qty-${id}`).value, 6));
  const wNvTB        = Math.max(0, clampNum(document.getElementById(`w-nvme-size-${id}`).value, 7.68));
  const rawGBperHost = wNvQty * wNvTB * TB_TO_GB;

  const vms  = Math.max(0, clampNum(document.getElementById(`w-vms-${id}`).value, 100));
  const vPer = Math.max(1, clampNum(document.getElementById(`w-vcpu-vm-${id}`).value, 4));
  const rPer = Math.max(1, clampNum(document.getElementById(`w-ram-vm-${id}`).value, 16));
  const dPer = Math.max(1, clampNum(document.getElementById(`w-disk-vm-${id}`).value, 250));
  const growthPct = Math.max(0, clampNum(document.getElementById(`w-growth-${id}`).value, 10)) / 100;

  const wCpuSub    = Math.max(1, clampNum(document.getElementById(`w-cpu-sub-${id}`).value, 2));
  const wRamSub    = Math.max(1, clampNum(document.getElementById(`w-ram-sub-${id}`).value, 1));
  const reservePct = clampNum(document.getElementById(`w-reserve-${id}`).value, 30);
  const reserveFact = (100 - reservePct) / 100;

  const wRaid    = document.getElementById(`w-raid-${id}`).value;
  const wFtt     = document.getElementById(`w-ftt-${id}`).value;

  const freePct    = clampNum(document.getElementById(`w-free-${id}`).value, 30) / 100;
  const wDedupe    = Math.max(1, clampNum(document.getElementById(`w-dedupe-${id}`)?.value, 1));
  const wComp      = Math.max(1, clampNum(document.getElementById(`w-comp-${id}`)?.value, 1));
  const drr        = wDedupe * wComp;
  const swapPct    = Math.max(0, clampNum(document.getElementById(`w-swapPct-${id}`).value, 100)) / 100;
  const failuresW  = Math.max(0, clampNum(document.getElementById(`w-fail-${id}`).value, 1));
  const growthPct2 = 0; // Removed â€” Storage Growth % (w-growth) is the single growth input
  const userMinW   = 1; // Min Hosts removed â€” policy ESA minimum is the only floor

  const supSpec  = wldVmMap.vks[document.getElementById(`w-sup-size-${id}`).value];
  const edgeSpec = wldVmMap.edge[document.getElementById(`w-edge-size-${id}`).value];
  const c1Spec   = wldVmMap.custom[document.getElementById(`w-c1-size-${id}`).value];
  const c2Spec   = wldVmMap.custom[document.getElementById(`w-c2-size-${id}`).value];

  const supInc    = document.getElementById(`w-sup-inc-${id}`).checked;
  const supNodes  = Math.max(0, clampNum(document.getElementById(`w-sup-nodes-${id}`).value, 3));
  const edgeInc   = document.getElementById(`w-edge-inc-${id}`).checked;
  const edgeNodes = Math.max(0, clampNum(document.getElementById(`w-edge-nodes-${id}`).value, 2));
  const c1Inc     = document.getElementById(`w-c1-inc-${id}`).checked;
  const c1Nodes   = Math.max(0, clampNum(document.getElementById(`w-c1-nodes-${id}`).value, 1));
  const c2Inc     = document.getElementById(`w-c2-inc-${id}`).checked;
  const c2Nodes   = Math.max(0, clampNum(document.getElementById(`w-c2-nodes-${id}`).value, 1));

  const infraV = (supInc?supSpec[0]*supNodes:0)+(edgeInc?edgeSpec[0]*edgeNodes:0)+(c1Inc?c1Spec[0]*c1Nodes:0)+(c2Inc?c2Spec[0]*c2Nodes:0);
  const infraR = (supInc?supSpec[1]*supNodes:0)+(edgeInc?edgeSpec[1]*edgeNodes:0)+(c1Inc?c1Spec[1]*c1Nodes:0)+(c2Inc?c2Spec[1]*c2Nodes:0);
  const infraD = (supInc?supSpec[2]*supNodes:0)+(edgeInc?edgeSpec[2]*edgeNodes:0)+(c1Inc?c1Spec[2]*c1Nodes:0)+(c2Inc?c2Spec[2]*c2Nodes:0);

  const demandV = (vms*vPer) + infraV;
  const demandR = (vms*rPer) + infraR;
  const demandD = (vms*dPer) + infraD;

  // Baseline compute hosts (no tiering yet) â€” needed to resolve RAID-5 stripe
  const usableVcpu    = Math.max(1, wHostCores * wCpuSub * reserveFact);
  const usableRamBase = Math.max(1, wHostRAM * wRamSub * reserveFact);
  const cpuHostsBase  = Math.ceil(Math.max(1, demandV / usableVcpu));
  const ramHostsBase  = Math.ceil(Math.max(1, demandR / usableRamBase));
  const projectedW    = Math.max(cpuHostsBase, ramHostsBase, userMinW);

  // Read explicit RAID-5 stripe choice from selector
  const wStripe    = document.getElementById(`w-r5stripe-${id}`)?.value || '4p1';
  const esaMode    = getEsaMode(wRaid, wFtt, wStripe);
  const pf         = esaMode.pf;
  const policyMinW = esaMode.minHosts;
  const minHostsW  = Math.max(userMinW, policyMinW);

  const extMode = isExtStorage(id);

  if (extMode) {
    // External storage: host count = compute + memory only
    const hostsBaseline = Math.max(cpuHostsBase, ramHostsBase, userMinW);
    const usableRamExt  = Math.max(1, wHostRAM * wRamSub * reserveFact);
    const cpuHosts2     = Math.ceil(Math.max(1, demandV / usableVcpu));
    const ramHosts2     = Math.ceil(Math.max(1, demandR / usableRamExt));
    const hosts         = Math.max(cpuHosts2, ramHosts2, userMinW);
    let lim = 'Compute'; if (ramHosts2 > cpuHosts2) lim = 'Memory';
    const cpuUtil = demandV / (hosts * usableVcpu);
    const memUtil = demandR / (hosts * usableRamExt);
    const util    = Math.max(cpuUtil, memUtil);
    const wCores  = hosts * wHostCores;
    const extTiB  = parseFloat(document.getElementById(`w-ext-tib-${id}`)?.value) || 0;
    const wRawTiB = extTiB; // user-supplied, not calculated
    // Stub ESA values so DOM updates don't crash
    const dummyTotals = { interimGB:0, protectedGB:0, withFreeGB:0, withGrowthGB:0 };
    const dummyPer    = { eff: hosts - failuresW, perHostGB: 0 };
    const tier = { tierOn:false, effectiveDemandR:demandR, effectiveHostRAM:wHostRAM, drivesPerHost:0, partitionGB:0, partCapHit:false, nvmeRatio:1, ineligDemand:0, activeWarn:false };
    return {
      hosts, hostsBaseline, cpuHosts2, ramHosts2, hostsCM2:hosts, stgHosts2:0,
      lim, util, wCores, wRawTiB, wHostCores, wHostRAM, wNvQty, wNvTB, rawGBperHost,
      demandV, demandR, effectiveDemandR:demandR, demandD,
      vmCapGB2:0, swapGB2:0, totals2:dummyTotals, per2:dummyPer, pf:1, drr,
      usableVcpu, usableRam:usableRamExt,
      supSpec, edgeSpec, c1Spec, c2Spec,
      policyMinW:userMinW, minHostsW:userMinW, tier,
      extMode:true, extTiB,
    };
  }

  const vmCapBase  = demandD / drr;
  const swapBase   = demandR * swapPct;
  const totBase    = esaStorageTotals({ vmCapacityGB:vmCapBase, swapGB:swapBase, pf, freeSpacePct:freePct, growthPct:growthPct+growthPct2 });
  const stgBase    = Math.max(minHostsW, Math.ceil((totBase.withGrowthGB / rawGBperHost) + failuresW));
  const hostsBaseline = Math.max(cpuHostsBase, ramHostsBase, minHostsW, stgBase);

  // NVMe tiering
  const tier = calcTiering(id, wHostRAM, demandR, hostsBaseline);
  const effectiveDemandR = tier.effectiveDemandR;
  const effectiveHostRAM = tier.tierOn ? tier.effectiveHostRAM : wHostRAM;
  const usableRamTiered  = Math.max(1, effectiveHostRAM * wRamSub * reserveFact);

  const cpuHosts2 = Math.ceil(Math.max(1, demandV          / usableVcpu));
  const ramHosts2 = Math.ceil(Math.max(1, effectiveDemandR / usableRamTiered));
  const hostsCM2  = Math.max(cpuHosts2, ramHosts2, minHostsW);

  const vmCapGB2  = demandD / drr;
  const swapGB2   = demandR * swapPct;
  const totals2   = esaStorageTotals({ vmCapacityGB:vmCapGB2, swapGB:swapGB2, pf, freeSpacePct:freePct, growthPct:growthPct+growthPct2 });
  const stgHosts2 = Math.max(minHostsW, Math.ceil((totals2.withGrowthGB / rawGBperHost) + failuresW));
  const hosts     = Math.max(hostsCM2, stgHosts2);

  let lim = 'Compute';
  if (ramHosts2 > cpuHosts2)  lim = 'Memory';
  if (stgHosts2 >= hostsCM2)  lim = 'Storage';

  const cpuUtil = demandV          / (hosts * usableVcpu);
  const memUtil = effectiveDemandR / (hosts * usableRamTiered);
  const stgUtil = totals2.withGrowthGB / (hosts * rawGBperHost);
  const util    = Math.max(cpuUtil, memUtil, stgUtil);

  const wCores  = hosts * wHostCores;
  const wRawTiB = hosts * wNvQty * wNvTB * TB_TO_TIB;
  const per2    = esaPerHost({ withGrowthGB:totals2.withGrowthGB, nHosts:hosts, failures:failuresW });

  return {
    hosts, hostsBaseline, cpuHosts2, ramHosts2, hostsCM2, stgHosts2,
    lim, util, wCores, wRawTiB, wHostCores, wHostRAM, wNvQty, wNvTB, rawGBperHost,
    demandV, demandR, effectiveDemandR, demandD,
    vmCapGB2, swapGB2, totals2, per2, pf, drr,
    usableVcpu, usableRam:usableRamTiered,
    supSpec, edgeSpec, c1Spec, c2Spec,
    policyMinW, minHostsW, tier, extMode:false,
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPDATE DOM â€” MGMT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateMgmtDOM(r) {
  // Animated host visualiser
  renderHostViz('m-visualizer', r.mHosts, 'mgmt');

  const mLimEl = document.getElementById('m-limiter');
  if (mLimEl) { mLimEl.innerText=r.limiter; applyLimClass(mLimEl,r.limiter); }

  const set = (id,v) => { const el=document.getElementById(id); if(el) el.innerText=v; };
  set('m-dem-v', r.mg.vcpu);
  set('m-dem-r', r.mg.ramGB);
  set('m-cap-v', Math.round(r.usableVcpuPerHost));
  set('m-cap-r', Math.round(r.usableRamPerHost));
  set('m-hosts-cpu', r.cpuHosts);
  set('m-hosts-ram', r.ramHosts);
  set('m-hosts',     r.mHosts);
  set('m-hosts-stg', r.stgHosts);
  set('m-coresOut',  r.mgmtCores);
  set('m-rawOut',    r.mgmtRawTiB.toFixed(1));
  if (!r.extMode) {
    set('m-esa-pf',    r.mPF.toFixed(2));
    set('m-esa-vmcap', r.vmCapGB.toFixed(0));
    set('m-esa-swap',  r.swapGB.toFixed(0));
    set('m-esa-interim', r.totals.interimGB.toFixed(0));
    set('m-esa-prot',  r.totals.protectedGB.toFixed(0));
    set('m-esa-free',  (r.totals.withFreeGB - r.totals.protectedGB).toFixed(0));
    set('m-esa-growth',(r.totals.withGrowthGB - r.totals.withFreeGB).toFixed(0));
    set('m-esa-effhosts', r.per.eff);
    set('m-esa-perhost',  r.per.perHostGB.toFixed(0));
    set('m-raw-perhost',  r.rawGBperHost.toFixed(0));
    updateWaterfallBar('m', r.vmCapGB, r.swapGB, r.totals.protectedGB, r.totals.withFreeGB, r.totals.withGrowthGB);
  } else {
    // External mode: show vendor + TiB in cluster analysis row
    const vendor = document.getElementById('m-ext-vendor')?.value?.trim() || '';
    const tib    = document.getElementById('m-ext-tib')?.value?.trim()    || '--';
    set('m-ext-vendor-display', vendor || 'External Array');
    set('m-ext-tib-display',    tib === '--' ? '--' : tib);
  }
  // Update collapsed summary badge
  const mb = (eid,v) => { const e=document.getElementById(eid); if(e) e.innerText=v; };
  mb('m-badge-hosts', r.mHosts);
  mb('m-badge-cores', r.mgmtCores);
  mb('m-badge-tib',   r.extMode ? (r.extTiB || '--') : r.mgmtRawTiB.toFixed(1));
  // Apply storage mode UI each render
  applyMgmtStorageModeUI();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPDATE DOM â€” WLD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateWldDOM(id, r) {
  const set = (eid,v) => { const el=document.getElementById(eid); if(el) el.innerText=v; };

  const infraSpecs = [r.supSpec,r.edgeSpec,r.c1Spec,r.c2Spec];
  const infraIncs  = [
    document.getElementById(`w-sup-inc-${id}`)?.checked,
    document.getElementById(`w-edge-inc-${id}`)?.checked,
    document.getElementById(`w-c1-inc-${id}`)?.checked,
    document.getElementById(`w-c2-inc-${id}`)?.checked
  ];
  const infraNds = [
    Math.max(0,parseInt(document.getElementById(`w-sup-nodes-${id}`)?.value)||0),
    Math.max(0,parseInt(document.getElementById(`w-edge-nodes-${id}`)?.value)||0),
    Math.max(0,parseInt(document.getElementById(`w-c1-nodes-${id}`)?.value)||0),
    Math.max(0,parseInt(document.getElementById(`w-c2-nodes-${id}`)?.value)||0)
  ];
  ['sup','edge','c1','c2'].forEach((k,i) => {
    const spec=infraSpecs[i];
    set(`w-${k}-v-${id}`,spec[0]); set(`w-${k}-r-${id}`,spec[1]); set(`w-${k}-d-${id}`,spec[2]);
  });
  // Infra totals tfoot
  const iTV = infraSpecs.reduce((a,s,i)=>a+(infraIncs[i]?s[0]*infraNds[i]:0),0);
  const iTR = infraSpecs.reduce((a,s,i)=>a+(infraIncs[i]?s[1]*infraNds[i]:0),0);
  const iTD = infraSpecs.reduce((a,s,i)=>a+(infraIncs[i]?s[2]*infraNds[i]:0),0);
  set(`w-infra-tot-v-${id}`, iTV);
  set(`w-infra-tot-r-${id}`, iTR);
  set(`w-infra-tot-d-${id}`, iTD.toLocaleString());

  const tip = document.getElementById(`w-pf-tip-${id}`);
  if (tip) tip.title = `PF = ${r.pf.toFixed(2)} | Protected = (VM Cap + Swap) Ã— ${r.pf.toFixed(2)}`;

  const health = healthFromUtil(r.util);
  const healthEl = document.getElementById(`w-health-${id}`);
  if (healthEl) { healthEl.className=health.cls; healthEl.innerText=health.label; }

  const utilPct = Math.max(0,Math.min(1,r.util))*100;
  const bar = document.getElementById(`w-util-bar-${id}`);
  if (bar) {
    bar.style.width = utilPct.toFixed(0)+'%';
    bar.classList.remove('tight','hot');
    if (r.util>=0.95) bar.classList.add('hot');
    else if (r.util>=0.80) bar.classList.add('tight');
  }
  const utilTxt = document.getElementById(`w-util-pct-${id}`);
  if (utilTxt) {
    utilTxt.innerText = utilPct.toFixed(0)+'%';
    // Colour the util % text with WLD accent
    const wc = wldColor(id);
    utilTxt.style.color = utilPct >= 95 ? '#ef4444' : utilPct >= 88 ? '#f59e0b' : wc.hex;
  }

  // host viz handled by renderHostViz() at end of function

  const hostsWarnEl = document.getElementById(`w-hosts-warn-${id}`);
  // Min Hosts field removed â€” policy minimum is always shown via policy-info banner
  if (hostsWarnEl) hostsWarnEl.classList.remove('show');

  set(`w-dem-v-${id}`,     r.demandV);
  set(`w-dem-r-${id}`,     r.demandR);
  set(`w-dem-r-eff-${id}`, Math.round(r.effectiveDemandR));
  set(`w-dem-d-${id}`,     r.demandD);
  set(`w-hosts-${id}`,     r.hosts);
  set(`w-hosts-cm-${id}`,  r.hostsCM2);
  set(`w-hosts-stg-${id}`, r.stgHosts2);
  set(`w-policy-min-${id}`,r.policyMinW);

  const limEl = document.getElementById(`w-limiter-${id}`);
  if (limEl) { limEl.innerText=r.lim; applyLimClass(limEl,r.lim); }

  set(`w-cores-${id}`,      r.wCores);
  set(`w-raw-${id}`,        r.wRawTiB.toFixed(1));
  set(`w-drr-${id}`,        r.drr.toFixed(2));
  // Apply storage mode UI (toggle visible sections)
  applyStorageModeUI(id);

  if (!r.extMode) {
    set(`w-esa-vmcap-${id}`,  r.vmCapGB2.toFixed(0));
    set(`w-esa-swap-${id}`,   r.swapGB2.toFixed(0));
    set(`w-esa-interim-${id}`, r.totals2.interimGB.toFixed(0));
    set(`w-esa-prot-${id}`,   r.totals2.protectedGB.toFixed(0));
    set(`w-esa-free-${id}`,   (r.totals2.withFreeGB - r.totals2.protectedGB).toFixed(0));
    set(`w-esa-growth-${id}`, (r.totals2.withGrowthGB - r.totals2.withFreeGB).toFixed(0));
    set(`w-pf-inline-${id}`,  `Ã—${r.pf.toFixed(2)}`);
    set(`w-eff-${id}`,        r.per2.eff);
    set(`w-esa-perhost-${id}`,r.per2.perHostGB.toFixed(0));
    set(`w-raw-perhost-${id}`,r.rawGBperHost.toFixed(0));
  } else {
    // External mode: show vendor + TiB in badge
    const vendor = document.getElementById(`w-ext-vendor-${id}`)?.value?.trim() || '';
    const tib    = document.getElementById(`w-ext-tib-${id}`)?.value?.trim()   || '--';
    set(`w-ext-vendor-display-${id}`, vendor || 'External Array');
    set(`w-ext-tib-display-${id}`,    tib === '--' ? '-- TiB' : `${tib} TiB`);
  }

  // Tiering DOM
  const t = r.tier;
  toggleTierPanel(id);

  if (t.tierOn) {
    const hostsSaved = Math.max(0, r.hostsBaseline - r.hosts);
    const totalDrives = r.hosts * t.drivesPerHost;
    const tierTiB = (totalDrives * t.tierDriveTB * TB_TO_TIB).toFixed(1);
    set(`w-tier-part-${id}`,       `${t.partitionGB.toFixed(0)} GB`);
    set(`w-tier-effram-${id}`,     `${t.effectiveHostRAM.toFixed(0)} GB`);
    set(`w-tier-drvcount-${id}`,   `${t.drivesPerHost}${t.drivesPerHost>1?' (RAID)':''}`);
    set(`w-tier-totdrv-${id}`,     `${totalDrives} drives`);
    set(`w-tier-totcap-${id}`,     `${tierTiB} TiB`);
    set(`w-tier-hosts-base-${id}`, `${r.hostsBaseline}`);
    set(`w-tier-hosts-tiered-${id}`,`${r.hosts}`);
    set(`w-tier-saved-${id}`,      hostsSaved>0?`â†“ ${hostsSaved}`:'none');
    set(`w-tier-inelig-${id}`,     `${Math.round(t.ineligDemand)} GB`);

    const aw = document.getElementById(`w-tier-active-warn-${id}`);
    if (aw) { if(t.activeWarn){aw.classList.add('show');aw.innerText=`âš  Active mem (${Math.round(t.activePct*100)}%) > 50% of DRAM â€” tiering benefit reduced`;}else aw.classList.remove('show'); }
    const md = document.getElementById(`w-tier-warn-multidrv-${id}`);
    if (md) { if(t.drivesPerHost>1){md.classList.add('show');md.innerText='â„¹ RAID requires separate HBA/controller from vSAN ESA';}else md.classList.remove('show'); }
    const rc = document.getElementById(`w-tier-warn-raid-${id}`);
    if (rc) { if(t.partCapHit){rc.classList.add('show');rc.innerText='â„¹ Partition capped at 4 TB (VCF 9.0 limit)';}else rc.classList.remove('show'); }

    set(`ws-tier-status-${id}`, 'âœ“ Active');
    set(`ws-tier-ratio-${id}`,  `1:${t.nvmeRatio}`);
    set(`ws-tier-effram-${id}`, `${t.effectiveHostRAM.toFixed(0)} GB`);
    set(`ws-tier-part-${id}`,   `${t.partitionGB.toFixed(0)} GB`);
    set(`ws-tier-drv-${id}`,    `${t.drivesPerHost}`);
    set(`ws-tier-saved-${id}`,  hostsSaved>0?`â†“ ${hostsSaved}`:'0');

    const statusEl = document.getElementById(`ws-tier-status-${id}`);
    if (statusEl) statusEl.style.color = 'var(--sky2)';
    const savedEl = document.getElementById(`ws-tier-saved-${id}`);
    if (savedEl) savedEl.style.color = hostsSaved>0 ? 'var(--em2)' : 'var(--t4)';
  } else {
    ['w-tier-part','w-tier-effram','w-tier-drvcount','w-tier-totdrv','w-tier-totcap',
     'w-tier-hosts-base','w-tier-hosts-tiered','w-tier-saved','w-tier-inelig'].forEach(p=>{set(`${p}-${id}`,'--');});
    ['w-tier-active-warn','w-tier-warn-multidrv','w-tier-warn-raid'].forEach(p=>{
      const el=document.getElementById(`${p}-${id}`); if(el) el.classList.remove('show');
    });
    ['ws-tier-status','ws-tier-ratio','ws-tier-effram','ws-tier-part','ws-tier-drv','ws-tier-saved'].forEach(p=>{
      const el=document.getElementById(`${p}-${id}`);
      if(el){el.innerText='--';el.style.color='var(--t4)';}
    });
    const s=document.getElementById(`ws-tier-status-${id}`);
    if(s){s.innerText='Disabled';s.style.color='var(--t4)';}
  }

  // â”€â”€ Storage Efficiency Grade â”€â”€
  (function() {
    let score = 100;
    const reasons = [];

    // 1. Protection factor overhead (lower = more efficient)
    const pfScore = { 1.0:20, 1.25:18, 1.5:12, 2.0:5, 3.0:0, 4.0:0 };
    const pfPts = pfScore[r.pf] ?? 8;
    score = score - (20 - pfPts);
    if (r.pf >= 2.0) reasons.push('High PF overhead');

    // 2. DRR effectiveness (1.44=baseline, >2=good, >3=great)
    const drr = r.drr;
    const drrPts = drr >= 3.0 ? 20 : drr >= 2.0 ? 16 : drr >= 1.5 ? 12 : drr >= 1.2 ? 8 : 4;
    score = score - (20 - drrPts);
    if (drr < 1.2) reasons.push('Low DRR');

    // 3. Free space headroom (30% = ideal)
    const freePct = Math.max(0, clampNum(document.getElementById(`w-free-${id}`)?.value, 30));
    const freePts = (freePct >= 15 && freePct <= 35) ? 20 : freePct < 15 ? 5 : 12;
    score = score - (20 - freePts);
    if (freePct > 40) reasons.push('High free space %');
    if (freePct < 15) reasons.push('Low free space risk');

    // 4. Cluster utilisation (70-85% sweet spot)
    const util = r.util * 100;
    const utilPts = (util >= 65 && util <= 88) ? 20 : util > 95 ? 2 : util > 88 ? 14 : util < 40 ? 8 : 12;
    score = score - (20 - utilPts);
    if (util > 95) reasons.push('Over-utilised');
    if (util < 40) reasons.push('Under-utilised');

    // 5. Cluster size runway (hosts above policy min = runway for scale)
    const runway = r.hosts - r.policyMinW;
    const runPts = runway >= 4 ? 20 : runway >= 2 ? 16 : runway >= 1 ? 12 : 6;
    score = score - (20 - runPts);
    if (runway < 1) reasons.push('No host runway');

    score = Math.max(0, Math.min(100, Math.round(score)));
    const grade = score >= 90 ? 'A' : score >= 80 ? 'B' : score >= 70 ? 'C' : score >= 60 ? 'D' : 'F';
    const gradeColor = score >= 90 ? 'var(--em2)' : score >= 80 ? '#86efac' : score >= 70 ? 'var(--am2)' : score >= 60 ? 'var(--or2)' : 'var(--red2)';

    const ge = document.getElementById(`w-eff-grade-${id}`);
    const se = document.getElementById(`w-eff-score-${id}`);
    const re = document.getElementById(`w-eff-reason-${id}`);
    if (ge) { ge.innerText = grade; ge.style.color = gradeColor; }
    if (se) { se.innerText = `${score} / 100`; se.style.color = gradeColor; }
    if (re) { re.innerText = reasons.length ? reasons.join(' Â· ') : 'âœ“ Well sized'; re.style.color = reasons.length ? 'var(--am2)' : 'var(--em2)'; }
    // Confetti on first grade A
    if (grade === 'A' && ge && ge._lastGrade !== 'A') confettiBurst(ge);
    if (ge) ge._lastGrade = grade;
  })();

  // Update WLD collapsed summary badge
  const wb2 = (eid,v) => { const e=document.getElementById(eid); if(e) e.innerText=v; };
  wb2(`w-badge-hosts-${id}`, r.hosts);
  wb2(`w-badge-cores-${id}`, r.wCores);
  wb2(`w-badge-util-${id}`,  Math.round(r.util*100));
  // Animated host visualiser
  renderHostViz(`wld-viz-${id}`, r.hosts, 'wld', id);
  // Arc utilisation gauge
  updateGauge(id, r.util * 100);
  // Storage waterfall bar
  updateWaterfallBar(`w-${id}`, r.vmCapGB2, r.swapGB2, r.totals2.protectedGB, r.totals2.withFreeGB, r.totals2.withGrowthGB);
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUT VALIDATION HIGHLIGHTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function validateInputs() {
  // Validate mgmt inputs
  [
    ['m-cpuQty', v => v >= 1],
    ['m-coresPerCpu', v => v >= 1],
    ['m-ram', v => v >= 64],
    ['m-nvme-qty', v => v >= 1],
    ['m-nvme-size', v => v >= 0.5],
    ['m-free', v => v >= 5 && v <= 60],
    ['m-growth', v => v >= 0],
  ].forEach(([id, check]) => {
    const el = document.getElementById(id);
    if (!el) return;
    const v = parseFloat(el.value);
    el.classList.toggle('invalid', !check(v));
  });
  // Validate WLD inputs
  document.querySelectorAll('.wld-card').forEach(card => {
    const id = card.id.split('-')[1];
    [
      [`w-cpuQty-${id}`, v => v >= 1],
      [`w-coresPerCpu-${id}`, v => v >= 1],
      [`w-ram-${id}`, v => v >= 64],
      [`w-nvme-qty-${id}`, v => v >= 1],
      [`w-nvme-size-${id}`, v => v >= 0.5],
      [`w-vms-${id}`, v => v >= 0],
      [`w-free-${id}`, v => v >= 5 && v <= 60],
    ].forEach(([eid, check]) => {
      const el = document.getElementById(eid);
      if (!el) return;
      const val = parseFloat(el.value);
      el.classList.toggle('invalid', !check(val));
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN RECALCULATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function recalculate() {
  const mgmt = calcMgmt();
  updateMgmtDOM(mgmt);

  let fleetHosts=mgmt.mHosts, fleetCores=mgmt.mgmtCores, fleetRawTiB=mgmt.mgmtRawTiB, wldCores=0;

  const wldResultsArr = [];
  document.querySelectorAll('.wld-card').forEach(card => {
    const id = card.id.split('-')[1];
    const w  = calcWLD(id, mgmt);
    w.id = id;
    updateWldDOM(id, w);
    fleetHosts  += w.hosts;
    fleetCores  += w.wCores;
    fleetRawTiB += w.wRawTiB;
    wldCores    += w.wCores;
    wldResultsArr.push(w);
  });

  // Animated headline numbers
  animSet('sum-hosts',   fleetHosts);
  animSet('sum-cores',   fleetCores);
  animSet('sum-storage', fleetRawTiB.toFixed(1));
  // Update storage label based on whether any domains use ext storage
  const anyExt = isMgmtExt() || Object.values(wldStorageMode).some(m => m === 'ext');
  const storageLbl = document.getElementById('sum-storage-lbl');
  if (storageLbl) storageLbl.innerText = anyExt ? 'Fleet Storage (TiB)*' : 'vSAN Raw Total (TiB)';

  const entTiB   = fleetCores * 1.0;
  const addonTiB = Math.max(0, fleetRawTiB - entTiB);
  animSet('lic-mgmt', mgmt.mgmtCores);
  animSet('lic-wld',  wldCores);
  animSet('lic-ent',  entTiB.toFixed(0));
  animSet('lic-raw',  fleetRawTiB.toFixed(1));

  const addonEl = document.getElementById('lic-addon');
  if (addonEl) {
    const newAddon = addonTiB.toFixed(1);
    animSet('lic-addon', newAddon);
    addonEl.style.color = addonTiB > 0 ? 'var(--red)' : 'var(--em2)';
  }

  // Fleet topology diagram
  updateTopology(mgmt, wldResultsArr);
  validateInputs();

  // â”€â”€ External storage entitlement impact â”€â”€
  updateExtEntitlementWarn(mgmt, wldResultsArr);

  // Health banner
  updateHealthBanner(mgmt, wldResultsArr, fleetHosts);

  // Delta indicators on headline host count
  showDelta('sum-hosts', fleetHosts, '');

  // Empty state
  syncEmptyState();

  // Persist to localStorage (debounced via existing debouncedRecalc path)
  saveState();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET TO DEFAULTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function resetDefaults() {
  if (!confirm('Reset all inputs to default values? This will remove any workload domains you have added.')) return;

  // Mgmt host spec
  const setVal = (id, v) => { const el=document.getElementById(id); if(el) el.value=v; };
  setVal('m-cpuQty', 2);    setVal('m-coresPerCpu', 16); setVal('m-ram', 1024);
  setVal('m-nvme-qty', 6);  setVal('m-nvme-size', 7.68);
  setVal('m-cpu-sub', 2);   setVal('m-ram-sub', 1);      setVal('m-reserve', 30);
  setVal('m-free', 30);     setVal('m-dedupe', 1);        setVal('m-comp', 1);
  setVal('m-swapPct', 100); setVal('m-growth', 10);       setVal('m-fail', 1);
  setVal('m-min-hosts', 4); setVal('m-raid', 'raid5');    setVal('m-ftt', 1);
  setVal('m-r5stripe', '2p1');

  // Reset VM components
  components.forEach(c => {
    c.active = !['nsx_gm','vcf_net','vcf_net_coll','id_broker'].includes(c.id);
    c.n = {sddc:1,vc_m:2,nsx_m:3,nsx_e:2,nsx_gm:3,avi_m:3,vc_w:1,nsx_w:3,
           ops_fm:1,vcf_ops:1,vcf_coll:3,vcf_auto:1,vcf_logs:3,vcf_net:3,
           vcf_net_coll:3,id_broker:2,custom1:1,custom2:1}[c.id] ?? c.n;
    if (c.type !== 'fixed') c.size = Object.keys(tshirtMap[c.type]||{})[0] || c.size;
  });
  // Re-set known good defaults for sizing
  ['vc_m','vc_w'].forEach(id => { const c=components.find(x=>x.id===id); if(c) c.size='s'; });
  ['nsx_m','nsx_w'].forEach(id => { const c=components.find(x=>x.id===id); if(c) c.size='m'; });

  // Clear all WLDs and add one fresh
  const container = document.getElementById('wld-container');
  if (container) container.innerHTML = '';
  wldCount = 0;

  // Clear WLD meta on reset
  Object.keys(wldMeta).forEach(k => delete wldMeta[k]);
  syncRaidFttOptions('m');
  renderInventory();
  localStorage.removeItem(LS_KEY);
  addWLD();
  syncEmptyState();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT REPORT â€” generates a clean printable HTML report
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportReport() {
  // Gather live data from DOM
  const g = id => document.getElementById(id);
  const t = (id, fb='--') => g(id)?.innerText?.trim() || fb;
  const v = (id, fb='') => g(id)?.value?.trim() || fb;

  // Fleet summary
  const fleetHosts   = t('sum-hosts');
  const fleetCores   = t('sum-cores');
  const fleetStorage = t('sum-storage');
  const licMgmt      = t('lic-mgmt');
  const licWld       = t('lic-wld');
  const licEnt       = t('lic-ent');
  const licRaw       = t('lic-raw');
  const licAddon     = t('lic-addon');

  // Mgmt cluster
  const mHosts   = t('m-hosts');
  const mCores   = t('m-coresOut');
  const mRaw     = t('m-rawOut');
  const mLimiter = t('m-limiter');
  const mDemV    = t('m-dem-v');
  const mDemR    = t('m-dem-r');
  const mPf      = t('m-esa-pf');
  const mProt    = t('m-esa-prot');
  const mPolicy  = g('m-policy-info')?.innerHTML || '';

  // WLD data
  const wldCards = document.querySelectorAll('.wld-card');
  let wldRows = '';
  let wldDetails = '';
  let wldNum = 0;
  wldCards.forEach(card => {
    const id = card.id.split('-')[1];
    wldNum++;
    const name    = v(`w-name-${id}`, `WLD #${id}`);
    const hosts   = t(`w-hosts-${id}`);
    const lim     = t(`w-limiter-${id}`);
    const cores   = t(`w-cores-${id}`);
    const raw     = t(`w-raw-${id}`);
    const grade   = t(`w-eff-grade-${id}`,'--');
    const score   = t(`w-eff-score-${id}`,'--');
    const reason  = t(`w-eff-reason-${id}`,'--');
    const health  = t(`w-health-${id}`,'--');
    const util    = t(`w-util-pct-${id}`,'--');
    const demV    = t(`w-dem-v-${id}`);
    const demR    = t(`w-dem-r-${id}`);
    const demD    = t(`w-dem-d-${id}`);
    const vmCap   = t(`w-esa-vmcap-${id}`);
    const prot    = t(`w-esa-prot-${id}`);
    const perHost = t(`w-esa-perhost-${id}`);
    const rawPH   = t(`w-raw-perhost-${id}`);
    const policy  = g(`w-policy-info-${id}`)?.innerHTML || '';
    const tierOn  = g(`w-tier-on-${id}`)?.checked;
    const tierEffRam = t(`w-tier-effram-${id}`);
    const tierSaved  = t(`w-tier-saved-${id}`);
    const tierPart   = t(`w-tier-part-${id}`);
    const policyMin  = t(`w-policy-min-${id}`);

    const gradeColor = grade === 'A' ? '#16a34a' : grade === 'B' ? '#22c55e' : grade === 'C' ? '#ca8a04' : grade === 'D' ? '#ea580c' : '#dc2626';

    wldRows += `<tr>
      <td><strong>${name}</strong></td>
      <td style="text-align:center">${hosts}</td>
      <td style="text-align:center">${util}</td>
      <td style="text-align:center">${health}</td>
      <td style="text-align:center">${cores}</td>
      <td style="text-align:center">${raw} TiB</td>
      <td style="text-align:center;font-weight:900;color:${gradeColor};font-size:18px">${grade}</td>
      <td style="text-align:center;font-size:11px;color:#666">${score}<br><span style="font-size:9px">${reason}</span></td>
    </tr>`;

    wldDetails += `
    <div class="section">
      <h3 style="color:#1e3a8a;border-bottom:2px solid #bfdbfe;padding-bottom:6px;margin-bottom:12px">${name} â€” Detail</h3>
      <div class="policy-box">${policy.replace(/<strong[^>]*>/g,'<strong>').replace(/<\/strong>/g,'</strong>')}</div>
      <div class="grid3" style="margin-top:12px">
        <div class="stat-box">
          <div class="stat-label">Tenant Demand</div>
          <div class="stat-row"><span>vCPU</span><span>${demV}</span></div>
          <div class="stat-row"><span>RAM (GB)</span><span>${demR}</span></div>
          <div class="stat-row"><span>Disk (GB)</span><span>${demD}</span></div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ESA Storage</div>
          <div class="stat-row"><span>VM Cap (GB)</span><span>${vmCap}</span></div>
          <div class="stat-row"><span>Protected (GB)</span><span>${prot}</span></div>
          <div class="stat-row"><span>Per Host (GB)</span><span>${perHost}</span></div>
          <div class="stat-row"><span>Raw/Host (GB)</span><span>${rawPH}</span></div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Sizing Result</div>
          <div class="stat-row"><span>Final Hosts</span><span><strong>${hosts}</strong></span></div>
          <div class="stat-row"><span>Policy Min</span><span>${policyMin}</span></div>
          <div class="stat-row"><span>Limiter</span><span>${lim}</span></div>
          <div class="stat-row"><span>Utilisation</span><span>${util}</span></div>
          ${tierOn ? `<div class="stat-row" style="margin-top:6px;color:#0369a1"><span>âš¡ NVMe Tiering</span><span>Active</span></div>
          <div class="stat-row"><span>Eff. RAM/host</span><span>${tierEffRam}</span></div>
          <div class="stat-row"><span>Hosts saved</span><span>${tierSaved}</span></div>
          <div class="stat-row"><span>Partition/host</span><span>${tierPart}</span></div>` : ''}
        </div>
      </div>
    </div>`;
  });

  // VM Stack totals
  const totV = t('inventory-totals') || '';

  const now = new Date().toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'});
  const ts  = new Date().toLocaleString();

  const wldEnvMap = {};
  document.querySelectorAll('.wld-card').forEach(card => {
    const id = card.id.split('-')[1];
    const meta = wldMeta[id];
    const col = wldColor(id);
    const env = meta?.envKey ? ENV_TYPES.find(e=>e.key===meta.envKey) : null;
    wldEnvMap[id] = { col, env };
  });

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>VCF 9 Fleet Sizing Report â€” ${now}</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--dark:#0a0f1e;--dark2:#0d1527;--dark3:#111827;--bd:#1e2d45;--t1:#e2e8f0;--t2:#cbd5e1;--t3:#94a3b8;--t4:#64748b;--blue:#3b82f6;--sky:#38bdf8;--em:#10b981;--or:#f97316;--am:#f59e0b;--red:#ef4444;--fm:'Consolas','SF Mono',monospace}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--dark);color:var(--t1);font-size:13px;line-height:1.5;-webkit-print-color-adjust:exact;print-color-adjust:exact}
.page{max-width:980px;margin:0 auto;padding:0 0 48px}

/* â”€â”€ Cover header â”€â”€ */
.cover{background:linear-gradient(135deg,#070d1c 0%,#0f1f45 50%,#0a1830 100%);padding:48px 48px 40px;position:relative;overflow:hidden;border-bottom:3px solid var(--blue)}
.cover::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 70% 50%,rgba(59,130,246,.12),transparent 60%);pointer-events:none}
.cover-brand{font-size:10px;font-weight:700;letter-spacing:.25em;text-transform:uppercase;color:rgba(147,197,253,.4);margin-bottom:14px}
.cover-title{font-size:32px;font-weight:900;letter-spacing:-.03em;line-height:1;color:#fff;margin-bottom:6px}
.cover-title span{color:var(--blue)}
.cover-sub{font-size:12px;color:var(--t3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:28px}
.cover-meta{display:flex;gap:24px;font-size:11px;color:var(--t4)}
.cover-meta strong{color:var(--t2);font-family:var(--fm)}

/* â”€â”€ Section wrapper â”€â”€ */
.section{padding:32px 48px;border-bottom:1px solid var(--bd)}
.section:last-child{border-bottom:none}
.section-title{font-size:11px;font-weight:800;letter-spacing:.18em;text-transform:uppercase;color:var(--t4);margin-bottom:20px;display:flex;align-items:center;gap:10px}
.section-title::before{content:'';display:inline-block;width:3px;height:14px;border-radius:2px;background:var(--blue);flex-shrink:0}

/* â”€â”€ Fleet summary cards â”€â”€ */
.sum-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.sum-card{background:rgba(255,255,255,.03);border:1px solid var(--bd);border-radius:12px;padding:20px 16px;text-align:center;position:relative;overflow:hidden}
.sum-card::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:3px 3px 0 0}
.sum-card.blue::after{background:var(--blue)}.sum-card.sky::after{background:var(--sky)}.sum-card.em::after{background:var(--em)}.sum-card.red::after{background:var(--red)}
.sum-val{font-size:36px;font-weight:900;letter-spacing:-.04em;font-family:var(--fm);line-height:1;margin-bottom:8px}
.sum-val.blue{color:var(--blue)}.sum-val.sky{color:var(--sky)}.sum-val.em{color:var(--em)}.sum-val.red{color:var(--red)}
.sum-lbl{font-size:9px;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:var(--t4)}

/* â”€â”€ Licence strip â”€â”€ */
.lic-strip{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;background:rgba(255,255,255,.02);border:1px solid var(--bd);border-radius:10px;padding:16px}
.lic-item{text-align:center}
.lic-val{font-size:22px;font-weight:900;font-family:var(--fm);color:var(--sky)}
.lic-val.danger{color:var(--red)}
.lic-lbl{font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--t4);margin-top:4px}

/* â”€â”€ Topology strip â”€â”€ */
.topo-strip{display:flex;align-items:center;gap:0;margin:20px 0;overflow-x:auto;padding:4px 0}
.topo-node{display:flex;flex-direction:column;align-items:center;gap:5px;min-width:90px}
.topo-box-r{border-radius:8px;padding:7px 12px;font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;text-align:center;border:2px solid}
.topo-conn{flex:1;height:2px;min-width:24px;max-width:48px;align-self:center;margin-bottom:22px}
.topo-stat-r{font-size:9px;text-align:center;line-height:1.5;color:var(--t4)}
.topo-stat-r strong{color:var(--t1);font-family:var(--fm)}

/* â”€â”€ WLD cards â”€â”€ */
.wld-section{border-radius:10px;border:1px solid var(--bd);overflow:hidden;margin-bottom:16px}
.wld-header{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bd)}
.wld-name{font-size:15px;font-weight:800;letter-spacing:-.01em}
.wld-badges{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.badge-r{display:inline-flex;align-items:center;padding:3px 9px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.08em;border:1px solid;white-space:nowrap}
.wld-body{display:grid;grid-template-columns:repeat(3,1fr);gap:0}
.wld-col{padding:14px 18px;border-right:1px solid var(--bd)}
.wld-col:last-child{border-right:none}
.col-title{font-size:9px;font-weight:800;letter-spacing:.14em;text-transform:uppercase;color:var(--t4);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--bd)}
.stat-r{display:flex;justify-content:space-between;padding:3px 0;font-size:11px}
.sk-r{color:var(--t3)}.sv-r{font-weight:700;font-family:var(--fm);color:var(--t1)}
.sv-r.sky{color:var(--sky)}.sv-r.em{color:var(--em)}.sv-r.am{color:var(--am)}.sv-r.red{color:var(--red)}

/* â”€â”€ Grade circle â”€â”€ */
.grade-circle{width:40px;height:40px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;font-family:var(--fm);border:2px solid;flex-shrink:0}

/* â”€â”€ Management card â”€â”€ */
.mgmt-card{background:rgba(249,115,22,.04);border:1px solid rgba(249,115,22,.2);border-radius:10px;overflow:hidden;margin-bottom:20px}
.mgmt-header{padding:14px 18px;border-bottom:1px solid rgba(249,115,22,.15);display:flex;align-items:center;justify-content:space-between}
.mgmt-title{font-size:14px;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:rgba(253,186,116,.9)}
.mgmt-body{display:grid;grid-template-columns:repeat(4,1fr);gap:0}
.mgmt-col{padding:14px 18px;border-right:1px solid var(--bd)}
.mgmt-col:last-child{border-right:none}

/* â”€â”€ Waterfall bar â”€â”€ */
.wf-wrap{height:14px;border-radius:4px;overflow:hidden;display:flex;margin:6px 0 10px;border:1px solid rgba(255,255,255,.06)}
.wf-vm2{background:rgba(56,189,248,.5)}.wf-sw2{background:rgba(99,102,241,.5)}.wf-pf2{background:rgba(251,191,36,.5)}.wf-fr2{background:rgba(52,211,153,.4)}.wf-gr2{background:rgba(249,115,22,.5)}

/* â”€â”€ Policy box â”€â”€ */
.policy-r{background:rgba(59,130,246,.07);border:1px solid rgba(59,130,246,.25);border-radius:6px;padding:8px 12px;font-size:10px;color:rgba(147,197,253,.8);margin-top:8px;line-height:1.6}
.policy-r strong{color:var(--sky)}

/* â”€â”€ Footer / disclaimer â”€â”€ */
.disclaimer-r{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:8px;padding:12px 16px;font-size:10px;color:rgba(254,202,202,.8);line-height:1.6;margin-top:24px}
.disclaimer-r strong{color:rgba(254,202,202,.95)}
.footer-r{padding:20px 48px;display:flex;justify-content:space-between;font-size:10px;color:var(--t4);border-top:1px solid var(--bd);margin-top:8px}
.footer-r strong{color:var(--t3)}

@media print{
  body{background:#fff!important;color:#111!important}
  .cover{background:#1e3a8a!important;-webkit-print-color-adjust:exact}
  .sum-card,.wld-section,.mgmt-card,.lic-strip{border-color:#e2e8f0!important}
  .sum-val.blue,.lic-val{color:#1d4ed8!important}
  .sum-val.sky{color:#0284c7!important}
  .sum-val.em,.sv-r.em{color:#15803d!important}
  .sum-val.red,.lic-val.danger{color:#dc2626!important}
  .wld-name,.mgmt-title{color:#1e3a8a!important}
  .sk-r{color:#475569!important}.sv-r{color:#0f172a!important}
  .col-title,.section-title,.cover-brand,.cover-meta{color:#64748b!important}
  .policy-r{background:#eff6ff!important;border-color:#bfdbfe!important;color:#1e40af!important}
  .disclaimer-r{background:#fff7ed!important;border-color:#fed7aa!important;color:#92400e!important}
  .footer-r,.section{border-color:#e2e8f0!important}
}
</style>
</head>
<body>

<!-- Cover -->
<div class="cover">
  <div class="cover-brand"><a href="https://vmtechie.blog" target="_blank" style="color:inherit;text-decoration:none">vmtechie.blog</a></div>
  <div class="cover-title">VCF 9 <span>Fleet Sizing</span> Report</div>
  <div class="cover-sub">VMware Cloud Foundation 9 Â· ESA Architecture Â· Independent Planning Aid</div>
  <div class="cover-meta">
    <div>Generated <strong>${ts}</strong></div>
    <div>WLD Count <strong>${wldNum}</strong></div>
    <div>Total Hosts <strong>${fleetHosts}</strong></div>
    <div>Core Licenses <strong>${fleetCores}</strong></div>
  </div>
</div>

<!-- Fleet Summary -->
<div class="section">
  <div class="section-title">Fleet Summary</div>
  <div class="sum-grid">
    <div class="sum-card blue"><div class="sum-val blue">${fleetHosts}</div><div class="sum-lbl">Total Fleet Hosts</div></div>
    <div class="sum-card sky"><div class="sum-val sky">${fleetCores}</div><div class="sum-lbl">Core Licenses</div></div>
    <div class="sum-card em"><div class="sum-val em">${fleetStorage}</div><div class="sum-lbl">${isMgmtExt()||Object.values(wldStorageMode).some(m=>m==="ext")?"Fleet Storage (TiB)*":"vSAN Raw (TiB)"}</div></div>
    <div class="sum-card ${parseFloat(licAddon)>0?'red':'em'}"><div class="sum-val ${parseFloat(licAddon)>0?'red':'em'}">${licAddon}</div><div class="sum-lbl">Add-on TiB Needed</div></div>
  </div>
  <div class="lic-strip">
    <div class="lic-item"><div class="lic-val">${licMgmt}</div><div class="lic-lbl">Mgmt Cores</div></div>
    <div class="lic-item"><div class="lic-val">${licWld}</div><div class="lic-lbl">WLD Cores</div></div>
    <div class="lic-item"><div class="lic-val">${licEnt}</div><div class="lic-lbl">Entitlement (TiB)</div></div>
    <div class="lic-item"><div class="lic-val ${parseFloat(licAddon)>0?'danger':''}">${licAddon}</div><div class="lic-lbl">Add-on Required (TiB)</div></div>
  </div>
  ${(()=>{
    const extRows = [];
    if (isMgmtExt()) extRows.push({name:'âš™ Management Domain', cores:parseInt(licMgmt)||0});
    document.querySelectorAll('.wld-card').forEach(card => {
      const xid = card.id.split('-')[1];
      if (isExtStorage(xid)) {
        const xname = document.getElementById('w-name-'+xid)?.value || 'WLD '+xid;
        const xcores = parseInt(document.getElementById('w-cores-'+xid)?.innerText)||0;
        extRows.push({name:xname, cores:xcores});
      }
    });
    if (!extRows.length) return '';
    const totalForfeited = extRows.reduce((a,r)=>a+r.cores,0);
    return '<div style="background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:14px 18px;margin-top:16px">'
      +'<div style="font-size:11px;font-weight:800;color:#fcd34d;margin-bottom:8px;letter-spacing:.04em">âš  External Storage â€” Entitlement Impact</div>'
      +'<div style="font-size:10px;color:rgba(253,230,138,.7);margin-bottom:10px;line-height:1.6">VCF licenses include <strong style=color:#fcd34d>1 TiB vSAN raw storage per licensed core</strong>. The following domains use external storage and do not utilise this entitlement. Budget for external array acquisition, licensing and support separately.</div>'
      +extRows.map(r=>'<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(245,158,11,.1);font-size:11px"><span style=color:rgba(253,230,138,.7)>'+r.name+'</span><span style="font-family:monospace;color:#fcd34d">'+r.cores+' cores â†’ '+r.cores+' TiB forfeited</span></div>').join('')
      +'<div style="display:flex;justify-content:space-between;padding:8px 0 0;font-weight:800;font-size:12px;color:#fcd34d"><span>Total forfeited entitlement</span><span style=font-family:monospace>'+totalForfeited+' TiB</span></div>'
      +'</div>';
  })()}
</div>

<!-- Fleet Topology -->
<div class="section">
  <div class="section-title">Fleet Topology</div>
  <div class="topo-strip">
    <div class="topo-node">
      <div class="topo-box-r" style="border-color:${isMgmtExt()?'rgba(168,85,247,.5)':'rgba(249,115,22,.5)'};background:${isMgmtExt()?'rgba(168,85,247,.1)':'rgba(249,115,22,.1)'};color:${isMgmtExt()?'#c084fc':'#fb923c'}">${isMgmtExt()?'ðŸ”Œ':'âš™'} Management</div>
      <div class="topo-stat-r"><strong>${mHosts}</strong> hosts Â· <strong>${mCores}</strong> cores<br>${isMgmtExt()?'ðŸ”Œ External Array':'<strong>'+mRaw+'</strong> TiB raw'}</div>
    </div>
    ${Array.from(document.querySelectorAll('.wld-card')).map(card => {
      const id = card.id.split('-')[1];
      const wName = document.getElementById(`w-name-${id}`)?.value || `WLD ${id}`;
      const wHosts = document.getElementById(`w-hosts-${id}`)?.innerText || '--';
      const wCores = document.getElementById(`w-cores-${id}`)?.innerText || '--';
      const wRaw   = document.getElementById(`w-raw-${id}`)?.innerText   || '--';
      const wUtil  = document.getElementById(`w-util-pct-${id}`)?.innerText || '--';
      const em2    = wldEnvMap[id];
      const wCol   = em2?.col?.hex || '#3b82f6';
      const wEnv   = em2?.env;
      const rIsExt = isExtStorage(id);
      const rTCol = rIsExt ? '#a855f7' : wCol;
      return `<div style="flex:1;height:2px;background:linear-gradient(90deg,rgba(249,115,22,.3),${rTCol}40);min-width:20px;max-width:44px;align-self:center;margin-bottom:22px"></div>
      <div class="topo-node">
        <div class="topo-box-r" style="border-color:${rTCol}80;background:${rTCol}18;color:${rTCol}">${rIsExt?'ðŸ”Œ':(wEnv?wEnv.icon:'ðŸ’¾')} ${wName}</div>
        <div class="topo-stat-r"><strong>${wHosts}</strong> hosts Â· <strong>${wCores}</strong> cores<br>${rIsExt?'ðŸ”Œ External Array':'<strong>'+wUtil+'</strong> util'}</div>
      </div>`;
    }).join('')}
  </div>
</div>

<!-- Management Domain -->
<div class="section">
  <div class="section-title" style="--blue:rgba(249,115,22,.8)">Management Domain</div>
  <div class="mgmt-card">
    <div class="mgmt-header">
      <div class="mgmt-title">âš™ Management Domain</div>
      <div style="display:flex;gap:10px;font-size:11px">
        <span style="color:rgba(253,186,116,.7)">Limiter: <strong style="color:#fb923c">${mLimiter}</strong></span>
        <span style="color:rgba(253,186,116,.7)">PF: <strong style="color:#fb923c">${mPf}Ã—</strong></span>
      </div>
    </div>
    <div class="mgmt-body">
      <div class="mgmt-col">
        <div class="col-title">Result</div>
        <div class="stat-r"><span class="sk-r">Final Hosts</span><span class="sv-r" style="color:#fb923c;font-size:18px">${mHosts}</span></div>
        <div class="stat-r"><span class="sk-r">Core Licenses</span><span class="sv-r sky">${mCores}</span></div>
        <div class="stat-r"><span class="sk-r">Raw TiB</span><span class="sv-r em">${mRaw}</span></div>
        <div class="stat-r"><span class="sk-r">Limiter</span><span class="sv-r">${mLimiter}</span></div>
      </div>
      <div class="mgmt-col">
        <div class="col-title">Compute Demand</div>
        <div class="stat-r"><span class="sk-r">vCPU demand</span><span class="sv-r sky">${mDemV}</span></div>
        <div class="stat-r"><span class="sk-r">RAM demand (GB)</span><span class="sv-r sky">${mDemR}</span></div>
      </div>
      ${isMgmtExt() ? `
      <div class="mgmt-col" style="grid-column:span 2">
        <div class="col-title">External Storage</div>
        <div style="background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.3);border-radius:6px;padding:10px 12px;margin-bottom:8px">
          <div style="font-size:11px;font-weight:800;color:#c084fc;margin-bottom:6px">ðŸ”Œ External Array</div>
          <div class="stat-r"><span class="sk-r">Vendor</span><span class="sv-r" style="color:#c084fc">${document.getElementById('m-ext-vendor')?.value||'External Array'}</span></div>
          <div class="stat-r"><span class="sk-r">Est. Capacity</span><span class="sv-r" style="color:#fff">${document.getElementById('m-ext-tib')?.value||'--'} TiB</span></div>
          <div class="stat-r"><span class="sk-r">Host Limiter</span><span class="sv-r">Compute only</span></div>
        </div>
        <div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.25);border-radius:6px;padding:8px 12px;font-size:10px;color:rgba(253,230,138,.8);line-height:1.5">
          âš  <strong style="color:#fcd34d">Entitlement forfeited:</strong> ${mCores} cores = <strong style="color:#fcd34d">${mCores} TiB</strong> vSAN entitlement unused â€” budget for external array costs separately
        </div>
      </div>` : `
      ${isMgmtExt() ? `
      <div class="mgmt-col" style="grid-column:span 2">
        <div class="col-title">External Storage</div>
        <div style="background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.3);border-radius:6px;padding:10px 12px;margin-bottom:8px">
          <div style="font-size:11px;font-weight:800;color:#c084fc;margin-bottom:6px">ðŸ”Œ External Array</div>
          <div class="stat-r"><span class="sk-r">Vendor</span><span class="sv-r" style="color:#c084fc">${document.getElementById('m-ext-vendor')?.value||'External Array'}</span></div>
          <div class="stat-r"><span class="sk-r">Est. Capacity</span><span class="sv-r" style="color:#fff">${document.getElementById('m-ext-tib')?.value||'--'} TiB</span></div>
          <div class="stat-r"><span class="sk-r">Host Limiter</span><span class="sv-r">Compute only</span></div>
        </div>
        <div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.25);border-radius:6px;padding:8px 12px;font-size:10px;color:rgba(253,230,138,.8);line-height:1.5">
          âš  <strong style="color:#fcd34d">Entitlement forfeited:</strong> ${mCores} cores = <strong style="color:#fcd34d">${mCores} TiB</strong> vSAN entitlement unused
        </div>
      </div>` : `
      <div class="mgmt-col">
        <div class="col-title">ESA Storage</div>
        <div class="stat-r"><span class="sk-r">PF</span><span class="sv-r am">${mPf}Ã—</span></div>
        <div class="stat-r"><span class="sk-r">Protected (GB)</span><span class="sv-r em">${mProt}</span></div>
      </div>
      <div class="mgmt-col">
        <div class="col-title">vSAN Policy</div>
        <div style="font-size:10px;color:rgba(147,197,253,.7);line-height:1.6">${mPolicy.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim()}</div>
      </div>`}`}
    </div>
  </div>
</div>

<!-- Workload Domains -->
<div class="section">
  <div class="section-title">Workload Domains</div>
  ${Array.from(document.querySelectorAll('.wld-card')).map(card => {
    const id   = card.id.split('-')[1];
    const em2  = wldEnvMap[id];
    const wCol = em2?.col?.hex  || '#3b82f6';
    const wRgb = em2?.col?.rgb  || '59,130,246';
    const wEnv = em2?.env;
    const wName    = document.getElementById(`w-name-${id}`)?.value || `WLD ${id}`;
    const wHosts   = document.getElementById(`w-hosts-${id}`)?.innerText   || '--';
    const wLim     = document.getElementById(`w-limiter-${id}`)?.innerText || '--';
    const wCores   = document.getElementById(`w-cores-${id}`)?.innerText   || '--';
    const wRaw     = document.getElementById(`w-raw-${id}`)?.innerText     || '--';
    const wUtil    = document.getElementById(`w-util-pct-${id}`)?.innerText|| '--';
    const wHealth  = document.getElementById(`w-health-${id}`)?.innerText  || '--';
    const wGrade   = document.getElementById(`w-eff-grade-${id}`)?.innerText|| '--';
    const wScore   = document.getElementById(`w-eff-score-${id}`)?.innerText|| '--';
    const wReason  = document.getElementById(`w-eff-reason-${id}`)?.innerText|| '--';
    const wDemV    = document.getElementById(`w-dem-v-${id}`)?.innerText   || '--';
    const wDemR    = document.getElementById(`w-dem-r-${id}`)?.innerText   || '--';
    const wDemD    = document.getElementById(`w-dem-d-${id}`)?.innerText   || '--';
    const wDemRE   = document.getElementById(`w-dem-r-eff-${id}`)?.innerText|| '--';
    const wEsaVm   = document.getElementById(`w-esa-vmcap-${id}`)?.innerText || '--';
    const wEsaProt = document.getElementById(`w-esa-prot-${id}`)?.innerText  || '--';
    const wPerH    = document.getElementById(`w-esa-perhost-${id}`)?.innerText|| '--';
    const wRawPH   = document.getElementById(`w-raw-perhost-${id}`)?.innerText|| '--';
    const wPolicyMin = document.getElementById(`w-policy-min-${id}`)?.innerText|| '--';
    const wPolicy  = document.getElementById(`w-policy-info-${id}`)?.innerHTML|| '';
    const tierOn   = document.getElementById(`w-tier-on-${id}`)?.checked;
    const tierEffRam = document.getElementById(`w-tier-effram-${id}`)?.innerText||'--';
    const tierSaved  = document.getElementById(`ws-tier-saved-${id}`)?.innerText||'--';
    const tierPart   = document.getElementById(`w-tier-part-${id}`)?.innerText||'--';
    const wVmCap2  = parseFloat(document.getElementById(`w-esa-vmcap-${id}`)?.innerText)||1;
    const wProt2   = parseFloat(document.getElementById(`w-esa-prot-${id}`)?.innerText)||1;
    const total2   = wProt2*1.4||1;
    const gradeColors = {A:'#16a34a',B:'#22c55e',C:'#ca8a04',D:'#ea580c',F:'#dc2626'};
    const gc = gradeColors[wGrade] || '#94a3b8';
    const utilPct = parseFloat(wUtil)||0;
    const utilCol = utilPct>=95?'#ef4444':utilPct>=88?'#f59e0b':'#10b981';
    const wIsExt   = isExtStorage(id);
    const wExtVendor = document.getElementById(`w-ext-vendor-${id}`)?.value?.trim() || 'External Array';
    const wExtTib    = document.getElementById(`w-ext-tib-${id}`)?.value?.trim()    || '--';
    const wEntForfeited = wIsExt ? parseInt(wCores)||0 : 0;
    return `
    <div class="wld-section" style="border-color:${wCol}40;border-left:4px solid ${wCol}">
      <div class="wld-header" style="background:rgba(${wRgb},.05);border-bottom-color:${wCol}25">
        <div class="wld-name" style="color:${wCol}">${wEnv?wEnv.icon+' ':''} ${wName}</div>
        <div class="wld-badges">
          <div class="badge-r" style="border-color:${wCol}50;background:${wCol}15;color:${wCol}">${wEnv?wEnv.label:'Workload'}</div>
          ${wIsExt
            ? `<div class="badge-r" style="border-color:#a855f780;background:rgba(168,85,247,.12);color:#c084fc">ðŸ”Œ External Array</div>`
            : `<div class="badge-r" style="border-color:${utilCol}50;background:${utilCol}18;color:${utilCol}">âš¡ ${wUtil} util</div>
          <div class="grade-circle" style="border-color:${gc}60;background:${gc}18;color:${gc}">${wGrade}</div>`}
        </div>
      </div>
      <div class="wld-body">
        <div class="wld-col">
          <div class="col-title">Result</div>
          <div class="stat-r"><span class="sk-r">Final Hosts</span><span class="sv-r" style="color:${wCol};font-size:18px;font-weight:900">${wHosts}</span></div>
          <div class="stat-r"><span class="sk-r">Limiter</span><span class="sv-r">${wLim}</span></div>
          <div class="stat-r"><span class="sk-r">Policy Min</span><span class="sv-r">${wPolicyMin}</span></div>
          <div class="stat-r"><span class="sk-r">Core Licenses</span><span class="sv-r sky">${wCores}</span></div>
          <div class="stat-r"><span class="sk-r">${wIsExt?'Est. Storage':'Raw TiB'}</span><span class="sv-r em">${wIsExt?wExtTib+' TiB':wRaw+' TiB'}</span></div>
          <div class="stat-r"><span class="sk-r">Health</span><span class="sv-r" style="color:${utilCol}">${wHealth}</span></div>
          ${tierOn?`<div class="stat-r" style="margin-top:6px"><span class="sk-r">âš¡ NVMe Tier</span><span class="sv-r sky">Active</span></div>
          <div class="stat-r"><span class="sk-r">Eff.RAM/host</span><span class="sv-r">${tierEffRam}</span></div>
          <div class="stat-r"><span class="sk-r">Hosts saved</span><span class="sv-r em">${tierSaved}</span></div>`:''}
        </div>
        <div class="wld-col">
          <div class="col-title">Demand</div>
          <div class="stat-r"><span class="sk-r">vCPU</span><span class="sv-r sky">${wDemV}</span></div>
          <div class="stat-r"><span class="sk-r">RAM (GB)</span><span class="sv-r sky">${wDemR}</span></div>
          <div class="stat-r"><span class="sk-r">Eff. RAM (GB)</span><span class="sv-r am">${wDemRE}</span></div>
          <div class="stat-r"><span class="sk-r">Disk (GB)</span><span class="sv-r em">${wDemD}</span></div>
          <div class="col-title" style="margin-top:12px">Efficiency</div>
          <div class="stat-r"><span class="sk-r">Score</span><span class="sv-r" style="color:${gc}">${wScore}</span></div>
          <div style="font-size:10px;color:${gc};margin-top:3px;line-height:1.4">${wReason}</div>
        </div>
        <div class="wld-col">
          ${wIsExt ? `
          <div class="col-title">External Storage</div>
          <div style="background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.3);border-radius:6px;padding:10px 12px;margin-bottom:8px">
            <div style="font-size:11px;font-weight:800;color:#c084fc;margin-bottom:6px">ðŸ”Œ External Array</div>
            <div class="stat-r"><span class="sk-r">Vendor</span><span class="sv-r" style="color:#c084fc">${wExtVendor}</span></div>
            <div class="stat-r"><span class="sk-r">Est. Capacity</span><span class="sv-r" style="color:#fff">${wExtTib} TiB</span></div>
            <div class="stat-r"><span class="sk-r">Host Limiter</span><span class="sv-r">Compute only</span></div>
          </div>
          <div style="background:rgba(245,158,11,.07);border:1px solid rgba(245,158,11,.25);border-radius:6px;padding:8px 12px;font-size:10px;color:rgba(253,230,138,.8);line-height:1.5">
            âš  <strong style="color:#fcd34d">Entitlement forfeited:</strong> ${wEntForfeited} cores = <strong style="color:#fcd34d">${wEntForfeited} TiB</strong> vSAN entitlement unused
          </div>` : `
          <div class="col-title">ESA Storage</div>
          <div class="wf-wrap">
            <div class="wf-vm2" style="width:${Math.max(2,(wVmCap2/total2*100)).toFixed(0)}%"></div>
            <div class="wf-pf2" style="width:${Math.max(2,((wProt2-wVmCap2)/total2*100)).toFixed(0)}%"></div>
            <div class="wf-fr2" style="flex:1"></div>
          </div>
          <div class="stat-r"><span class="sk-r">VM Capacity (GB)</span><span class="sv-r sky">${wEsaVm}</span></div>
          <div class="stat-r"><span class="sk-r">Protected (GB)</span><span class="sv-r em">${wEsaProt}</span></div>
          <div class="stat-r"><span class="sk-r">Per Host (GB)</span><span class="sv-r am">${wPerH}</span></div>
          <div class="stat-r"><span class="sk-r">Raw/Host (GB)</span><span class="sv-r">${wRawPH}</span></div>
          <div class="policy-r">${wPolicy.replace(/<strong[^>]*>/g,'<strong>').replace(/<\/strong>/g,'</strong>')}</div>`}
        </div>
      </div>
    </div>`;
  }).join('')}
</div>

<div class="section">
  <div class="disclaimer-r">
    <strong>âš  Independent Planning Aid Only</strong> â€” Not an official Broadcom/VMware tool. All figures are estimates based on the inputs provided. Validate all designs against official Broadcom documentation, VMware Compatibility Guide (HCL), and field engineering guidance before procurement or deployment.
  </div>
</div>

<div class="footer-r">
  <span><strong>VCF 9 Fleet Sizer</strong> Â· <a href="https://vmtechie.blog" target="_blank" style="color:var(--t3);text-decoration:none">vmtechie.blog</a></span>
  <span><a href="https://vmtechie.blog/2026/03/01/how-the-vcf-9-fleet-sizer-actually-works/" target="_blank" style="color:var(--t3);text-decoration:none">How this sizer works â†’</a> &nbsp;Â·&nbsp; Generated ${ts} Â· v28</span>
</div>

</body>
</html>`;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 600);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLEET HEALTH BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateHealthBanner(mgmt, wldResultsArr, fleetHosts) {
  const banner  = document.getElementById('fleet-health-banner');
  const msgEl   = document.getElementById('fh-message');
  const statsEl = document.getElementById('fh-stats');
  if (!banner) return;

  let critCount = 0, warnCount = 0;
  wldResultsArr.forEach(w => {
    if (w.extMode) return; // ext storage domains: skip util warning (no storage pressure metric)
    const u = w.util;
    if (u >= 0.95) critCount++;
    else if (u >= 0.88) warnCount++;
  });

  const wldCount2 = wldResultsArr.length;
  const totalHosts = fleetHosts;

  let cls, icon, msg;
  if (critCount > 0) {
    cls = 'crit'; icon = 'âš ';
    msg = `${critCount} WLD${critCount>1?'s':''} critically over-utilised â€” reduce load or add hosts`;
  } else if (warnCount > 0) {
    cls = 'warn'; icon = 'âš¡';
    msg = `${warnCount} WLD${warnCount>1?'s':''} approaching capacity â€” consider adding headroom`;
  } else {
    cls = 'ok'; icon = 'âœ“';
    msg = 'Fleet looks healthy â€” all domains within comfortable utilisation';
  }

  banner.className = `fleet-health ${cls}`;
  if (msgEl) msgEl.innerHTML = `<strong>${icon}</strong> ${msg}`;
  if (statsEl) statsEl.innerHTML =
    `${wldCount2} WLD${wldCount2!==1?'s':''} &nbsp;Â·&nbsp; ` +
    `<span>${totalHosts}</span> total hosts &nbsp;Â·&nbsp; ` +
    `<span style="color:${critCount>0?'var(--red2)':warnCount>0?'var(--am2)':'var(--em2)'}">` +
    `${critCount} critical Â· ${warnCount} warning</span>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOST DELTA INDICATOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const _prevHostCounts = {};
function showDelta(containerId, newVal, label) {
  const prev = _prevHostCounts[containerId];
  _prevHostCounts[containerId] = newVal;
  if (prev == null || prev === newVal) return;
  const diff = newVal - prev;
  const wrap = document.getElementById(containerId)?.closest('.host-count-wrap');
  if (!wrap) return;
  // Remove any existing badge
  wrap.querySelectorAll('.delta-badge').forEach(b => b.remove());
  const badge = document.createElement('div');
  badge.className = `delta-badge ${diff > 0 ? 'up' : 'down'}`;
  badge.innerText = (diff > 0 ? 'â†‘ +' : 'â†“ ') + diff + (label||'');
  wrap.appendChild(badge);
  setTimeout(() => badge.remove(), 1900);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COPY TO CLIPBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function copyVal(el) {
  if (!el) return;
  const txt = el.innerText.trim();
  navigator.clipboard?.writeText(txt).catch(() => {});
  el.classList.add('copy-flash');
  const orig = el.getAttribute('data-orig-title') || el.title;
  el.title = 'âœ“ Copied!';
  setTimeout(() => { el.classList.remove('copy-flash'); el.title = orig; }, 1200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE VISIBILITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function syncEmptyState() {
  const empty = document.getElementById('wld-empty-state');
  if (!empty) return;
  const hasWlds = document.querySelectorAll('.wld-card').length > 0;
  empty.style.display = hasWlds ? 'none' : '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DUPLICATE WLD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function duplicateWLD(srcId) {
  // Collect all values from source WLD
  const gv = id => document.getElementById(id)?.value;
  const gc = id => document.getElementById(id)?.checked;

  const snapshot = {
    name:        (gv(`w-name-${srcId}`) || `WLD ${srcId}`) + ' (copy)',
    cpuQty:      gv(`w-cpuQty-${srcId}`),
    coresPerCpu: gv(`w-coresPerCpu-${srcId}`),
    ram:         gv(`w-ram-${srcId}`),
    nvmeQty:     gv(`w-nvme-qty-${srcId}`),
    nvmeSize:    gv(`w-nvme-size-${srcId}`),
    vms:         gv(`w-vms-${srcId}`),
    vcpuVm:      gv(`w-vcpu-vm-${srcId}`),
    ramVm:       gv(`w-ram-vm-${srcId}`),
    diskVm:      gv(`w-disk-vm-${srcId}`),
    growth:      gv(`w-growth-${srcId}`),
    cpuSub:      gv(`w-cpu-sub-${srcId}`),
    ramSub:      gv(`w-ram-sub-${srcId}`),
    reserve:     gv(`w-reserve-${srcId}`),
    raid:        gv(`w-raid-${srcId}`),
    ftt:         gv(`w-ftt-${srcId}`),
    r5stripe:    gv(`w-r5stripe-${srcId}`),
    free:        gv(`w-free-${srcId}`),
    dedupe:      gv(`w-dedupe-${srcId}`),
    comp:        gv(`w-comp-${srcId}`),
    swapPct:     gv(`w-swapPct-${srcId}`),
    fail:        gv(`w-fail-${srcId}`),
    supInc:      gc(`w-sup-inc-${srcId}`),
    supNodes:    gv(`w-sup-nodes-${srcId}`),
    supSize:     gv(`w-sup-size-${srcId}`),
    edgeInc:     gc(`w-edge-inc-${srcId}`),
    edgeNodes:   gv(`w-edge-nodes-${srcId}`),
    edgeSize:    gv(`w-edge-size-${srcId}`),
    c1Inc:       gc(`w-c1-inc-${srcId}`),
    c1Nodes:     gv(`w-c1-nodes-${srcId}`),
    c1Size:      gv(`w-c1-size-${srcId}`),
    c2Inc:       gc(`w-c2-inc-${srcId}`),
    c2Nodes:     gv(`w-c2-nodes-${srcId}`),
    c2Size:      gv(`w-c2-size-${srcId}`),
    tierOn:      gc(`w-tier-on-${srcId}`),
    tierElig:    gv(`w-tier-elig-${srcId}`),
    tierActive:  gv(`w-tier-active-${srcId}`),
    tierRatio:   gv(`w-tier-ratio-${srcId}`),
    tierNvmeSize:gv(`w-tier-nvme-size-${srcId}`),
    tierRedund:  gv(`w-tier-redund-${srcId}`),
    srcMeta:     wldMeta[srcId] ? {...wldMeta[srcId]} : null,
    storageMode: wldStorageMode[srcId] || 'vsan',
    extVendor:   gv(`w-ext-vendor-${srcId}`),
    extTib:      gv(`w-ext-tib-${srcId}`),
  };

  addWLD();
  const newId = wldCount;
  const sv = (id, v) => { const el=document.getElementById(id); if(el&&v!=null) el.value=v; };
  const cb = (id, v) => { const el=document.getElementById(id); if(el) el.checked=!!v; };

  sv(`w-name-${newId}`,        snapshot.name);
  sv(`w-cpuQty-${newId}`,      snapshot.cpuQty);
  sv(`w-coresPerCpu-${newId}`, snapshot.coresPerCpu);
  sv(`w-ram-${newId}`,         snapshot.ram);
  sv(`w-nvme-qty-${newId}`,    snapshot.nvmeQty);
  sv(`w-nvme-size-${newId}`,   snapshot.nvmeSize);
  sv(`w-vms-${newId}`,         snapshot.vms);
  sv(`w-vcpu-vm-${newId}`,     snapshot.vcpuVm);
  sv(`w-ram-vm-${newId}`,      snapshot.ramVm);
  sv(`w-disk-vm-${newId}`,     snapshot.diskVm);
  sv(`w-growth-${newId}`,      snapshot.growth);
  sv(`w-cpu-sub-${newId}`,     snapshot.cpuSub);
  sv(`w-ram-sub-${newId}`,     snapshot.ramSub);
  sv(`w-reserve-${newId}`,     snapshot.reserve);
  sv(`w-raid-${newId}`,        snapshot.raid);
  sv(`w-ftt-${newId}`,         snapshot.ftt);
  sv(`w-r5stripe-${newId}`,    snapshot.r5stripe);
  sv(`w-free-${newId}`,        snapshot.free);
  sv(`w-dedupe-${newId}`,      snapshot.dedupe);
  sv(`w-comp-${newId}`,        snapshot.comp);
  sv(`w-swapPct-${newId}`,     snapshot.swapPct);
  sv(`w-fail-${newId}`,        snapshot.fail);
  cb(`w-sup-inc-${newId}`,  snapshot.supInc);  sv(`w-sup-nodes-${newId}`,snapshot.supNodes); sv(`w-sup-size-${newId}`,snapshot.supSize);
  cb(`w-edge-inc-${newId}`, snapshot.edgeInc); sv(`w-edge-nodes-${newId}`,snapshot.edgeNodes); sv(`w-edge-size-${newId}`,snapshot.edgeSize);
  cb(`w-c1-inc-${newId}`,   snapshot.c1Inc);   sv(`w-c1-nodes-${newId}`,snapshot.c1Nodes); sv(`w-c1-size-${newId}`,snapshot.c1Size);
  cb(`w-c2-inc-${newId}`,   snapshot.c2Inc);   sv(`w-c2-nodes-${newId}`,snapshot.c2Nodes); sv(`w-c2-size-${newId}`,snapshot.c2Size);

  const tierEl = document.getElementById(`w-tier-on-${newId}`);
  if (tierEl) { tierEl.checked = snapshot.tierOn; toggleTierPanel(newId); }
  sv(`w-tier-elig-${newId}`,     snapshot.tierElig);
  sv(`w-tier-active-${newId}`,   snapshot.tierActive);
  sv(`w-tier-ratio-${newId}`,    snapshot.tierRatio);
  sv(`w-tier-nvme-size-${newId}`,snapshot.tierNvmeSize);
  sv(`w-tier-redund-${newId}`,   snapshot.tierRedund);

  // Copy env identity
  if (snapshot.srcMeta) {
    wldMeta[newId] = { ...snapshot.srcMeta };
    applyWldTheme(newId);
  }

  sv(`w-ext-vendor-${newId}`, snapshot.extVendor);
  sv(`w-ext-tib-${newId}`,    snapshot.extTib);
  wldStorageMode[newId] = snapshot.storageMode || 'vsan';
  applyStorageModeUI(newId);
  syncRaidFttOptions('w', newId);
  syncEmptyState();
  recalculate();

  // Scroll to new card
  setTimeout(() => {
    const card = document.getElementById(`wld-${newId}`);
    if (card) card.scrollIntoView({ behavior:'smooth', block:'start' });
  }, 100);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD SHORTCUT: Ctrl+Shift+W = Add WLD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'W') {
    e.preventDefault();
    addWLD();
  }
});


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXTERNAL STORAGE ENTITLEMENT WARNING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateExtEntitlementWarn(mgmt, wldResultsArr) {
  const warnEl     = document.getElementById('lic-ext-warn');
  const breakdownEl= document.getElementById('lic-ext-breakdown');
  const totalEl    = document.getElementById('lic-ext-total');
  if (!warnEl) return;

  const rows = [];
  let totalForfeited = 0;

  // Management domain
  if (isMgmtExt()) {
    const cores = mgmt.mgmtCores;
    const tib   = cores; // 1 TiB per core
    totalForfeited += tib;
    // Update inline warning in ext box
    const cd = document.getElementById('m-ext-cores-display');
    const ed = document.getElementById('m-ext-ent-display');
    if (cd) cd.innerText = cores;
    if (ed) ed.innerText = tib + ' TiB';
    rows.push({ name: 'âš™ Management Domain', cores, tib });
  }

  // WLD domains
  wldResultsArr.forEach(w => {
    if (isExtStorage(w.id)) {
      const cores = w.wCores;
      const tib   = cores;
      totalForfeited += tib;
      // Update inline warning in WLD ext box
      const cd = document.getElementById(`w-ext-cores-display-${w.id}`);
      const ed = document.getElementById(`w-ext-ent-display-${w.id}`);
      if (cd) cd.innerText = cores;
      if (ed) ed.innerText = tib + ' TiB';
      const name = document.getElementById(`w-name-${w.id}`)?.value || `WLD ${w.id}`;
      rows.push({ name, cores, tib });
    }
  });

  if (rows.length === 0) {
    warnEl.style.display = 'none';
    return;
  }

  warnEl.style.display = '';

  // Breakdown table
  if (breakdownEl) {
    breakdownEl.innerHTML = rows.map(r =>
      `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(245,158,11,.1);font-size:10px">
        <span style="color:rgba(253,230,138,.7)">${r.name}</span>
        <span style="font-family:var(--fm);color:#fcd34d">${r.cores} cores â†’ ${r.tib} TiB forfeited</span>
      </div>`
    ).join('');
  }

  if (totalEl) totalEl.innerText = totalForfeited + ' TiB';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  Object.keys(wldMeta).forEach(k => delete wldMeta[k]);
  syncRaidFttOptions('m');
  renderInventory();
  const restored = loadState();
  if (!restored) addWLD();
  applyMgmtStorageModeUI();
  syncRaidFttOptions('m');
  syncEmptyState();
  recalculate();
}
window.addEventListener('load', init);
</script>
</body>
</html>
